<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>{{ title }} - –î–æ—Å—Ç—É–ø–Ω—ã–µ —Å–ª–æ—Ç—ã</title>
    
    <!-- –ü–æ–¥–∫–ª—é—á–∞–µ–º —Å—Ç–∏–ª–∏ –ö–∞–ª–µ–Ω–¥–∞—à–∏ -->
    <link rel="stylesheet" href="{{ url_for('static', filename='style.css') }}">
    
    <style>
        /* –°–ü–ï–¶–ò–ê–õ–¨–ù–´–ï –°–¢–ò–õ–ò –î–õ–Ø –°–¢–†–ê–ù–ò–¶–´ –°–ö–†–ò–ù–®–û–¢–ê */
        body {
            margin: 0;
            padding: 20px;
            max-width: 100vw; /* –ù–∞ –≤—Å—é —à–∏—Ä–∏–Ω—É —ç–∫—Ä–∞–Ω–∞ */
            background: var(--bg-primary);
        }
        
        .screenshot-container {
            max-width: 95vw; /* –ò—Å–ø–æ–ª—å–∑—É–µ–º –ø–æ—á—Ç–∏ –≤—Å—é —à–∏—Ä–∏–Ω—É */
            margin: 0 auto;
            background: var(--bg-secondary);
            backdrop-filter: blur(10px);
            border-radius: 20px;
            padding: 30px;
            box-shadow: 0 8px 32px rgba(0, 0, 0, 0.1);
            border: 1px solid var(--border-primary);
        }
        
        .screenshot-header {
            text-align: center;
            margin-bottom: 30px;
            padding-bottom: 20px;
            border-bottom: 2px solid var(--border-primary);
        }
        
        .screenshot-title {
            font-size: 2.5rem;
            font-weight: 700;
            margin-bottom: 10px;
            background: var(--accent-gradient);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
        }
        
        .screenshot-subtitle {
            font-size: 1.2rem;
            color: var(--text-muted);
            margin-bottom: 5px;
        }
        
        .screenshot-timezone {
            font-size: 1rem;
            color: var(--text-accent);
            font-weight: 600;
            background: var(--bg-card);
            padding: 8px 16px;
            border-radius: 20px;
            display: inline-block;
            border: 1px solid var(--border-secondary);
        }
        
        /* –ù–ï–î–ï–õ–¨–ù–ê–Ø –°–ï–¢–ö–ê –î–õ–Ø –°–ö–†–ò–ù–®–û–¢–ê */
        .screenshot-week-grid {
            display: grid;
            grid-template-columns: repeat(7, 1fr);
            gap: 15px;
            margin-top: 20px;
        }
        
        .screenshot-day-header {
            background: var(--accent-gradient);
            color: white;
            padding: 15px 10px;
            border-radius: 12px;
            text-align: center;
            font-weight: bold;
            box-shadow: 0 4px 15px rgba(0, 212, 255, 0.3);
        }
        
        .screenshot-day-column {
            background: var(--bg-card);
            backdrop-filter: blur(10px);
            border-radius: 12px;
            padding: 15px;
            min-height: 300px;
            border: 1px solid var(--border-secondary);
        }
        
        .screenshot-slot {
            padding: 12px;
            border-radius: 8px;
            margin-bottom: 10px;
            border-left: 4px solid;
            backdrop-filter: blur(5px);
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.1);
        }
        
        .screenshot-slot.free {
            background: linear-gradient(135deg, rgba(16, 185, 129, 0.2), rgba(6, 95, 70, 0.2));
            border-left-color: #10b981;
            color: var(--text-primary);
        }
        
        .screenshot-slot.occupied {
            background: linear-gradient(135deg, rgba(0, 212, 255, 0.2), rgba(30, 58, 138, 0.2));
            border-left-color: #00d4ff;
            color: var(--text-primary);
        }
        
        .screenshot-slot-time {
            background: var(--accent-gradient);
            color: white;
            padding: 6px 10px;
            border-radius: 6px;
            font-size: 14px;
            font-weight: bold;
            margin-bottom: 8px;
            display: inline-block;
            min-width: 60px;
            text-align: center;
        }
        
        .screenshot-slot-status {
            font-weight: bold;
            font-size: 13px;
        }
        
        .screenshot-slot-subject {
            font-size: 12px;
            margin-top: 4px;
            font-style: italic;
        }
        
        /* –ê–î–ê–ü–¢–ò–í–ù–û–°–¢–¨ */
        @media (max-width: 1200px) {
            .screenshot-week-grid {
                grid-template-columns: repeat(4, 1fr);
            }
        }
        
        @media (max-width: 768px) {
            .screenshot-week-grid {
                grid-template-columns: repeat(2, 1fr);
            }
            
            .screenshot-title {
                font-size: 2rem;
            }
        }
    </style>
</head>
<body>
    <div class="screenshot-container">
        
        <!-- –ó–ê–ì–û–õ–û–í–û–ö -->
        <div class="screenshot-header">
            <h1 class="screenshot-title">{{ title }}</h1>
            <div class="screenshot-subtitle">{{ week_info }}</div>
            <div class="screenshot-timezone">–ß–∞—Å–æ–≤–æ–π –ø–æ—è—Å: {{ timezone }}</div>
        </div>
        
        <!-- –ù–ï–î–ï–õ–¨–ù–ê–Ø –°–ï–¢–ö–ê -->
        <div id="slotsContainer">
            <!-- –ë—É–¥–µ—Ç –∑–∞–ø–æ–ª–Ω–µ–Ω–æ JavaScript -->
        </div>
        
    </div>
    
    <script>
        // –î–∞–Ω–Ω—ã–µ —Å —Å–µ—Ä–≤–µ—Ä–∞
        const availableSlots = {{ available_slots|tojson }};
        const templateWeek = {{ template_week|tojson }};
        const currentSchedule = {{ current_schedule|tojson }};
        const timezone = "{{ timezone }}";
        const mode = "{{ mode }}";
        
        console.log('üì∏ –î–∞–Ω–Ω—ã–µ –¥–ª—è —Å–∫—Ä–∏–Ω—à–æ—Ç–∞:', {
            availableSlots: availableSlots.length,
            templateWeek: templateWeek.length,
            currentSchedule: currentSchedule.length,
            timezone,
            mode
        });
        
        // –§—É–Ω–∫—Ü–∏—è –∫–æ–Ω–≤–µ—Ä—Ç–∞—Ü–∏–∏ –≤—Ä–µ–º–µ–Ω–∏ (—É–ø—Ä–æ—â–µ–Ω–Ω–∞—è)
        function convertTime(timeStr, fromTz, toTz) {
            const timezoneOffsets = {
                '–ö–õ–î': 2, '–ú–°–ö': 3, '–ú–°–ö+1': 4, '–ï–ö–ë': 5, '–û–ú–°': 6, 
                '–ù–°–ö': 7, '–ò–†–ö': 8, '–Ø–ö–¢': 9, '–í–õ–î': 10, '–ú–ì–î': 11, '–ö–ê–ú': 12
            };
            
            const [hours, minutes] = timeStr.split(':').map(Number);
            const fromOffset = timezoneOffsets[fromTz] || 4;
            const toOffset = timezoneOffsets[toTz] || 4;
            const diff = toOffset - fromOffset;
            
            const newHours = (hours + diff + 24) % 24;
            return `${newHours.toString().padStart(2, '0')}:${minutes.toString().padStart(2, '0')}`;
        }
        
        // –ü—Ä–æ–≤–µ—Ä–∫–∞ –∑–∞–Ω—è—Ç–æ—Å—Ç–∏ —Å–ª–æ—Ç–∞
        function checkSlotOccupied(slot, dayName) {
            if (mode === 'regular') {
                return templateWeek.some(lesson => 
                    lesson.day === dayName && lesson.time === slot.time
                );
            } else {
                // –î–ª—è –≤–Ω–µ–ø–ª–∞–Ω–æ–≤—ã—Ö –ø–æ–∫–∞ –∑–∞–≥–ª—É—à–∫–∞
                return false;
            }
        }
        
        // –ü–æ–ª—É—á–µ–Ω–∏–µ –ø—Ä–µ–¥–º–µ—Ç–∞ –¥–ª—è —Å–ª–æ—Ç–∞ (–ë–ï–ó –∏–º–µ–Ω–∏ —É—á–µ–Ω–∏–∫–∞!)
        function getSlotSubject(slot, dayName) {
            if (mode === 'regular') {
                const lesson = templateWeek.find(l => 
                    l.day === dayName && l.time === slot.time
                );
                return lesson ? lesson.subject : '';
            } else {
                // –î–ª—è –≤–Ω–µ–ø–ª–∞–Ω–æ–≤—ã—Ö –ø–æ–∫–∞ –∑–∞–≥–ª—É—à–∫–∞
                return '';
            }
        }
        
        // –û—Ç—Ä–∏—Å–æ–≤–∫–∞ —Å–ª–æ—Ç–æ–≤
        function renderSlots() {
            const container = document.getElementById('slotsContainer');
            const dayNames = ['–ü–æ–Ω–µ–¥–µ–ª—å–Ω–∏–∫', '–í—Ç–æ—Ä–Ω–∏–∫', '–°—Ä–µ–¥–∞', '–ß–µ—Ç–≤–µ—Ä–≥', '–ü—è—Ç–Ω–∏—Ü–∞', '–°—É–±–±–æ—Ç–∞', '–í–æ—Å–∫—Ä–µ—Å–µ–Ω—å–µ'];
            
            let html = '';
            
            // –ó–∞–≥–æ–ª–æ–≤–∫–∏ –¥–Ω–µ–π
            html += '<div class="screenshot-week-grid">';
            dayNames.forEach(dayName => {
                html += `<div class="screenshot-day-header">${dayName}</div>`;
            });
            
            // –ö–æ–ª–æ–Ω–∫–∏ —Å —Å–ª–æ—Ç–∞–º–∏
            dayNames.forEach(dayName => {
                html += `<div class="screenshot-day-column">`;
                
                // –ù–∞—Ö–æ–¥–∏–º —Å–ª–æ—Ç—ã –¥–ª—è —ç—Ç–æ–≥–æ –¥–Ω—è
                const daySlots = availableSlots.filter(slot => 
                    slot.day === dayName && slot.type === 'permanent'
                );
                
                daySlots.sort((a, b) => a.time.localeCompare(b.time));
                
                if (daySlots.length > 0) {
                    daySlots.forEach(slot => {
                        const convertedTime = convertTime(slot.time, '–ú–°–ö+1', timezone);
                        const isOccupied = checkSlotOccupied(slot, dayName);
                        const subject = getSlotSubject(slot, dayName);
                        
                        const statusClass = isOccupied ? 'occupied' : 'free';
                        const statusText = isOccupied ? '–ó–ê–ù–Ø–¢' : '–°–í–û–ë–û–î–ï–ù';
                        
                        html += `
                            <div class="screenshot-slot ${statusClass}">
                                <div class="screenshot-slot-time">${convertedTime}</div>
                                <div class="screenshot-slot-status">${statusText}</div>
                                ${subject ? `<div class="screenshot-slot-subject">${subject}</div>` : ''}
                            </div>
                        `;
                    });
                } else {
                    html += '<div style="text-align: center; color: var(--text-muted); font-style: italic; margin-top: 50px;">–ù–µ—Ç —Å–ª–æ—Ç–æ–≤</div>';
                }
                
                html += '</div>';
            });
            
            html += '</div>';
            container.innerHTML = html;
        }
        
        // –ó–∞–ø—É—Å–∫–∞–µ–º –æ—Ç—Ä–∏—Å–æ–≤–∫—É –ø—Ä–∏ –∑–∞–≥—Ä—É–∑–∫–µ
        document.addEventListener('DOMContentLoaded', renderSlots);
    </script>
</body>
</html>