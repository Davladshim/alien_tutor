{% extends "base.html" %}
{% block content %}
<div style="text-align: center; margin-bottom: 30px;">
    <h2>–ù–∞–≥—Ä—É–∑–∫–∞</h2>
</div>

<!-- –ü–∞–Ω–µ–ª—å —É–ø—Ä–∞–≤–ª–µ–Ω–∏—è -->
<div class="card" style="margin-bottom: 20px; padding: 15px 25px;">  <!-- –ë—ã–ª–æ padding: 20px -->
    <div style="display: flex; justify-content: space-evenly; align-items: center; gap: 15px; padding: 0;">  <!-- –£–±—Ä–∞–ª–∏ padding: 20px -->
        
        <!-- –ü–µ—Ä–µ–∫–ª—é—á–∞—Ç–µ–ª—å —Ä–µ–∂–∏–º–∞ -->
        <div class="view-toggle-container" style="justify-content: center; align-items: center;">
            <button class="view-toggle-btn active" onclick="switchMode('regular')" id="regularBtn">
                <span>–†–µ–≥—É–ª—è—Ä–Ω—ã–µ</span>
            </button>
            <button class="view-toggle-btn" onclick="switchMode('unplanned')" id="unplannedBtn">
                <span>–í–Ω–µ–ø–ª–∞–Ω–æ–≤—ã–µ</span>
            </button>
        </div>

        <!-- –í—ã–±–æ—Ä —á–∞—Å–æ–≤–æ–≥–æ –ø–æ—è—Å–∞ -->
        <div style="display: flex; flex-direction: column; align-items: center; gap: 8px;">
            <span style="font-weight: bold; color: var(--text-primary); font-size: 14px;">–ß–∞—Å–æ–≤–æ–π –ø–æ—è—Å</span>
            <select id="timezoneSelect" onchange="changeTimezone()" style="padding: 8px 12px; border-radius: 8px; background: var(--bg-card); border: 1px solid var(--border-secondary); color: var(--text-primary);">
                <option value="–ú–°–ö+1" selected>–ú–°–ö+1 (UTC+4) - –°–∞–º–∞—Ä–∞, –ò–∂–µ–≤—Å–∫</option>
                <option value="–ö–õ–î">–ö–õ–î (UTC+2) - –ö–∞–ª–∏–Ω–∏–Ω–≥—Ä–∞–¥</option>
                <option value="–ú–°–ö">–ú–°–ö (UTC+3) - –ú–æ—Å–∫–≤–∞, –°–ü–±</option>
                <option value="–ï–ö–ë">–ï–ö–ë (UTC+5) - –ï–∫–∞—Ç–µ—Ä–∏–Ω–±—É—Ä–≥</option>
                <option value="–û–ú–°">–û–ú–° (UTC+6) - –û–º—Å–∫</option>
                <option value="–ù–°–ö">–ù–°–ö (UTC+7) - –ù–æ–≤–æ—Å–∏–±–∏—Ä—Å–∫</option>
                <option value="–ò–†–ö">–ò–†–ö (UTC+8) - –ò—Ä–∫—É—Ç—Å–∫</option>
                <option value="–Ø–ö–¢">–Ø–ö–¢ (UTC+9) - –Ø–∫—É—Ç—Å–∫</option>
                <option value="–í–õ–î">–í–õ–î (UTC+10) - –í–ª–∞–¥–∏–≤–æ—Å—Ç–æ–∫</option>
                <option value="–ú–ì–î">–ú–ì–î (UTC+11) - –ú–∞–≥–∞–¥–∞–Ω</option>
                <option value="–ö–ê–ú">–ö–ê–ú (UTC+12) - –ö–∞–º—á–∞—Ç–∫–∞</option>
            </select>
        </div>

        <!-- –ù–∞–≤–∏–≥–∞—Ü–∏—è –ø–æ –Ω–µ–¥–µ–ª—è–º (—Ç–æ–ª—å–∫–æ –¥–ª—è –≤–Ω–µ–ø–ª–∞–Ω–æ–≤—ã—Ö) -->
        <div id="weekNavigation" style="display: none;">
            <div style="display: flex; align-items: center; gap: 15px;">
                <button onclick="navigateWeek(-1)" class="schedule-nav-btn">‚Üê –ü—Ä–µ–¥. –Ω–µ–¥–µ–ª—è</button>
                <span id="currentWeekTitle" style="font-weight: bold; color: var(--text-accent); min-width: 150px; text-align: center;">–¢–µ–∫—É—â–∞—è –Ω–µ–¥–µ–ª—è</span>
                <button onclick="navigateWeek(1)" class="schedule-nav-btn">–°–ª–µ–¥. –Ω–µ–¥–µ–ª—è ‚Üí</button>
            </div>
        </div>

        <!-- –ö–Ω–æ–ø–∫–∞ –Ω–∞—Å—Ç—Ä–æ–π–∫–∏ —Å–ª–æ—Ç–æ–≤ -->
        <div>
            <span title="–ù–∞—Å—Ç—Ä–æ–∏—Ç—å —Å–ª–æ—Ç—ã" class="icon-action" onclick="window.location.href='{{ url_for('setup_slots') }}'">
                <svg viewBox="0 0 24 24" width="28" height="28" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                    <circle cx="12" cy="12" r="10"/>
                    <line x1="12" y1="8" x2="12" y2="16"/>
                    <line x1="8" y1="12" x2="16" y2="12"/>
                </svg>
            </span>
        </div>
    </div>
</div>



<!-- –û—Å–Ω–æ–≤–Ω–∞—è –æ–±–ª–∞—Å—Ç—å –æ—Ç–æ–±—Ä–∞–∂–µ–Ω–∏—è -->
<div
    <div id="loadingIndicator" style="text-align: center; padding: 50px; color: var(--text-muted);">
        <h3>–ó–∞–≥—Ä—É–∑–∫–∞ –¥–∞–Ω–Ω—ã—Ö...</h3>
    </div>

    <!-- –ù–µ–¥–µ–ª—å–Ω–∞—è —Å–µ—Ç–∫–∞ –ë–ï–ó –õ–ò–®–ù–ï–ô –ü–û–î–õ–û–ñ–ö–ò -->
    <div id="weeklyGrid" style="display: none;">
        <div class="week-grid-nagruzka" id="slotsGrid">
            <!-- –ë—É–¥–µ—Ç –∑–∞–ø–æ–ª–Ω–µ–Ω–æ —á–µ—Ä–µ–∑ JavaScript -->
        </div>
    </div>

    <!-- –°–æ—Å—Ç–æ—è–Ω–∏–µ "–Ω–µ—Ç —Å–ª–æ—Ç–æ–≤" -->
    <div id="noSlotsMessage" style="display: none; text-align: center; padding: 60px; color: var(--text-muted);">
        <h3>–°–ª–æ—Ç—ã –Ω–µ –Ω–∞—Å—Ç—Ä–æ–µ–Ω—ã</h3>
        <p>–°–Ω–∞—á–∞–ª–∞ –¥–æ–±–∞–≤—å—Ç–µ –¥–æ—Å—Ç—É–ø–Ω—ã–µ –≤—Ä–µ–º–µ–Ω–Ω—ã–µ —Å–ª–æ—Ç—ã —á–µ—Ä–µ–∑ –∫–Ω–æ–ø–∫—É –Ω–∞—Å—Ç—Ä–æ–µ–∫</p>
    </div>
</div>
<script>
// –ì–ª–æ–±–∞–ª—å–Ω—ã–µ –ø–µ—Ä–µ–º–µ–Ω–Ω—ã–µ
let currentMode = 'regular'; // 'regular' –∏–ª–∏ 'unplanned'
let currentTimezone = '–ú–°–ö+1';
let currentYear = new Date().getFullYear();
let currentWeek = getWeekNumber(new Date());
let availableSlots = [];
let templateWeek = [];
let currentSchedule = [];

// –ü–æ–ª—É—á–µ–Ω–∏–µ –Ω–æ–º–µ—Ä–∞ –Ω–µ–¥–µ–ª–∏
function getWeekNumber(date) {
    const d = new Date(Date.UTC(date.getFullYear(), date.getMonth(), date.getDate()));
    const dayNum = d.getUTCDay() || 7;
    d.setUTCDate(d.getUTCDate() + 4 - dayNum);
    const yearStart = new Date(Date.UTC(d.getUTCFullYear(), 0, 1));
    return Math.ceil((((d - yearStart) / 86400000) + 1) / 7);
}

// –ü–æ–ª—É—á–µ–Ω–∏–µ –¥–∞—Ç –Ω–µ–¥–µ–ª–∏
function getWeekDates(year, week) {
    const jan4 = new Date(year, 0, 4);
    const firstMonday = new Date(jan4.getTime() - (jan4.getDay() - 1) * 86400000);
    const targetWeek = new Date(firstMonday.getTime() + (week - 1) * 7 * 86400000);
    
    const dates = [];
    const dayNames = ['–ü–æ–Ω–µ–¥–µ–ª—å–Ω–∏–∫', '–í—Ç–æ—Ä–Ω–∏–∫', '–°—Ä–µ–¥–∞', '–ß–µ—Ç–≤–µ—Ä–≥', '–ü—è—Ç–Ω–∏—Ü–∞', '–°—É–±–±–æ—Ç–∞', '–í–æ—Å–∫—Ä–µ—Å–µ–Ω—å–µ'];
    const dayNamesShort = ['–ü–Ω', '–í—Ç', '–°—Ä', '–ß—Ç', '–ü—Ç', '–°–±', '–í—Å'];
    
    for (let i = 0; i < 7; i++) {
        const date = new Date(targetWeek.getTime() + i * 86400000);
        dates.push({
            dayName: dayNames[i],
            dayNameShort: dayNamesShort[i],
            date: date.toISOString().split('T')[0],
            displayDate: date.toLocaleDateString('ru-RU', { day: '2-digit', month: '2-digit' }),
            isToday: date.toDateString() === new Date().toDateString()
        });
    }
    
    return dates;
}

// –ü–µ—Ä–µ–∫–ª—é—á–µ–Ω–∏–µ —Ä–µ–∂–∏–º–∞
function switchMode(mode) {
    console.log('–ü–µ—Ä–µ–∫–ª—é—á–∞–µ–º —Ä–µ–∂–∏–º –Ω–∞:', mode); // –û—Ç–ª–∞–¥–∫–∞
    
    currentMode = mode;
    
    // –£–±–∏—Ä–∞–µ–º –∫–ª–∞—Å—Å active —É –≤—Å–µ—Ö –∫–Ω–æ–ø–æ–∫
    const allBtns = document.querySelectorAll('.view-toggle-btn');
    console.log('–ù–∞–π–¥–µ–Ω–æ –∫–Ω–æ–ø–æ–∫:', allBtns.length); // –û—Ç–ª–∞–¥–∫–∞
    
    allBtns.forEach(btn => {
        btn.classList.remove('active');
        console.log('–£–±—Ä–∞–ª–∏ active —É –∫–Ω–æ–ø–∫–∏:', btn.id); // –û—Ç–ª–∞–¥–∫–∞
    });
    
    // –î–æ–±–∞–≤–ª—è–µ–º –∫–ª–∞—Å—Å active –∫ –Ω—É–∂–Ω–æ–π –∫–Ω–æ–ø–∫–µ
    if (mode === 'regular') {
        const regularBtn = document.getElementById('regularBtn');
        regularBtn.classList.add('active');
        console.log('–î–æ–±–∞–≤–∏–ª–∏ active –∫ regularBtn'); // –û—Ç–ª–∞–¥–∫–∞
    } else {
        const unplannedBtn = document.getElementById('unplannedBtn');
        unplannedBtn.classList.add('active');
        console.log('–î–æ–±–∞–≤–∏–ª–∏ active –∫ unplannedBtn'); // –û—Ç–ª–∞–¥–∫–∞
    }
    
    // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º/—Å–∫—Ä—ã–≤–∞–µ–º –Ω–∞–≤–∏–≥–∞—Ü–∏—é –ø–æ –Ω–µ–¥–µ–ª—è–º
    document.getElementById('weekNavigation').style.display = mode === 'unplanned' ? 'block' : 'none';
    
    // –ó–∞–≥—Ä—É–∂–∞–µ–º –¥–∞–Ω–Ω—ã–µ
    loadData();
}

// –ù–∞–≤–∏–≥–∞—Ü–∏—è –ø–æ –Ω–µ–¥–µ–ª—è–º
function navigateWeek(direction) {
    currentWeek += direction;
    
    if (currentWeek < 1) {
        currentWeek = 52;
        currentYear--;
    } else if (currentWeek > 52) {
        currentWeek = 1;
        currentYear++;
    }
    
    updateWeekTitle();
    loadData();
}

// –û–±–Ω–æ–≤–ª–µ–Ω–∏–µ –∑–∞–≥–æ–ª–æ–≤–∫–∞ –Ω–µ–¥–µ–ª–∏
function updateWeekTitle() {
    const weekDates = getWeekDates(currentYear, currentWeek);
    const startDate = weekDates[0].displayDate;
    const endDate = weekDates[6].displayDate;
    
    const title = currentWeek === getWeekNumber(new Date()) && currentYear === new Date().getFullYear() 
        ? '–¢–µ–∫—É—â–∞—è –Ω–µ–¥–µ–ª—è' 
        : `${startDate} - ${endDate}`;
    
    document.getElementById('currentWeekTitle').textContent = title;
}

// –°–º–µ–Ω–∞ —á–∞—Å–æ–≤–æ–≥–æ –ø–æ—è—Å–∞
function changeTimezone() {
    currentTimezone = document.getElementById('timezoneSelect').value;
    renderSlots();
}

// –ö–æ–Ω–≤–µ—Ä—Ç–∞—Ü–∏—è –≤—Ä–µ–º–µ–Ω–∏ –º–µ–∂–¥—É —á–∞—Å–æ–≤—ã–º–∏ –ø–æ—è—Å–∞–º–∏
function convertTime(timeStr, fromTz, toTz) {
    // –£–ø—Ä–æ—â–µ–Ω–Ω–∞—è –∫–æ–Ω–≤–µ—Ä—Ç–∞—Ü–∏—è –¥–ª—è —Ä–æ—Å—Å–∏–π—Å–∫–∏—Ö —á–∞—Å–æ–≤—ã—Ö –ø–æ—è—Å–æ–≤
    const timezoneOffsets = {
        '–ö–õ–î': 2, '–ú–°–ö': 3, '–ú–°–ö+1': 4, '–ï–ö–ë': 5, '–û–ú–°': 6, 
        '–ù–°–ö': 7, '–ò–†–ö': 8, '–Ø–ö–¢': 9, '–í–õ–î': 10, '–ú–ì–î': 11, '–ö–ê–ú': 12
    };
    
    const [hours, minutes] = timeStr.split(':').map(Number);
    const fromOffset = timezoneOffsets[fromTz] || 4;
    const toOffset = timezoneOffsets[toTz] || 4;
    const diff = toOffset - fromOffset;
    
    const newHours = (hours + diff + 24) % 24;
    return `${newHours.toString().padStart(2, '0')}:${minutes.toString().padStart(2, '0')}`;
}

// –ó–∞–≥—Ä—É–∑–∫–∞ –¥–∞–Ω–Ω—ã—Ö
async function loadData() {
    showLoading(true);
    
    try {
        // –ó–∞–≥—Ä—É–∂–∞–µ–º –¥–æ—Å—Ç—É–ø–Ω—ã–µ —Å–ª–æ—Ç—ã
        const slotsResponse = await fetch('/api/available-slots');
        availableSlots = await slotsResponse.json();
        
        if (availableSlots.length === 0) {
            showNoSlots();
            return;
        }
        
        if (currentMode === 'regular') {
            // –ó–∞–≥—Ä—É–∂–∞–µ–º —à–∞–±–ª–æ–Ω –Ω–µ–¥–µ–ª–∏
            const templateResponse = await fetch('/api/template-week');
            templateWeek = await templateResponse.json();
        } else {
            // –ó–∞–≥—Ä—É–∂–∞–µ–º —Ä–∞—Å–ø–∏—Å–∞–Ω–∏–µ –Ω–∞ –∫–æ–Ω–∫—Ä–µ—Ç–Ω—É—é –Ω–µ–¥–µ–ª—é
            const scheduleResponse = await fetch(`/api/week-schedule/${currentYear}/${currentWeek}`);
            currentSchedule = await scheduleResponse.json();
        }
        
        renderSlots();
        
    } catch (error) {
        console.error('–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ –¥–∞–Ω–Ω—ã—Ö:', error);
        showError('–ù–µ —É–¥–∞–ª–æ—Å—å –∑–∞–≥—Ä—É–∑–∏—Ç—å –¥–∞–Ω–Ω—ã–µ');
    }
}

// –û—Ç–æ–±—Ä–∞–∂–µ–Ω–∏–µ –∑–∞–≥—Ä—É–∑–∫–∏
function showLoading(show) {
    document.getElementById('loadingIndicator').style.display = show ? 'block' : 'none';
    document.getElementById('weeklyGrid').style.display = show ? 'none' : 'block';
    document.getElementById('noSlotsMessage').style.display = 'none';
}

// –û—Ç–æ–±—Ä–∞–∂–µ–Ω–∏–µ —Å–æ–æ–±—â–µ–Ω–∏—è "–Ω–µ—Ç —Å–ª–æ—Ç–æ–≤"
function showNoSlots() {
    document.getElementById('loadingIndicator').style.display = 'none';
    document.getElementById('weeklyGrid').style.display = 'none';
    document.getElementById('noSlotsMessage').style.display = 'block';
}

// –û—Ç–æ–±—Ä–∞–∂–µ–Ω–∏–µ –æ—à–∏–±–∫–∏
function showError(message) {
    const errorDiv = document.createElement('div');
    errorDiv.style.cssText = `
        position: fixed; top: 20px; right: 20px; z-index: 1000;
        background: linear-gradient(45deg, #ef4444, #dc2626);
        color: white; padding: 15px; border-radius: 8px;
        font-weight: bold; box-shadow: 0 8px 25px rgba(239, 68, 68, 0.4);
    `;
    errorDiv.innerHTML = `‚ö†Ô∏è ${message}`;
    document.body.appendChild(errorDiv);
    
    setTimeout(() => errorDiv.remove(), 3000);
    showLoading(false);
}
// –û—Ç—Ä–∏—Å–æ–≤–∫–∞ —Å–ª–æ—Ç–æ–≤
function renderSlots() {
    showLoading(false);
    
    const weekDates = getWeekDates(currentYear, currentWeek);
    const slotsGrid = document.getElementById('slotsGrid');
    
    let html = '';
    
    // –°–æ–∑–¥–∞–µ–º —Å—Ç–æ–ª–±—Ü—ã –¥–ª—è –∫–∞–∂–¥–æ–≥–æ –¥–Ω—è –Ω–µ–¥–µ–ª–∏
    weekDates.forEach(dayInfo => {
        const todayClass = dayInfo.isToday ? 'today' : '';
        
        html += `
            <div class="week-day-column-nagruzka ${todayClass}">
                <div class="week-day-header-nagruzka">
                    <div class="week-day-name-nagruzka">${dayInfo.dayNameShort}</div>
                    <div class="week-day-date-nagruzka">${dayInfo.displayDate}</div>
                    ${dayInfo.isToday ? '<div class="today-badge-nagruzka">–°–ï–ì–û–î–ù–Ø</div>' : ''}
                </div>
        `;
        
        // –ù–∞—Ö–æ–¥–∏–º —Å–ª–æ—Ç—ã –¥–ª—è —ç—Ç–æ–≥–æ –¥–Ω—è
        const daySlots = availableSlots.filter(slot => {
            // –î–ª—è —Ä–µ–∂–∏–º–∞ "–≤–Ω–µ–ø–ª–∞–Ω–æ–≤—ã–µ" —Ñ–∏–ª—å—Ç—Ä—É–µ–º —Ç–æ–ª—å–∫–æ –ø–æ—Å—Ç–æ—è–Ω–Ω—ã–µ —Å–ª–æ—Ç—ã –∏–ª–∏ —Å–ª–æ—Ç—ã —Ç–µ–∫—É—â–µ–π –Ω–µ–¥–µ–ª–∏
            if (currentMode === 'unplanned') {
                return slot.day === dayInfo.dayName && 
                       (slot.type === 'permanent' || 
                        (slot.type === 'current_week' && slot.week === currentWeek && slot.year === currentYear));
            }
            // –î–ª—è —Ä–µ–∂–∏–º–∞ "—Ä–µ–≥—É–ª—è—Ä–Ω—ã–µ" –ø–æ–∫–∞–∑—ã–≤–∞–µ–º —Ç–æ–ª—å–∫–æ –ø–æ—Å—Ç–æ—è–Ω–Ω—ã–µ —Å–ª–æ—Ç—ã
            return slot.day === dayInfo.dayName && slot.type === 'permanent';
        });
        
        // –°–æ—Ä—Ç–∏—Ä—É–µ–º —Å–ª–æ—Ç—ã –ø–æ –≤—Ä–µ–º–µ–Ω–∏
        daySlots.sort((a, b) => a.time.localeCompare(b.time));
        
        if (daySlots.length > 0) {
            daySlots.forEach(slot => {
                const convertedTime = convertTime(slot.time, '–ú–°–ö+1', currentTimezone);
                const isOccupied = checkSlotOccupied(slot, dayInfo.date);
                
                const statusClass = isOccupied ? 'slot-occupied' : 'slot-free';
                const statusText = isOccupied ? '–ó–∞–Ω—è—Ç' : '–°–≤–æ–±–æ–¥–µ–Ω';

                html += `
                    <div class="slot-item ${statusClass}" data-slot-id="${slot.id || Math.random()}" style="position: relative;">
                        
                        <!-- –ö–Ω–æ–ø–∫–∞ —É–¥–∞–ª–µ–Ω–∏—è —Å–ª–æ—Ç–∞ -->
                        <span class="delete-slot-btn" 
                            onclick="event.stopPropagation(); deleteSlot('${slot.id}', '${slot.day}', '${convertedTime}');"
                            title="–£–¥–∞–ª–∏—Ç—å —ç—Ç–æ—Ç —Å–ª–æ—Ç"
                            style="position: absolute; top: 8px; right: 8px; width: 22px; height: 22px; 
                                    background: rgba(239, 68, 68, 0.9); color: white; border-radius: 50%; 
                                    cursor: pointer; display: flex; align-items: center; justify-content: center;
                                    font-size: 14px; font-weight: bold; line-height: 1;
                                    box-shadow: 0 2px 6px rgba(239, 68, 68, 0.4);
                                    font-family: Arial, sans-serif; opacity: 0; visibility: hidden;
                                    transform: scale(0.8); transition: all 0.3s ease;">
                            √ó
                        </span>
                        
                        <div class="slot-time">${convertedTime}</div>
                        <div class="slot-status">
                            ${statusText}
                        </div>
                        ${slot.duration !== 60 ? `<div class="slot-duration">${slot.duration} –º–∏–Ω</div>` : ''}
                        ${isOccupied ? `<div class="slot-lesson">${getSlotLesson(slot, dayInfo.date)}</div>` : ''}
                    </div>
                `;
            });
        } else {
            html += `
                <div style="text-align: center; color: var(--text-muted); font-style: italic; margin-top: 50px;">
                    –ù–µ—Ç –Ω–∞—Å—Ç—Ä–æ–µ–Ω–Ω—ã—Ö —Å–ª–æ—Ç–æ–≤
                </div>
            `;
        }
        
        html += '</div>';
    });
    
    slotsGrid.innerHTML = html;
}

// –ü—Ä–æ–≤–µ—Ä–∫–∞ –∑–∞–Ω—è—Ç–æ—Å—Ç–∏ —Å–ª–æ—Ç–∞
function checkSlotOccupied(slot, date) {
    if (currentMode === 'regular') {
        // –ü—Ä–æ–≤–µ—Ä—è–µ–º —à–∞–±–ª–æ–Ω –Ω–µ–¥–µ–ª–∏
        return templateWeek.some(lesson => 
            lesson.day === slot.day && 
            lesson.time === slot.time
        );
    } else {
        // –ü—Ä–æ–≤–µ—Ä—è–µ–º —Ä–∞—Å–ø–∏—Å–∞–Ω–∏–µ –Ω–∞ –∫–æ–Ω–∫—Ä–µ—Ç–Ω—É—é –¥–∞—Ç—É
        return currentSchedule.some(lesson => 
            lesson.date === date && 
            lesson.time === slot.time
        );
    }
}

// –§—É–Ω–∫—Ü–∏—è –¥–ª—è —Å–æ–∫—Ä–∞—â–µ–Ω–∏—è –Ω–∞–∑–≤–∞–Ω–∏–π –ø—Ä–µ–¥–º–µ—Ç–æ–≤
function shortenSubject(subject) {
    const subjects = {
        '–ú–∞—Ç–µ–º–∞—Ç–∏–∫–∞': '–ú–∞—Ç–µ–º.',
        '–§–∏–∑–∏–∫–∞': '–§–∏–∑.',
        '–•–∏–º–∏—è': '–•–∏–º.',
        '–ü—Ä–æ–±–Ω—ã–π —É—Ä–æ–∫': '–ü—Ä–æ–±.'
    };
    
    return subjects[subject] || subject;
}

// –ü–æ–ª—É—á–µ–Ω–∏–µ –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏–∏ –æ —É—Ä–æ–∫–µ –≤ —Å–ª–æ—Ç–µ
function getSlotLesson(slot, date) {
    if (currentMode === 'regular') {
        const lesson = templateWeek.find(l => 
            l.day === slot.day && l.time === slot.time
        );
        return lesson ? `${lesson.student} ${shortenSubject(lesson.subject)}` : '';
    } else {
        const lesson = currentSchedule.find(l => 
            l.date === date && l.time === slot.time
        );
        return lesson ? `${lesson.student} ${shortenSubject(lesson.subject)}` : '';
    }
}

// –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è –ø—Ä–∏ –∑–∞–≥—Ä—É–∑–∫–µ —Å—Ç—Ä–∞–Ω–∏—Ü—ã
document.addEventListener('DOMContentLoaded', function() {
    // –£—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º —Ç–µ–∫—É—â—É—é –Ω–µ–¥–µ–ª—é
    updateWeekTitle();
    
    // –ó–∞–≥—Ä—É–∂–∞–µ–º –¥–∞–Ω–Ω—ã–µ
    loadData();
});

// –§—É–Ω–∫—Ü–∏—è —É–¥–∞–ª–µ–Ω–∏—è —Å–ª–æ—Ç–∞
function deleteSlot(slotId, day, time) {
    const message = `–£–¥–∞–ª–∏—Ç—å —Å–ª–æ—Ç?\n\n` +
                   `üìÖ –î–µ–Ω—å: ${day}\n` +
                   `üïê –í—Ä–µ–º—è: ${time}\n\n` +
                   `‚ö†Ô∏è –≠—Ç–æ –¥–µ–π—Å—Ç–≤–∏–µ:\n` +
                   `‚Ä¢ –£–¥–∞–ª–∏—Ç —Å–ª–æ—Ç –∏–∑ –Ω–∞—Å—Ç—Ä–æ–µ–∫ –Ω–∞–≤—Å–µ–≥–¥–∞\n` +
                   `‚Ä¢ –°–ª–æ—Ç –∏—Å—á–µ–∑–Ω–µ—Ç –∏–∑ –Ω–∞–≥—Ä—É–∑–∫–∏\n\n` +
                   `–ü—Ä–æ–¥–æ–ª–∂–∏—Ç—å?`;
    
    if (confirm(message)) {
        fetch(`/api/delete-slot/${slotId}`, {
            method: 'POST'
        })
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                loadData(); // –ü–µ—Ä–µ–∑–∞–≥—Ä—É–∂–∞–µ–º –¥–∞–Ω–Ω—ã–µ
                alert('–°–ª–æ—Ç —É–¥–∞–ª–µ–Ω!');
            } else {
                alert('–û—à–∏–±–∫–∞: ' + data.message);
            }
        })
        .catch(error => {
            console.error('–û—à–∏–±–∫–∞:', error);
            alert('–û—à–∏–±–∫–∞ —É–¥–∞–ª–µ–Ω–∏—è —Å–ª–æ—Ç–∞');
        });
    }
}

// –°—Ç–∏–ª–∏ –¥–ª—è –∫–Ω–æ–ø–æ–∫ —É–¥–∞–ª–µ–Ω–∏—è —Å–ª–æ—Ç–æ–≤
document.addEventListener('DOMContentLoaded', function() {
    const style = document.createElement('style');
    style.textContent += `
        /* –ö–Ω–æ–ø–∫–∞ —É–¥–∞–ª–µ–Ω–∏—è —Å–ª–æ—Ç–∞ —Å–∫—Ä—ã—Ç–∞ –ø–æ —É–º–æ–ª—á–∞–Ω–∏—é */
        .delete-slot-btn {
            opacity: 0 !important;
            visibility: hidden !important;
            transform: scale(0.8) !important;
            transition: all 0.3s ease !important;
        }
        
        /* –ü–æ–∫–∞–∑—ã–≤–∞–µ–º –∫–Ω–æ–ø–∫—É –ø—Ä–∏ –Ω–∞–≤–µ–¥–µ–Ω–∏–∏ –Ω–∞ —Å–ª–æ—Ç */
        .slot-item:hover .delete-slot-btn {
            opacity: 1 !important;
            visibility: visible !important;
            transform: scale(1) !important;
        }
        
        /* –≠—Ñ—Ñ–µ–∫—Ç—ã –ø—Ä–∏ –Ω–∞–≤–µ–¥–µ–Ω–∏–∏ –Ω–∞ —Å–∞–º—É –∫–Ω–æ–ø–∫—É */
        .delete-slot-btn:hover {
            background: #dc2626 !important;
            transform: scale(1.15) !important;
            box-shadow: 0 4px 12px rgba(239, 68, 68, 0.6) !important;
        }
    `;
    document.head.appendChild(style);
});

// –ê–≤—Ç–æ–æ–±–Ω–æ–≤–ª–µ–Ω–∏–µ –∫–∞–∂–¥—ã–µ 2 –º–∏–Ω—É—Ç—ã
setInterval(loadData, 120000);

</script>

<style>
/* –ù–û–í–´–ï –°–¢–ò–õ–ò –î–õ–Ø –ù–ê–ì–†–£–ó–ö–ò - –ë–ï–ó –î–í–û–ô–ù–´–• –ü–û–î–õ–û–ñ–ï–ö */
.week-grid-nagruzka {
    display: grid;
    grid-template-columns: repeat(7, 1fr);
    gap: 10px;
    min-width: 100%;
}

.week-day-column-nagruzka {
    background: var(--bg-secondary);
    backdrop-filter: blur(10px);
    border-radius: 15px;
    padding: 25px;
    min-height: 350px;
    border: 1px solid var(--border-primary);
    transition: all 0.3s ease;
    position: relative;
    overflow: hidden;
}

.week-day-column-nagruzka:hover {
    transform: translateY(-3px);
    box-shadow: 0 8px 30px rgba(0, 212, 255, 0.2);
    border-color: rgba(0, 212, 255, 0.3);
}

.week-day-column-nagruzka.today {
    background: linear-gradient(135deg, rgba(0, 212, 255, 0.2), rgba(124, 58, 237, 0.2));
    border: 2px solid #00d4ff;
    box-shadow: 0 0 25px rgba(0, 212, 255, 0.4);
}

.week-day-header-nagruzka {
    background: var(--accent-gradient);
    color: white;
    padding: 15px;
    border-radius: 12px;
    text-align: center;
    font-weight: bold;
    margin-bottom: 20px;
    box-shadow: 0 4px 15px rgba(0, 212, 255, 0.3);
    position: relative;
    overflow: hidden;
}

.week-day-name-nagruzka {
    font-size: 14px;
    margin-bottom: 6px;
}

.week-day-date-nagruzka {
    font-size: 16px;
    font-weight: 700;
}

.today-badge-nagruzka {
    font-size: 11px;
    background: rgba(255, 255, 255, 0.2);
    color: white;
    padding: 3px 8px;
    border-radius: 12px;
    margin-top: 6px;
    display: inline-block;
}

@media (max-width: 768px) {
    .week-grid-nagruzka {
        grid-template-columns: repeat(3, 1fr);
        gap: 8px;
    }
    
    .week-day-column-nagruzka {
        min-height: 250px;
        padding: 20px;
    }
}

@media (max-width: 480px) {
    .week-grid-nagruzka {
        grid-template-columns: repeat(2, 1fr);
        gap: 6px;
    }
    
    .week-day-column-nagruzka {
        min-height: 200px;
        padding: 15px;
    }
}

/* –°–ü–ï–¶–ò–ê–õ–¨–ù–´–ï –°–¢–ò–õ–ò –°–õ–û–¢–û–í –¢–û–õ–¨–ö–û –î–õ–Ø –ù–ê–ì–†–£–ó–ö–ò */
.week-day-column-nagruzka .slot-item {
    padding: 15px 18px;
}

.week-day-column-nagruzka .slot-time {
    background: var(--accent-gradient) !important;
    color: white !important;
    padding: 8px 12px !important;
    border-radius: 6px !important;
    font-size: 14px !important;
    font-weight: bold !important;
    margin-bottom: 12px !important;
    display: inline-block !important;
    min-width: 63px !important;
    max-width: 81px !important;
    text-align: center !important;
    box-sizing: border-box !important;
    white-space: nowrap !important;
    overflow: hidden !important;
}

.week-day-column-nagruzka .slot-status {
    font-size: 13px;
    font-weight: 600;
    margin-bottom: 8px;
}

/* –ö–æ–º–ø–∞–∫—Ç–Ω–∞—è –ø–∞–Ω–µ–ª—å —É–ø—Ä–∞–≤–ª–µ–Ω–∏—è –Ω–∞–≥—Ä—É–∑–∫–æ–π - —Ç–æ–ª—å–∫–æ –¥–ª—è —ç—Ç–æ–π —Å—Ç—Ä–∞–Ω–∏—Ü—ã */
.card {
    padding: 15px 25px !important;
}

/* –ö–æ–º–ø–∞–∫—Ç–Ω—ã–µ —ç–ª–µ–º–µ–Ω—Ç—ã —É–ø—Ä–∞–≤–ª–µ–Ω–∏—è - –¢–û–õ–¨–ö–û –¥–ª—è —Å–µ–ª–µ–∫—Ç–∞ –∏ –Ω–∞–≤–∏–≥–∞—Ü–∏–∏ */
#timezoneSelect {
    padding: 6px 10px !important;
}

.schedule-nav-btn {
    padding: 8px 14px !important;
}

/* –ö–Ω–æ–ø–∫–∏ –ø–µ—Ä–µ–∫–ª—é—á–µ–Ω–∏—è —Ä–µ–≥—É–ª—è—Ä–Ω—ã–µ/–≤–Ω–µ–ø–ª–∞–Ω–æ–≤—ã–µ –æ—Å—Ç–∞–≤–ª—è–µ–º –Ω–æ—Ä–º–∞–ª—å–Ω–æ–≥–æ —Ä–∞–∑–º–µ—Ä–∞ */
.view-toggle-btn {
    padding: 12px 20px !important;
    margin: 8px !important;
}

</style>

<div style="text-align: center; margin-top: 30px;">
    <a href="{{ url_for('home') }}" 
       style="color: var(--text-accent); text-decoration: none; font-weight: bold; font-size: 16px;">
        ‚Üê –ù–∞–∑–∞–¥ –Ω–∞ –≥–ª–∞–≤–Ω—É—é
    </a>
</div>

{% endblock %}