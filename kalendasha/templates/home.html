{% extends "base.html" %}

{% block title %}Главная - Календаша{% endblock %}

{% block content %}
<div style="text-align: center; margin-bottom: 30px;">
    <h1>Админская панель</h1>
    <p style="color: var(--text-muted); font-size: 16px;">
        Управление учениками и быстрое добавление отчетов
    </p>
</div>

<!-- НОВАЯ СИСТЕМА ОТЧЕТОВ И ДОМАШЕК -->
<div class="card" style="margin-bottom: 30px;">
    <h2 style="margin-bottom: 25px; text-align: center;">Отчеты по урокам и домашние задания</h2>
    
    <!-- Блок выбора даты со счетчиком -->
    <div style="background: var(--bg-card); border-radius: 12px; padding: 20px; margin-bottom: 25px; border: 1px solid var(--border-secondary);">
        <div style="display: flex; justify-content: space-between; align-items: center; flex-wrap: wrap; gap: 15px;">
            
            <!-- Переключатель режимов -->
            <div style="min-width: 200px;">
                <label style="display: block; margin-bottom: 8px; font-weight: bold;">
                    Режим работы:
                </label>
                <div class="view-toggle">
                    <button class="view-toggle-btn active" id="report_mode" onclick="switchMode('report')">
                        <span>Отчет</span>
                    </button>
                    <button class="view-toggle-btn" id="homework_mode" onclick="switchMode('homework')">
                        <span>ДЗ</span>
                    </button>
                </div>
            </div>

            <!-- Выбор даты -->
            <div style="flex: 1; min-width: 200px;">
                <label for="date_select" style="display: block; margin-bottom: 8px; font-weight: bold;">
                    Выбрать другую дату:
                </label>
                <select id="date_select" style="width: 100%; padding: 10px; border-radius: 8px;">
                    <option value="2025-08-15">Сегодня (15.08.2025)</option>
                    <option value="2025-08-14">Вчера (14.08.2025)</option>
                    <option value="2025-08-13">13.08.2025 (вторник)</option>
                    <option value="2025-08-12">12.08.2025 (понедельник)</option>
                    <option value="2025-08-11">11.08.2025 (воскресенье)</option>
                </select>
            </div>
            
            <!-- Счетчик проблемных уроков -->
            <div style="text-align: center;">
                <div style="font-size: 14px; color: var(--text-muted); margin-bottom: 5px;">
                    Требуют внимания:
                </div>
                <div style="display: flex; gap: 15px; align-items: center;">
                    <div style="text-align: center;">
                        <div style="font-size: 24px; font-weight: bold; color: #ef4444;" id="homework_missing_count">
                            3
                        </div>
                        <div style="font-size: 12px; color: var(--text-muted);">
                            без домашки
                        </div>
                    </div>
                    <div style="font-size: 18px; color: var(--text-muted);">/</div>
                    <div style="text-align: center;">
                        <div style="font-size: 24px; font-weight: bold; color: #f59e0b;" id="homework_unchecked_count">
                            2
                        </div>
                        <div style="font-size: 12px; color: var(--text-muted);">
                            не проверены
                        </div>
                    </div>
                    <div style="font-size: 18px; color: var(--text-muted);">/</div>
                    <div style="text-align: center;">
                        <div style="font-size: 24px; font-weight: bold; color: #ef4444;" id="reports_missing_count">
                            1
                        </div>
                        <div style="font-size: 12px; color: var(--text-muted);">
                            без отчета
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
    
    <!-- Блоки с уроками - будут заполняться JavaScript -->
    <div style="display: grid; grid-template-columns: 1fr; gap: 20px; margin-bottom: 30px;">
        
        <!-- Уроки вчера -->
        <table style="width: 100%; border-collapse: collapse;">
            <tr>
                <td style="width: 200px; background: var(--accent-gradient); color: white; padding: 20px; 
                           font-weight: bold; font-size: 18px; text-align: center; vertical-align: middle; 
                           border-right: 2px solid var(--border-secondary);">
                    Уроки вчера<br>
                    <span style="font-size: 14px; font-weight: normal;">(14.08.2025)</span>
                </td>
                
                <!-- 6 пустых ячеек для уроков вчера -->
                <td style="background: var(--bg-card); padding: 15px; border-right: 1px solid var(--border-secondary); width: 200px;">
                    <div style="text-align: center; color: var(--text-muted); font-style: italic;">Нет урока</div>
                </td>
                <td style="background: var(--bg-card); padding: 15px; border-right: 1px solid var(--border-secondary); width: 200px;">
                    <div style="text-align: center; color: var(--text-muted); font-style: italic;">Нет урока</div>
                </td>
                <td style="background: var(--bg-card); padding: 15px; border-right: 1px solid var(--border-secondary); width: 200px;">
                    <div style="text-align: center; color: var(--text-muted); font-style: italic;">Нет урока</div>
                </td>
                <td style="background: var(--bg-card); padding: 15px; border-right: 1px solid var(--border-secondary); width: 200px;">
                    <div style="text-align: center; color: var(--text-muted); font-style: italic;">Нет урока</div>
                </td>
                <td style="background: var(--bg-card); padding: 15px; border-right: 1px solid var(--border-secondary); width: 200px;">
                    <div style="text-align: center; color: var(--text-muted); font-style: italic;">Нет урока</div>
                </td>
                <td style="background: var(--bg-card); padding: 15px; width: 200px;">
                    <div style="text-align: center; color: var(--text-muted); font-style: italic;">Нет урока</div>
                </td>
            </tr>
        </table>
        
        <!-- Уроки сегодня -->
        <table style="width: 100%; border-collapse: collapse;">
            <tr>
                <td rowspan="2" style="width: 200px; background: var(--accent-gradient); color: white; padding: 20px; 
                           font-weight: bold; font-size: 18px; text-align: center; vertical-align: middle; 
                           border-right: 2px solid var(--border-secondary);">
                    <span id="today_lessons_title">Уроки сегодня</span><br>
                    <span id="today_lessons_date" style="font-size: 14px; font-weight: normal;">(15.08.2025)</span>
                </td>
                
                <!-- Первая строка: 6 пустых ячеек -->
                <td style="background: var(--bg-card); padding: 15px; border-right: 1px solid var(--border-secondary); width: 200px;">
                    <div style="text-align: center; color: var(--text-muted); font-style: italic;">Нет урока</div>
                </td>
                <td style="background: var(--bg-card); padding: 15px; border-right: 1px solid var(--border-secondary); width: 200px;">
                    <div style="text-align: center; color: var(--text-muted); font-style: italic;">Нет урока</div>
                </td>
                <td style="background: var(--bg-card); padding: 15px; border-right: 1px solid var(--border-secondary); width: 200px;">
                    <div style="text-align: center; color: var(--text-muted); font-style: italic;">Нет урока</div>
                </td>
                <td style="background: var(--bg-card); padding: 15px; border-right: 1px solid var(--border-secondary); width: 200px;">
                    <div style="text-align: center; color: var(--text-muted); font-style: italic;">Нет урока</div>
                </td>
                <td style="background: var(--bg-card); padding: 15px; border-right: 1px solid var(--border-secondary); width: 200px;">
                    <div style="text-align: center; color: var(--text-muted); font-style: italic;">Нет урока</div>
                </td>
                <td style="background: var(--bg-card); padding: 15px; width: 200px;">
                    <div style="text-align: center; color: var(--text-muted); font-style: italic;">Нет урока</div>
                </td>
            </tr>
            <tr>
                <!-- Вторая строка: еще 6 пустых ячеек -->
                <td style="background: var(--bg-card); padding: 15px; border-right: 1px solid var(--border-secondary); width: 200px;">
                    <div style="text-align: center; color: var(--text-muted); font-style: italic;">Нет урока</div>
                </td>
                <td style="background: var(--bg-card); padding: 15px; border-right: 1px solid var(--border-secondary); width: 200px;">
                    <div style="text-align: center; color: var(--text-muted); font-style: italic;">Нет урока</div>
                </td>
                <td style="background: var(--bg-card); padding: 15px; border-right: 1px solid var(--border-secondary); width: 200px;">
                    <div style="text-align: center; color: var(--text-muted); font-style: italic;">Нет урока</div>
                </td>
                <td style="background: var(--bg-card); padding: 15px; border-right: 1px solid var(--border-secondary); width: 200px;">
                    <div style="text-align: center; color: var(--text-muted); font-style: italic;">Нет урока</div>
                </td>
                <td style="background: var(--bg-card); padding: 15px; border-right: 1px solid var(--border-secondary); width: 200px;">
                    <div style="text-align: center; color: var(--text-muted); font-style: italic;">Нет урока</div>
                </td>
                <td style="background: var(--bg-card); padding: 15px; width: 200px;">
                    <div style="text-align: center; color: var(--text-muted); font-style: italic;">Нет урока</div>
                </td>
            </tr>
        </table>
    </div>
<!-- Формы для работы с выбранным уроком -->
    <div id="lesson_forms" style="border: 2px solid var(--accent-color, #00d4ff); border-radius: 15px; padding: 25px; display: none;">
        <div id="selected_lesson_info" style="background: var(--accent-gradient); color: white; padding: 15px; border-radius: 10px; margin-bottom: 25px; text-align: center; font-weight: bold; font-size: 18px;">
            Выберите урок для работы
        </div>
        
        <!-- Форма отчета по уроку -->
        <div class="report-form" style="margin-bottom: 30px;">
            <h3 style="color: var(--text-accent); margin-bottom: 20px;">Отчет по уроку</h3>
            
            <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(250px, 1fr)); gap: 20px; margin-bottom: 20px;">
                <div>
                    <label>Тема урока:</label>
                    <input type="text" placeholder="Например: Квадратные уравнения" style="width: 100%;">
                </div>
                
                <div>
                    <label>Понимание темы:</label>
                    <select style="width: 100%;">
                        <option value="">-- Выберите уровень --</option>
                        <option value="Тема разобрана полностью">Тема разобрана полностью</option>
                        <option value="Есть вопросы по теме">Есть вопросы по теме</option>
                        <option value="Тему нужно закрепить">Тему нужно закрепить</option>
                    </select>
                </div>
            </div>
            
            <div style="margin-bottom: 20px;">
                <label>Комментарий преподавателя:</label>
                <textarea rows="3" placeholder="Подробный отзыв о работе ученика на уроке" style="width: 100%;"></textarea>
            </div>

            <!-- Кнопка пробник и баллы в одной строке -->
            <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 15px; margin-bottom: 20px;">
                <div>
                    <label style="visibility: hidden;">Пробник</label>
                    <button class="btn warning" onclick="openProbnikModal('report')" style="width: 100%;">Пробник</button>
                </div>
                
                <div>
                    <label>Первичные баллы:</label>
                    <input type="number" min="0" max="50" placeholder="0-50" style="width: 100%;">
                </div>
                
                <div>
                    <label>Вторичные баллы:</label>
                    <input type="number" min="0" max="100" placeholder="0-100" style="width: 100%;">
                </div>
            </div>
            
            <div style="text-align: center;">
                <button class="btn success" style="margin-right: 10px;" onclick="saveReport()">Сохранить отчет</button>
                <button class="btn danger">Удалить отчет</button>
            </div>
        </div>
        
        <!-- Форма домашнего задания -->
        <div class="homework-form" style="border-top: 2px solid var(--border-secondary); padding-top: 25px;">
            <h3 style="color: var(--text-accent); margin-bottom: 20px;">Домашнее задание</h3>
            
            <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 20px; margin-bottom: 20px;">
                <div>
                    <label>Тип домашнего задания:</label>
                    <select id="homework_type" onchange="toggleHomeworkFields()" style="width: 100%;">
                        <option value="">-- Выберите тип --</option>
                        <option value="tasks">Дать задачи</option>
                        <option value="none">Не задавать домашку</option>
                    </select>
                </div>
                
                <div id="homework_evaluation_fields" style="display: none;">
                    <label>Решение:</label>
                    <select style="width: 100%;">
                        <option value="">-- Выберите --</option>
                        <option value="1">1</option>
                        <option value="2">2</option>
                        <option value="3">3</option>
                        <option value="4">4</option>
                        <option value="5">5</option>
                        <option value="6">6</option>
                        <option value="7">7</option>
                        <option value="8">8</option>
                        <option value="9">9</option>
                        <option value="10">10</option>
                    </select>
                </div>
                
                <div id="homework_formatting_fields" style="display: none;">
                    <label>Оформление:</label>
                    <select style="width: 100%;">
                        <option value="">-- Выберите --</option>
                        <option value="1">1</option>
                        <option value="2">2</option>
                        <option value="3">3</option>
                        <option value="4">4</option>
                        <option value="5">5</option>
                        <option value="6">6</option>
                        <option value="7">7</option>
                        <option value="8">8</option>
                        <option value="9">9</option>
                        <option value="10">10</option>
                    </select>
                </div>
            </div>
            
            <div id="homework_content_fields" style="display: none;">
                <div style="margin-bottom: 20px;">
                    <label>Описание домашнего задания:</label>
                    <textarea rows="3" placeholder="Подробное описание заданий" style="width: 100%;"></textarea>
                </div>

                <!-- Кнопка пробник и баллы под описанием -->
                <div id="homework_probnik_fields" style="display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 15px; margin-bottom: 20px; display: none;">
                    <div>
                        <label style="visibility: hidden;">Пробник</label>
                        <button class="btn warning" onclick="openProbnikModal('homework')" style="width: 100%;">Пробник</button>
                    </div>
                    
                    <div>
                        <label>Первичные баллы:</label>
                        <input type="number" min="0" max="50" placeholder="0-50" style="width: 100%;">
                    </div>
                    
                    <div>
                        <label>Вторичные баллы:</label>
                        <input type="number" min="0" max="100" placeholder="0-100" style="width: 100%;">
                    </div>
                </div>
            </div>
            
            <div style="text-align: center;">
                <button class="btn success" style="margin-right: 10px;" onclick="saveHomework()">Сохранить домашку</button>
                <button class="btn warning">Отметить как проверенную</button>
            </div>
        </div>
    </div>
</div>

<!-- Таблица учеников -->
<div class="card" style="margin-bottom: 30px;">
    <h3 style="text-align: center; margin-bottom: 20px;">Аккаунты учеников</h3>
    
    {% if accounts_data %}
        <div style="overflow-x: auto;">
            <table class="accounts-table">
                <thead>
                    <tr>
                        <th>Ученик</th>
                        <th>Класс</th>
                        <th>Логин</th>
                        <th>Пароль</th>
                        <th>ЛКУ</th>
                    </tr>
                </thead>
                <tbody>
                    {% for account in accounts_data %}
                    <tr>
                        <td class="student-name">{{ account.student_name }}</td>
                        <td>{{ account.student_class }}</td>
                        
                        <!-- Логин ученика -->
                        <td class="login-cell">
                            {% if account.has_student_account %}
                                <span class="login-text">{{ account.student_login }}</span>
                            {% else %}
                                <span class="no-account">Нет аккаунта</span>
                            {% endif %}
                        </td>
                        
                        <!-- Пароль ученика -->
                        <td class="password-cell">
                            {% if account.has_student_account %}
                                <span class="password-text">{{ account.student_password }}</span>
                            {% else %}
                                <span class="no-account">Нет аккаунта</span>
                            {% endif %}
                        </td>
                        
                        <!-- Кнопка ЛКУ -->
                        <td class="action-cell">
                            {% if account.has_student_account %}
                                <a href="http://127.0.0.1:8080/admin-student/{{ account.student_id }}?token={{ admin_token }}" 
                                   class="icon-action icon-student" 
                                   title="Личный кабинет ученика">
                                    <svg viewBox="0 0 24 24" width="28" height="28" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                                        <path d="M20 21v-2a4 4 0 0 0-4-4H8a4 4 0 0 0-4 4v2"></path>
                                        <circle cx="12" cy="7" r="4"></circle>
                                    </svg>
                                </a>
                            {% else %}
                                <span class="no-account">—</span>
                            {% endif %}
                        </td>
                    </tr>
                    {% endfor %}
                </tbody>
            </table>
        </div>
    {% else %}
        <p style="text-align: center; color: var(--text-muted);">Нет учеников</p>
    {% endif %}
</div>

<!-- Таблица родителей -->
<div class="card">
    <h3 style="text-align: center; margin-bottom: 20px;">Аккаунты родителей</h3>
    
    {% if families_data %}
        <div style="overflow-x: auto;">
            <table class="accounts-table parents-table">
                <thead>
                    <tr>
                        <th>Родитель</th>
                        <th>Дети</th>
                        <th>Логин</th>
                        <th>Пароль</th>
                        <th>ЛКР</th>
                    </tr>
                </thead>
                <tbody>
                    {% for family in families_data %}
                    <tr>
                        <td class="parent-name">{{ family.parent_name }}</td>
                        <td class="children-list">
                            {% for child in family.children %}
                                <span class="child-tag">{{ child }}</span>{% if not loop.last %}, {% endif %}
                            {% endfor %}
                        </td>
                        
                        <!-- Логин родителя -->
                        <td class="login-cell">
                            {% if family.has_parent_account %}
                                <span class="login-text">{{ family.parent_login }}</span>
                            {% else %}
                                <span class="no-account">Нет аккаунта</span>
                            {% endif %}
                        </td>
                        
                        <!-- Пароль родителя -->
                        <td class="password-cell">
                            {% if family.has_parent_account %}
                                <span class="password-text">{{ family.parent_password }}</span>
                            {% else %}
                                <span class="no-account">Нет аккаунта</span>
                            {% endif %}
                        </td>
                        
                        <!-- Кнопка ЛКР -->
                        <td class="action-cell">
                            {% if family.has_parent_account %}
                                <a href="http://127.0.0.1:8080/admin-parent/{{ family.parent_name }}?token={{ admin_token }}" 
                                   class="icon-action icon-parent" 
                                   title="Личный кабинет родителя">
                                    <svg viewBox="0 0 24 24" width="28" height="28" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                                        <path d="M16 21v-2a4 4 0 0 0-4-4H6a4 4 0 0 0-4 4v2"></path>
                                        <circle cx="9" cy="7" r="4"></circle>
                                        <path d="M22 21v-2a4 4 0 0 0-3-3.87"></path>
                                        <path d="M16 3.13a4 4 0 0 1 0 7.75"></path>
                                    </svg>
                                </a>
                            {% else %}
                                <span class="no-account">—</span>
                            {% endif %}
                        </td>
                    </tr>
                    {% endfor %}
                </tbody>
            </table>
        </div>
    {% else %}
        <p style="text-align: center; color: var(--text-muted);">Нет родителей</p>
    {% endif %}
</div>
