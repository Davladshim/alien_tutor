{% extends "base.html" %}

{% block title %}Главная - Календаша{% endblock %}


{% block content %}

<div style="text-align: center; margin-bottom: 30px;">
    <h1>Админская панель</h1>
    <p style="color: var(--text-muted); font-size: 16px;">
        Управление учениками и быстрое добавление отчетов
    </p>
</div>

<!-- НОВАЯ СИСТЕМА ОТЧЕТОВ И ДОМАШЕК -->
<div style="margin-bottom: 30px;">
    <h2 style="margin-bottom: 25px; text-align: center;">Отчеты по урокам и домашние задания</h2>
    
    <!-- Блок выбора даты со счетчиком -->
    <div style="background: var(--bg-card); border-radius: 12px; padding: 20px; margin-bottom: 25px; border: 1px solid var(--border-secondary);">
        <div style="display: flex; justify-content: space-between; align-items: center; flex-wrap: wrap; gap: 15px;">

            <!-- Выбор даты -->
            <div style="flex: 1; min-width: 200px;">
                <label for="date_select" style="display: block; margin-bottom: 8px; font-weight: bold;">
                    Выбрать дату:
                </label>
                <input type="date" id="date_select" style="width: 100%; padding: 10px; border-radius: 8px; border: 1px solid var(--border-secondary);">
            </div>

            <!-- Выбор месяца для счетчиков -->
            <div style="min-width: 200px;">
                <label for="month_select" style="display: block; margin-bottom: 8px; font-weight: bold;">
                    Месяц для счетчиков:
                </label>
                <input type="month" id="month_select" style="width: 100%; padding: 10px; border-radius: 8px; border: 1px solid var(--border-secondary);">
            </div>
            
            <!-- Счетчик проблемных уроков -->
            <div style="text-align: center;">
                <div style="font-size: 14px; color: var(--text-muted); margin-bottom: 5px;">
                    Требуют внимания:
                </div>
                <div style="display: flex; gap: 15px; align-items: center;">
                    <div style="text-align: center;">
                        <div style="font-size: 24px; font-weight: bold; color: #ef4444;" id="homework_missing_count">
                            3
                        </div>
                        <div style="font-size: 12px; color: var(--text-muted);">
                            без домашки
                        </div>
                    </div>
                    <div style="font-size: 18px; color: var(--text-muted);">/</div>
                    <div style="text-align: center;">
                        <div style="font-size: 24px; font-weight: bold; color: #f59e0b;" id="homework_unchecked_count">
                            2
                        </div>
                        <div style="font-size: 12px; color: var(--text-muted);">
                            не проверены
                        </div>
                    </div>
                    <div style="font-size: 18px; color: var(--text-muted);">/</div>
                    <div style="text-align: center;">
                        <div style="font-size: 24px; font-weight: bold; color: #ef4444;" id="reports_missing_count">
                            1
                        </div>
                        <div style="font-size: 12px; color: var(--text-muted);">
                            без отчета
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
<!-- Блоки с уроками - НОВАЯ ВЕРСИЯ -->
<div style="margin-bottom: 30px;">
    
    <!-- УРОКИ ВЧЕРА -->
    <div style="margin-bottom: 25px; border: 1px solid var(--border-secondary); border-radius: 12px; overflow: hidden;">
        <!-- Заголовок вчера -->
        <div style="background: var(--accent-gradient); color: white; padding: 12px; text-align: center; font-weight: bold; font-size: 18px;">
            Уроки вчера <span id="yesterday_date" style="font-size: 16px; font-weight: normal;">(загрузка...)</span>
        </div>
        
        <!-- Сетка уроков вчера -->
        <div class="lessons-grid" id="yesterday_lessons_grid">
            <!-- 12 ячеек для уроков (заполняются JavaScript) -->
            <div class="lesson-cell empty-lesson">
                <div class="empty-lesson-text">Нет урока</div>
            </div>
            <div class="lesson-cell empty-lesson">
                <div class="empty-lesson-text">Нет урока</div>
            </div>
            <div class="lesson-cell empty-lesson">
                <div class="empty-lesson-text">Нет урока</div>
            </div>
            <div class="lesson-cell empty-lesson">
                <div class="empty-lesson-text">Нет урока</div>
            </div>
            <div class="lesson-cell empty-lesson">
                <div class="empty-lesson-text">Нет урока</div>
            </div>
            <div class="lesson-cell empty-lesson">
                <div class="empty-lesson-text">Нет урока</div>
            </div>
            <div class="lesson-cell empty-lesson" style="display: none;">
                <div class="empty-lesson-text">Нет урока</div>
            </div>
            <div class="lesson-cell empty-lesson" style="display: none;">
                <div class="empty-lesson-text">Нет урока</div>
            </div>
            <div class="lesson-cell empty-lesson" style="display: none;">
                <div class="empty-lesson-text">Нет урока</div>
            </div>
            <div class="lesson-cell empty-lesson" style="display: none;">
                <div class="empty-lesson-text">Нет урока</div>
            </div>
            <div class="lesson-cell empty-lesson" style="display: none;">
                <div class="empty-lesson-text">Нет урока</div>
            </div>
            <div class="lesson-cell empty-lesson" style="display: none;">
                <div class="empty-lesson-text">Нет урока</div>
            </div>
        </div>
    </div>
    
    <!-- УРОКИ СЕГОДНЯ -->
    <div style="border: 1px solid var(--border-secondary); border-radius: 12px; overflow: hidden;">
        <!-- Заголовок сегодня -->
        <div style="background: var(--accent-gradient); color: white; padding: 12px; text-align: center; font-weight: bold; font-size: 18px;">
            <span id="today_lessons_title">Уроки сегодня</span> <span id="today_lessons_date" style="font-size: 16px; font-weight: normal;">(загрузка...)</span>
        </div>
        
        <!-- Сетка уроков сегодня -->
        <div class="lessons-grid" id="today_lessons_grid">
            <!-- 12 ячеек для уроков (заполняются JavaScript) -->
            <div class="lesson-cell empty-lesson">
                <div class="empty-lesson-text">Нет урока</div>
            </div>
            <div class="lesson-cell empty-lesson">
                <div class="empty-lesson-text">Нет урока</div>
            </div>
            <div class="lesson-cell empty-lesson">
                <div class="empty-lesson-text">Нет урока</div>
            </div>
            <div class="lesson-cell empty-lesson">
                <div class="empty-lesson-text">Нет урока</div>
            </div>
            <div class="lesson-cell empty-lesson">
                <div class="empty-lesson-text">Нет урока</div>
            </div>
            <div class="lesson-cell empty-lesson">
                <div class="empty-lesson-text">Нет урока</div>
            </div>
            <div class="lesson-cell empty-lesson" style="display: none;">
                <div class="empty-lesson-text">Нет урока</div>
            </div>
            <div class="lesson-cell empty-lesson" style="display: none;">
                <div class="empty-lesson-text">Нет урока</div>
            </div>
            <div class="lesson-cell empty-lesson" style="display: none;">
                <div class="empty-lesson-text">Нет урока</div>
            </div>
            <div class="lesson-cell empty-lesson" style="display: none;">
                <div class="empty-lesson-text">Нет урока</div>
            </div>
            <div class="lesson-cell empty-lesson" style="display: none;">
                <div class="empty-lesson-text">Нет урока</div>
            </div>
            <div class="lesson-cell empty-lesson" style="display: none;">
                <div class="empty-lesson-text">Нет урока</div>
            </div>
        </div>
    </div>
</div>
<!-- Формы для работы с выбранным уроком -->
<div id="lesson_forms" style="border: 2px solid var(--accent-color, #00d4ff); border-radius: 15px; padding: 25px; display: none;">
    <div id="selected_lesson_info" style="background: var(--accent-gradient); color: white; padding: 15px; border-radius: 10px; margin-bottom: 25px; text-align: center; font-weight: bold; font-size: 18px;">
        Выберите урок для работы
    </div>
    
    <!-- ОБЪЕДИНЕННАЯ ФОРМА -->
    <div class="combined-form">
        
        <!-- СЕКЦИЯ ОТЧЕТА -->
        <div class="report-section" style="margin-bottom: 40px;">
            <h3 style="color: var(--text-accent); margin-bottom: 20px;">Отчет по уроку</h3>
            
            <div style="display: grid; grid-template-columns: 1fr 1fr auto; gap: 20px; align-items: end; margin-bottom: 20px;">
                <div>
                    <label>Тема урока:</label>
                    <input type="text" id="report_topic" placeholder="Например: Квадратные уравнения" style="width: 100%;">
                </div>
                
                <div>
                    <label>Понимание темы:</label>
                    <select id="report_understanding" style="width: 100%;">
                        <option value="">-- Выберите уровень --</option>
                        <option value="Тема разобрана полностью">Тема разобрана полностью</option>
                        <option value="Есть вопросы по теме">Есть вопросы по теме</option>
                        <option value="Тему нужно закрепить">Тему нужно закрепить</option>
                    </select>
                </div>
                
                <div>
                    <label style="visibility: hidden;">Удалить</label>
                    <span class="icon-action icon-delete" onclick="deleteReport()" title="Удалить отчет" style="cursor: pointer; align-self: center; margin-bottom: 23px; margin-left: 15px;">
                        <svg viewBox="0 0 24 24" width="28" height="28" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                            <polyline points="3,6 5,6 21,6"></polyline>
                            <path d="M19,6V20a2,2,0,0,1-2,2H7a2,2,0,0,1-2-2V6M8,6V4a2,2,0,0,1,2-2h4a2,2,0,0,1,2,2V6"></path>
                            <line x1="10" y1="11" x2="10" y2="17"></line>
                            <line x1="14" y1="11" x2="14" y2="17"></line>
                        </svg>
                    </span>
                </div>
            </div>
            
            <div style="margin-bottom: 20px;">
                <label>Комментарий преподавателя:</label>
                <textarea id="report_comment" rows="3" placeholder="Подробный отзыв о работе ученика на уроке" style="width: 100%;"></textarea>
            </div>

            <!-- Кнопка пробник и баллы в одной строке -->
            <div style="display: flex; justify-content: space-between; align-items: end; margin-bottom: 20px;">
                <div style="display: flex; gap: 15px; align-items: end;">
                    <div>
                        <label style="visibility: hidden;">Пробник</label>
                        <span class="icon-action" onclick="openProbnikModal('report')" title="Открыть пробник" style="cursor: pointer; align-self: center; margin-bottom: 23px; display: flex; justify-content: center;">
                            <svg viewBox="0 0 24 24" width="28" height="28" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                                <circle cx="11" cy="11" r="8"></circle>
                                <path d="M21 21l-4.35-4.35"></path>
                            </svg>
                        </span>
                    </div>
                    
                    <div>
                        <label>Первичные баллы:</label>
                        <input type="number" id="report_primary_score" min="0" max="50" placeholder="0-50" style="width: 200px;">
                    </div>
                    
                    <div>
                        <label>Вторичные баллы:</label>
                        <input type="number" id="report_secondary_score" min="0" max="100" placeholder="0-100" style="width: 200px;">
                    </div>
                </div>
                
                <div>
                    <label style="visibility: hidden;">Сохранить</label>
                    <span class="icon-action icon-save" onclick="saveReport()" title="Сохранить отчет" style="cursor: pointer; align-self: center; margin-bottom: 23px; margin-left: 40px;">
                        <svg viewBox="0 0 24 24" width="28" height="28" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                            <polyline points="20,6 9,17 4,12"></polyline>
                        </svg>
                    </span>
                </div>
            </div>
        
        <!-- РАЗДЕЛИТЕЛЬ -->
        <div style="border-top: 2px solid var(--border-secondary); margin: 30px 0;"></div>
        
        <!-- СЕКЦИЯ ДОМАШКИ -->
        <div class="homework-section">
            <!-- Заголовок и выбор типа в одной строке -->
            <div style="display: flex; align-items: baseline; justify-content: space-between; margin-bottom: 20px;">
                <div style="display: flex; align-items: baseline; gap: 30px;">
                    <h3 style="color: var(--text-accent); margin: 0;">Домашнее задание</h3>
                    
                    <div style="display: flex; gap: 40px; align-items: baseline;">
                        <label style="display: flex; align-items: baseline; cursor: pointer; white-space: nowrap;">
                            <input type="radio" name="homework_type" value="tasks" id="homework_type_tasks" onchange="toggleHomeworkFields()" checked style="margin-right: 10px; margin-top: 0; vertical-align: baseline; width: 15px; height: 15px;">
                            <span>Дать задания</span>
                        </label>
                        
                        <label style="display: flex; align-items: baseline; cursor: pointer; white-space: nowrap;">
                            <input type="radio" name="homework_type" value="none" id="homework_type_none" onchange="toggleHomeworkFields()" style="margin-right: 10px; margin-top: 0; vertical-align: baseline; width: 15px; height: 15px;">
                            <span>Не задавать ДЗ</span>
                        </label>
                    </div>
                </div>
                
                <span class="icon-action icon-delete" onclick="deleteHomework()" title="Удалить домашнее задание" style="cursor: pointer;">
                    <svg viewBox="0 0 24 24" width="28" height="28" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                        <polyline points="3,6 5,6 21,6"></polyline>
                        <path d="M19,6V20a2,2,0,0,1-2,2H7a2,2,0,0,1-2-2V6M8,6V4a2,2,0,0,1,2-2h4a2,2,0,0,1,2,2V6"></path>
                        <line x1="10" y1="11" x2="10" y2="17"></line>
                        <line x1="14" y1="11" x2="14" y2="17"></line>
                    </svg>
                </span>
            </div>
            
            <!-- ПОЛЯ ОЦЕНОК (отдельный блок) -->
            <div id="homework_evaluation_fields" style="display: none;">
                <div style="display: grid; grid-template-columns: repeat(4, 1fr); gap: 20px; margin-bottom: 20px;">
                    <!-- Решение -->
                    <div>
                        <label>Решение:</label>
                        <select id="homework_solution_score" style="width: 100%;">
                            <option value="">-- Выберите --</option>
                            <option value="1">1</option>
                            <option value="2">2</option>
                            <option value="3">3</option>
                            <option value="4">4</option>
                            <option value="5">5</option>
                            <option value="6">6</option>
                            <option value="7">7</option>
                            <option value="8">8</option>
                            <option value="9">9</option>
                            <option value="10">10</option>
                        </select>
                    </div>
                    
                    <!-- Оформление -->
                    <div>
                        <label>Оформление:</label>
                        <select id="homework_formatting_score" style="width: 100%;">
                            <option value="">-- Выберите --</option>
                            <option value="1">1</option>
                            <option value="2">2</option>
                            <option value="3">3</option>
                            <option value="4">4</option>
                            <option value="5">5</option>
                            <option value="6">6</option>
                            <option value="7">7</option>
                            <option value="8">8</option>
                            <option value="9">9</option>
                            <option value="10">10</option>
                        </select>
                    </div>
                    
                    <!-- Сколько задано -->
                    <div>
                        <label>Сколько задано:</label>
                        <select id="homework_tasks_assigned" onchange="handleTasksAssignedChange()" style="width: 100%;">
                            <option value="">-- Выберите --</option>
                            <option value="1">1</option>
                            <option value="2">2</option>
                            <option value="3">3</option>
                            <option value="4">4</option>
                            <option value="5">5</option>
                            <option value="6">6</option>
                            <option value="7">7</option>
                            <option value="8">8</option>
                            <option value="9">9</option>
                            <option value="10">10</option>
                            <option value="other">Другое</option>
                        </select>
                        <input type="number" id="homework_tasks_assigned_custom" placeholder="Введите число" 
                            style="width: 100%; margin-top: 5px; display: none;" min="1" max="100">
                    </div>
                    
                    <!-- Сколько решено -->
                    <div>
                        <label>Сколько решено:</label>
                        <select id="homework_tasks_solved" onchange="handleTasksSolvedChange()" style="width: 100%;">
                            <option value="">-- Выберите --</option>
                            <option value="1">1</option>
                            <option value="2">2</option>
                            <option value="3">3</option>
                            <option value="4">4</option>
                            <option value="5">5</option>
                            <option value="6">6</option>
                            <option value="7">7</option>
                            <option value="8">8</option>
                            <option value="9">9</option>
                            <option value="10">10</option>
                            <option value="other">Другое</option>
                        </select>
                        <input type="number" id="homework_tasks_solved_custom" placeholder="Введите число" 
                            style="width: 100%; margin-top: 5px; display: none;" min="0" max="100">
                    </div>
                </div>
            </div>
            
            <!-- ОПИСАНИЕ ДОМАШКИ (отдельный блок) -->
            <div id="homework_content_fields" style="display: none;">
                <div style="margin-bottom: 20px;">
                    <label>Описание домашнего задания:</label>
                    <textarea id="homework_description" rows="3" placeholder="Подробное описание заданий" style="width: 100%;"></textarea>
                </div>

                <!-- Кнопка пробник и баллы под описанием -->
                <div id="homework_probnik_fields" style="display: flex; justify-content: space-between; align-items: end; margin-bottom: 20px;">
                    <div style="display: flex; gap: 15px; align-items: end;">
                        <div>
                            <label style="visibility: hidden;">Пробник</label>
                            <span class="icon-action" onclick="openProbnikModal('homework')" title="Открыть пробник" style="cursor: pointer; margin-bottom: 12px; display: flex; justify-content: center;">
                                <svg viewBox="0 0 24 24" width="28" height="28" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                                    <circle cx="11" cy="11" r="8"></circle>
                                    <path d="M21 21l-4.35-4.35"></path>
                                </svg>
                            </span>
                        </div>
                        
                        <div>
                            <label>Первичные баллы:</label>
                            <input type="number" id="homework_primary_score" min="0" max="50" placeholder="0-50" style="width: 200px;">
                        </div>
                        
                        <div>
                            <label>Вторичные баллы:</label>
                            <input type="number" id="homework_secondary_score" min="0" max="100" placeholder="0-100" style="width: 200px;">
                        </div>
                    </div>
                    
                    <div style="display: flex; gap: 20px; align-items: end;">
                        <div>
                            <label style="visibility: hidden;">Сохранить</label>
                            <span class="icon-action" onclick="saveHomework()" title="Сохранить домашнее задание" style="cursor: pointer; margin-bottom: 8px;">
                                <svg viewBox="0 0 24 24" width="28" height="28" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                                    <line x1="12" y1="19" x2="12" y2="5"></line>
                                    <polyline points="5,12 12,5 19,12"></polyline>
                                </svg>
                            </span>
                        </div>
                        
                        <div>
                            <label style="visibility: hidden;">Проверить</label>
                            <span class="icon-action icon-save" onclick="markHomeworkChecked()" title="Отметить как проверенную" style="cursor: pointer; margin-bottom: 8px;">
                                <svg viewBox="0 0 24 24" width="28" height="28" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                                    <polyline points="20,6 9,17 4,12"></polyline>
                                </svg>
                            </span>
                        </div>
                    </div>
                </div>
            </div>
        </div>
        
    </div> <!-- конец combined-form -->
</div>

<!-- Таблица учеников -->
<h3 style="text-align: center; margin-bottom: 20px;">Аккаунты учеников</h3>

{% if accounts_data %}
    <div style="overflow-x: auto;">
        <table class="accounts-table">
            <thead>
                <tr>
                    <th>Ученик</th>
                    <th>Класс</th>
                    <th>Логин</th>
                    <th>Пароль</th>
                    <th>Действия</th>
                </tr>
            </thead>
            <tbody>
                {% for account in accounts_data %}
                <tr>
                    <td class="student-name">{{ account.student_name }}</td>
                    <td>{{ account.student_class }}</td>
                    
                    <!-- Логин ученика -->
                    <td class="login-cell">
                        {% if account.has_student_account %}
                            <span class="login-text">{{ account.student_login }}</span>
                        {% else %}
                            <span class="no-account">Нет аккаунта</span>
                        {% endif %}
                    </td>
                    
                    <!-- Пароль ученика -->
                    <td class="password-cell">
                        {% if account.has_student_account %}
                            <span class="password-text">{{ account.student_password }}</span>
                        {% else %}
                            <span class="no-account">Нет аккаунта</span>
                        {% endif %}
                    </td>
                    
                    <!-- Кнопка ЛКУ -->
                    <td class="action-cell">
                        {% if account.has_student_account %}
                            <div style="display: flex; gap: 25px; align-items: center;">
                                <!-- Кнопка копирования -->
                                <a onclick="copyLoginPassword('{{ account.student_login }}', '{{ account.student_password }}'); return false;" 
                                href="#"
                                class="icon-action" 
                                title="Копировать логин и пароль">
                                    <svg viewBox="0 0 24 24" width="28" height="28" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                                        <rect x="9" y="9" width="13" height="13" rx="2" ry="2"></rect>
                                        <path d="M5 15H4a2 2 0 0 1-2-2V4a2 2 0 0 1 2-2h9a2 2 0 0 1 2 2v1"></path>
                                    </svg>
                                </button>
                                
                                <!-- Кнопка ЛКУ -->
                                <a href="http://127.0.0.1:8080/admin-student/{{ account.student_id }}?token={{ admin_token }}" 
                                class="icon-action"
                                title="Личный кабинет ученика"
                                target="_blank">
                                    <svg viewBox="0 0 24 24" width="28" height="28" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                                        <path d="M20 21v-2a4 4 0 0 0-4-4H8a4 4 0 0 0-4 4v2"></path>
                                        <circle cx="12" cy="7" r="4"></circle>
                                    </svg>
                                </a>
                            </div>
                        {% else %}
                            <span class="no-account">—</span>
                        {% endif %}
                    </td>
                </tr>
                {% endfor %}
            </tbody>
        </table>
    </div>
{% else %}
    <p style="text-align: center; color: var(--text-muted);">Нет учеников</p>
{% endif %}

<!-- Таблица родителей -->
<h3 style="text-align: center; margin-bottom: 20px;">Аккаунты родителей</h3>

{% if families_data %}
    <div style="overflow-x: auto;">
        <table class="accounts-table parents-table">
            <thead>
                <tr>
                    <th>Родитель</th>
                    <th>Дети</th>
                    <th>Логин</th>
                    <th>Пароль</th>
                    <th>Действия</th>
                </tr>
            </thead>
            <tbody>
                {% for family in families_data %}
                <tr>
                    <td class="parent-name">{{ family.parent_name }}</td>
                    <td class="children-list">
                        {% for child in family.children %}
                            <span class="child-tag">{{ child }}</span>{% if not loop.last %}, {% endif %}
                        {% endfor %}
                    </td>
                    
                    <!-- Логин родителя -->
                    <td class="login-cell">
                        {% if family.has_parent_account %}
                            <span class="login-text">{{ family.parent_login }}</span>
                        {% else %}
                            <span class="no-account">Нет аккаунта</span>
                        {% endif %}
                    </td>
                    
                    <!-- Пароль родителя -->
                    <td class="password-cell">
                        {% if family.has_parent_account %}
                            <span class="password-text">{{ family.parent_password }}</span>
                        {% else %}
                            <span class="no-account">Нет аккаунта</span>
                        {% endif %}
                    </td>
                    
                    <!-- Кнопка ЛКР -->
                    <td class="action-cell">
                        {% if family.has_parent_account %}
                            <div style="display: flex; gap: 25px; align-items: center;">
                                <!-- Кнопка копирования -->
                                <a onclick="copyLoginPassword('{{ family.parent_login }}', '{{ family.parent_password }}'); return false;" 
                                href="#"
                                class="icon-action" 
                                title="Копировать логин и пароль">
                                    <svg viewBox="0 0 24 24" width="28" height="28" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                                        <rect x="9" y="9" width="13" height="13" rx="2" ry="2"></rect>
                                        <path d="M5 15H4a2 2 0 0 1-2-2V4a2 2 0 0 1 2-2h9a2 2 0 0 1 2 2v1"></path>
                                    </svg>
                                </button>
                                
                                <!-- Кнопка ЛКР -->
                                <a href="http://127.0.0.1:8080/admin-parent/{{ family.parent_name }}?token={{ admin_token }}" 
                                class="icon-action" 
                                title="Личный кабинет родителя"
                                target="_blank">
                                    <svg viewBox="0 0 24 24" width="28" height="28" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                                        <path d="M16 21v-2a4 4 0 0 0-4-4H6a4 4 0 0 0-4 4v2"></path>
                                        <circle cx="9" cy="7" r="4"></circle>
                                        <path d="M22 21v-2a4 4 0 0 0-3-3.87"></path>
                                        <path d="M16 3.13a4 4 0 0 1 0 7.75"></path>
                                    </svg>
                                </a>
                            </div>
                        {% else %}
                            <span class="no-account">—</span>
                        {% endif %}
                    </td>
                </tr>
                {% endfor %}
            </tbody>
        </table>
    </div>
{% else %}
    <p style="text-align: center; color: var(--text-muted);">Нет родителей</p>
{% endif %}

<!-- Админ-функции -->
<div class="card" style="margin-top: 30px; border: 2px solid #ef4444;">
    <h3 style="text-align: center; margin-bottom: 20px; color: #ffffff; background: var(--danger-gradient); padding: 15px; border-radius: 12px; box-shadow: 0 4px 15px rgba(239, 68, 68, 0.3);">⚠️ Опасные админ-функции</h3>
    
    <div style="background: rgba(239, 68, 68, 0.1); padding: 20px; border-radius: 12px; margin-bottom: 20px;">
        <p style="color: #ffffff; text-align: center; font-weight: bold; margin-bottom: 10px;">
            🚨 ВНИМАНИЕ! Эти функции удаляют данные без возможности восстановления!
        </p>
        <p style="color: var(--text-muted); text-align: center; font-size: 14px;">
            Используйте только если точно знаете, что делаете
        </p>
    </div>
    
    <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(250px, 1fr)); gap: 20px;">
        
        <!-- Очистить все расписание -->
        <div style="text-align: center;">
            <button onclick="confirmClearSchedule()" 
                    style="background: var(--danger-gradient); color: white; padding: 15px 20px; 
                        border: none; border-radius: 12px; cursor: pointer; width: 100%; 
                        font-weight: bold; box-shadow: 0 4px 15px rgba(239, 68, 68, 0.3);">
                🗑️ Очистить все расписание
            </button>
            <p style="font-size: 12px; color: var(--text-muted); margin-top: 8px;">
                Удалит все уроки, платежи и отчеты
            </p>
        </div>
        
        <!-- Пересоздать аккаунты -->
        <div style="text-align: center;">
            <button onclick="confirmRecreateAccounts()" 
                    style="background: var(--danger-gradient); color: white; padding: 15px 20px; 
                        border: none; border-radius: 12px; cursor: pointer; width: 100%; 
                        font-weight: bold; box-shadow: 0 4px 15px rgba(239, 68, 68, 0.3);">
                🔄 Пересоздать все аккаунты
            </button>
            <p style="font-size: 12px; color: var(--text-muted); margin-top: 8px;">
                Удалит все логины/пароли и создаст новые
            </p>
        </div>
        
        <!-- Удалить отчеты -->
        <div style="text-align: center;">
            <button onclick="confirmClearReports()" 
                    style="background: var(--danger-gradient); color: white; padding: 15px 20px; 
                        border: none; border-radius: 12px; cursor: pointer; width: 100%; 
                        font-weight: bold; box-shadow: 0 4px 15px rgba(239, 68, 68, 0.3);">
                🗑️ Удалить все отчеты
            </button>
            <p style="font-size: 12px; color: var(--text-muted); margin-top: 8px;">
                Удалит все отчеты по урокам
            </p>
        </div>
        
        <!-- Удалить домашки -->
        <div style="text-align: center;">
            <button onclick="confirmClearHomework()" 
                    style="background: var(--danger-gradient); color: white; padding: 15px 20px; 
                        border: none; border-radius: 12px; cursor: pointer; width: 100%; 
                        font-weight: bold; box-shadow: 0 4px 15px rgba(239, 68, 68, 0.3);">
                📚 Удалить все домашки
            </button>
            <p style="font-size: 12px; color: var(--text-muted); margin-top: 8px;">
                Удалит все домашние задания
            </p>
        </div>
        
    </div>
</div>

<script>
function confirmRecreateAccounts() {
    if (confirm('⚠️ ВЫ УВЕРЕНЫ?\n\nЭто действие:\n- Удалит ВСЕ существующие логины и пароли\n- Создаст новые аккаунты для всех учеников\n- Восстановить старые данные будет НЕВОЗМОЖНО\n\nПродолжить?')) {
        if (confirm('🔴 ПОСЛЕДНЕЕ ПРЕДУПРЕЖДЕНИЕ!\n\nВсе ученики и родители потеряют доступ к своим аккаунтам!\nВам придется сообщить им новые пароли.\n\nТочно продолжить?')) {
            window.location.href = '/пересоздать-все-аккаунты';
        }
    }
}

function confirmClearReports() {
    if (confirm('⚠️ Удалить ВСЕ отчеты по урокам?\n\nЭто действие нельзя отменить!')) {
        if (confirm('🔴 Точно удалить? Все отчеты будут потеряны навсегда!')) {
            window.location.href = '/admin/clear-all-reports';
        }
    }
}

function confirmClearHomework() {
    if (confirm('⚠️ Удалить ВСЕ домашние задания?\n\nЭто действие нельзя отменить!')) {
        if (confirm('🔴 Точно удалить? Все домашки будут потеряны навсегда!')) {
            window.location.href = '/admin/clear-all-homework';
        }
    }
}

function confirmClearSchedule() {
    if (confirm('⚠️ ОЧИСТИТЬ ВСЁ РАСПИСАНИЕ?\n\nЭто действие:\n- Удалит ВСЕ уроки\n- Удалит ВСЕ платежи\n- Удалит ВСЕ отчеты\n- Удалит ВСЕ домашки\n- Удалит шаблон недели\n\nВосстановить данные будет НЕВОЗМОЖНО!\n\nПродолжить?')) {
        if (confirm('🔴 ПОСЛЕДНЕЕ ПРЕДУПРЕЖДЕНИЕ!\n\nВы точно хотите удалить ВСЁ?\nЭто действие нельзя отменить!')) {
            // Создаем форму для POST запроса
            const form = document.createElement('form');
            form.method = 'POST';
            form.action = '/админ/очистить-расписание';
            form.style.display = 'none';
            document.body.appendChild(form);
            form.submit();
        }
    }
}

</script>

<script>
// Переменная для хранения выбранного урока
let selectedLesson = null;

let currentMode = 'report'; // НОВАЯ СТРОКА

// НОВАЯ ФУНКЦИЯ - добавь её после переменных, но перед function selectLesson
function switchMode(mode) {
    currentMode = mode;
    
    // Переключаем активные кнопки
    document.getElementById('report_mode').classList.remove('active');
    document.getElementById('homework_mode').classList.remove('active');
    document.getElementById(mode + '_mode').classList.add('active');
    
    // Перекрашиваем все уроки согласно новому режиму
    updateLessonsColors();
    
    // Показываем нужную форму
    updateFormsVisibility();

}

function updateLessonsColors() {
    // Просто перезагружаем данные с сервера для текущей даты
    const selectedDate = document.getElementById('date_select').value;
    
    if (selectedDate) {
        console.log('Перекрашиваем уроки');
        loadLessonsForDate(selectedDate);
        
        // И загружаем вчерашние если это сегодня
        if (selectedDate === new Date().toISOString().split('T')[0]) {
            const yesterday = new Date();
            yesterday.setDate(yesterday.getDate() - 1);
            const yesterdayStr = yesterday.toISOString().split('T')[0];
            loadYesterdayLessons(yesterdayStr);
        }
    }
}

function updateLessonColorForReport(lesson) {
    // Красный = урок проведен, отчет не добавлен
    lesson.style.background = 'linear-gradient(135deg, rgba(239, 68, 68, 0.2), rgba(127, 29, 29, 0.2))';
    lesson.style.borderLeftColor = '#ef4444';
    
    // Обновляем текст статуса
    const statusDiv = lesson.querySelector('div:last-child');
    statusDiv.innerHTML = '<span style="color: #ef4444; font-weight: bold;">Нет отчета</span>';
}

function updateLessonColorForHomework(lesson) {
    // Желтый = урок проведен, домашка задана, но не проверена  
    lesson.style.background = 'linear-gradient(135deg, rgba(245, 158, 11, 0.2), rgba(217, 119, 6, 0.2))';
    lesson.style.borderLeftColor = '#f59e0b';
    
    // Обновляем текст статуса
    const statusDiv = lesson.querySelector('div:last-child');
    statusDiv.innerHTML = '<span style="color: #f59e0b; font-weight: bold;">Не проверена</span>';
}

function updateFormsVisibility() {
    const lessonForms = document.getElementById('lesson_forms');
    
    if (!lessonForms || lessonForms.style.display === 'none') {
        return; // Если формы скрыты, ничего не делаем
    }
    
    // Находим блоки форм
    const reportForm = lessonForms.querySelector('.report-form');
    const homeworkForm = lessonForms.querySelector('.homework-form');
    
    if (currentMode === 'report') {
        // Показываем только форму отчета
        if (reportForm) reportForm.style.display = 'block';
        if (homeworkForm) homeworkForm.style.display = 'none';
    } else {
        // Показываем только форму домашки
        if (reportForm) reportForm.style.display = 'none';
        if (homeworkForm) homeworkForm.style.display = 'block';
    }
}

function updateStaticDates() {
    // Получаем реальные даты
    const today = new Date();
    const yesterday = new Date(today);
    yesterday.setDate(today.getDate() - 1);
    
    // Форматируем для отображения (ДД.ММ.ГГГГ)
    const todayFormatted = today.toLocaleDateString('ru-RU');
    const yesterdayFormatted = yesterday.toLocaleDateString('ru-RU');
    
    // Обновляем заголовки
    document.getElementById('yesterday_date').textContent = `(${yesterdayFormatted})`;
    document.getElementById('today_lessons_date').textContent = `(${todayFormatted})`;
    
    console.log('Даты обновлены:', yesterdayFormatted, 'и', todayFormatted);
}

function updateDateDisplay(selectedDate) {
    const titleElement = document.getElementById('today_lessons_title');
    const dateElement = document.getElementById('today_lessons_date');
    
    // Обновляем дату "вчера" 
    const yesterdayElement = document.getElementById('yesterday_date');
    
    // Вычисляем вчерашнюю дату относительно выбранной
    const selectedDateObj = new Date(selectedDate);
    selectedDateObj.setDate(selectedDateObj.getDate() - 1);
    const yesterdayFormatted = selectedDateObj.toLocaleDateString('ru-RU');
    
    // Обновляем отображение вчерашней даты
    yesterdayElement.textContent = `(${yesterdayFormatted})`;
    
    // Форматируем дату для отображения
    let displayDate, displayTitle;
    
    const today = new Date().toISOString().split('T')[0];
    
    if (selectedDate === today) {
        // Это сегодня
        displayTitle = 'Уроки сегодня';
        displayDate = '(сегодня)';
    } else {
        // Другая дата
        const dateObj = new Date(selectedDate);
        const day = dateObj.getDate().toString().padStart(2, '0');
        const month = (dateObj.getMonth() + 1).toString().padStart(2, '0');
        const year = dateObj.getFullYear();
        
        displayTitle = 'Уроки';
        displayDate = `(${day}.${month}.${year})`;
    }
    
    titleElement.textContent = displayTitle;
    dateElement.textContent = displayDate;
}

function loadRealCounters(selectedMonth = null) {
    console.log('🔢 Загружаем реальные счетчики для месяца:', selectedMonth);
    
    // Если месяц не указан, берем текущий
    if (!selectedMonth) {
        const today = new Date();
        selectedMonth = today.getFullYear() + '-' + (today.getMonth() + 1).toString().padStart(2, '0');
    }
    
    fetch(`/api/get-counters?month=${selectedMonth}`)
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            console.log('✅ Счетчики загружены:', data.counters);
            
            // Обновляем отображение
            document.getElementById('homework_missing_count').textContent = data.counters.homework_missing;
            document.getElementById('homework_unchecked_count').textContent = data.counters.homework_unchecked;
            document.getElementById('reports_missing_count').textContent = data.counters.reports_missing;
        } else {
            console.error('❌ Ошибка загрузки счетчиков:', data.error);
            
            // Показываем ошибку вместо цифр
            document.getElementById('homework_missing_count').textContent = '?';
            document.getElementById('homework_unchecked_count').textContent = '?';
            document.getElementById('reports_missing_count').textContent = '?';
        }
    })
    .catch(error => {
        console.error('❌ Сетевая ошибка при загрузке счетчиков:', error);
        
        // Показываем ошибку
        document.getElementById('homework_missing_count').textContent = '!';
        document.getElementById('homework_unchecked_count').textContent = '!';
        document.getElementById('reports_missing_count').textContent = '!';
    });
}

function loadLessonsForDate(date) {
    console.log('Загружаем уроки для даты:', date);
    
    fetch(`/api/get-lessons/${date}`)
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            updateLessonsDisplay(data.lessons, date);
        } else {
            console.error('Ошибка загрузки уроков:', data.error);
        }
    })
    .catch(error => {
        console.error('Ошибка:', error);
    });
}

function loadYesterdayLessons(date) {
    fetch(`/api/get-lessons/${date}`)
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            updateYesterdayLessonsDisplay(data.lessons);
        }
    })
    .catch(error => console.error('Ошибка загрузки вчерашних уроков:', error));
}

function updateYesterdayLessonsDisplay(lessons) {
    // Сохраняем вчерашние данные
    window.yesterdayLessonsData = lessons;
    
    console.log('Вчерашние уроки:', lessons);
    
    // Находим сетку вчерашних уроков
    const yesterdayGrid = document.getElementById('yesterday_lessons_grid');
    const yesterdayCells = yesterdayGrid.querySelectorAll('.lesson-cell');
    
    // Сначала скрываем все ячейки после 6-й
    yesterdayCells.forEach((cell, index) => {
        if (index >= 6) {
            cell.style.display = 'none';
        } else {
            cell.style.display = 'flex';
        }
    });
    
    // Показываем вторую строку если уроков больше 6
    if (lessons.length > 6) {
        yesterdayCells.forEach((cell, index) => {
            if (index >= 6) {
                cell.style.display = 'flex';
            }
        });
    }
    
    // Очищаем все ячейки
    yesterdayCells.forEach(cell => {
        cell.className = 'lesson-cell empty-lesson';
        cell.innerHTML = '<div class="empty-lesson-text">Нет урока</div>';
        cell.onclick = null;
        cell.style.cursor = 'default';
    });
    
    // Заполняем реальными уроками (максимум 12)
    lessons.slice(0, 12).forEach((lesson, index) => {
        const cell = yesterdayCells[index];
        if (cell) {
            const statusInfo = getLessonStatusInfo(lesson);
            
            cell.className = 'lesson-cell has-lesson';
            cell.innerHTML = `
                <div class="lesson-time">${lesson.time}</div>
                <div class="lesson-student">${lesson.student}</div>
                <div class="lesson-subject">${lesson.subject}</div>
                <div class="lesson-status" style="color: ${statusInfo.color};">${statusInfo.text}</div>
            `;
            
            cell.style.background = statusInfo.background;
            cell.style.borderLeftColor = statusInfo.borderColor;
            cell.onclick = () => selectLesson(lesson.id);
            cell.style.cursor = 'pointer';
        }
    });
}

function updateLessonsDisplay(lessons, date) {
    // Сохраняем данные для заполнения форм
    window.currentLessonsData = lessons;
    
    // Обновляем заголовок
    updateDateDisplay(date);
    
    // Находим сетку сегодняшних уроков
    const todayGrid = document.getElementById('today_lessons_grid');
    const todayCells = todayGrid.querySelectorAll('.lesson-cell');
    
    // Сначала скрываем все ячейки после 6-й
    todayCells.forEach((cell, index) => {
        if (index >= 6) {
            cell.style.display = 'none';
        } else {
            cell.style.display = 'flex';
        }
    });
    
    // Показываем вторую строку если уроков больше 6
    if (lessons.length > 6) {
        todayCells.forEach((cell, index) => {
            if (index >= 6) {
                cell.style.display = 'flex';
            }
        });
    }
    
    // Очищаем все ячейки
    todayCells.forEach(cell => {
        cell.className = 'lesson-cell empty-lesson';
        cell.innerHTML = '<div class="empty-lesson-text">Нет урока</div>';
        cell.onclick = null;
        cell.style.cursor = 'default';
    });
    
    // Заполняем реальными уроками (максимум 12)
    lessons.slice(0, 12).forEach((lesson, index) => {
        const cell = todayCells[index];
        if (cell) {
            const statusInfo = getLessonStatusInfo(lesson);
            
            cell.className = 'lesson-cell has-lesson';
            cell.innerHTML = `
                <div class="lesson-time">${lesson.time}</div>
                <div class="lesson-student">${lesson.student}</div>
                <div class="lesson-subject">${lesson.subject}</div>
                <div class="lesson-status" style="color: ${statusInfo.color};">${statusInfo.text}</div>
            `;
            
            cell.style.background = statusInfo.background;
            cell.style.borderLeftColor = statusInfo.borderColor;
            cell.onclick = () => selectLesson(lesson.id);
            cell.style.cursor = 'pointer';
        }
    });
}

function getLessonStatusInfo(lesson) {
    if (lesson.status === 'scheduled') {
        // Синий для запланированных
        return {
            color: '#0ea5e9',
            text: '⏰ Запланирован',
            background: 'linear-gradient(135deg, rgba(14, 165, 233, 0.15), rgba(2, 132, 199, 0.15))',
            borderColor: '#0ea5e9'
        };
    }
    
    if (lesson.status === 'completed') {
        // Определяем статус отчета
        let reportEmoji = lesson.has_report ? '✅' : '❌';
        
        // Определяем статус домашки
        let homeworkEmoji = '❌'; // по умолчанию нет домашки
        
        if (lesson.has_homework) {
            if (lesson.homework_type === 'none') {
                // Осознанно не задано - галочка
                homeworkEmoji = '✅';
            } else if (lesson.homework_checked) {
                // Задано и проверено - галочка
                homeworkEmoji = '✅';
            } else {
                // Задано, но не проверено - песочные часы
                homeworkEmoji = '⏳';
            }
        }
        
        // Голубой цвет для всех завершенных уроков
        return {
            color: '#D9F6F4', // светлый цвет из твоих CSS переменных
            text: `${reportEmoji} Отчет  ${homeworkEmoji} Домашка`,
            background: 'linear-gradient(135deg, rgba(0, 212, 255, 0.2), rgba(30, 58, 138, 0.2))',
            borderColor: '#00d4ff'
        };
    }
    
    // Серый для отмененных
    return {
        color: '#6b7280',
        text: '⏸️ Отменен',
        background: 'linear-gradient(135deg, rgba(107, 114, 128, 0.15), rgba(75, 85, 99, 0.15))',
        borderColor: '#6b7280'
    };
}

function fillFormWithExistingData(lesson) {
    console.log('Заполняем форму данными урока:', lesson);
    
    // === ОЧИЩАЕМ ВСЕ ПОЛЯ СНАЧАЛА ===
    clearAllFormFields();
    
    // === ЗАПОЛНЯЕМ ОТЧЕТ ===
    if (lesson.report_data) {
        console.log('Найден отчет, заполняем поля:', lesson.report_data);
        
        document.getElementById('report_topic').value = lesson.report_data.topic || '';
        document.getElementById('report_understanding').value = lesson.report_data.understanding_level || '';
        document.getElementById('report_comment').value = lesson.report_data.teacher_comment || '';
        
        // Пока баллы не добавляем - добавим потом если нужно
        // document.getElementById('report_primary_score').value = lesson.report_data.primary_score || '';
        // document.getElementById('report_secondary_score').value = lesson.report_data.secondary_score || '';
    }
    
    // === ЗАПОЛНЯЕМ ДОМАШКУ ===
    if (lesson.homework_data) {
        console.log('Найдена домашка, заполняем поля:', lesson.homework_data);
        
        // Определяем тип домашки
        let homeworkType = 'tasks'; // по умолчанию
        if (lesson.homework_data.description === 'Не задавать домашку' || 
            lesson.homework_data.description.toLowerCase().includes('не задавать')) {
            homeworkType = 'none';
        }
        
        // Устанавливаем тип в радио-кнопках
        if (homeworkType === 'none') {
            document.getElementById('homework_type_none').checked = true;
            document.getElementById('homework_type_tasks').checked = false;
        } else {
            document.getElementById('homework_type_tasks').checked = true;
            document.getElementById('homework_type_none').checked = false;
        }
        
        // Заполняем описание
        if (homeworkType === 'tasks') {
            document.getElementById('homework_description').value = lesson.homework_data.description || '';
            
            // Заполняем баллы если есть
            document.getElementById('homework_solution_score').value = lesson.homework_data.solution_score || '';
            document.getElementById('homework_formatting_score').value = lesson.homework_data.design_score || '';
            
            // Пока эти баллы не добавляем
            // document.getElementById('homework_primary_score').value = lesson.homework_data.primary_score || '';
            // document.getElementById('homework_secondary_score').value = lesson.homework_data.secondary_score || '';
        }
        
        // Заполняем новые поля задач (если есть данные)
        if (lesson.homework_data.tasks_assigned) {
            document.getElementById('homework_tasks_assigned').value = lesson.homework_data.tasks_assigned;
        }
        if (lesson.homework_data.tasks_solved) {
            document.getElementById('homework_tasks_solved').value = lesson.homework_data.tasks_solved;
        }
        
        // Показываем нужные поля
        toggleHomeworkFields();
    }
}

function clearAllFormFields() {
    // Очищаем поля отчета
    document.getElementById('report_topic').value = '';
    document.getElementById('report_understanding').value = '';
    document.getElementById('report_comment').value = '';
    document.getElementById('report_primary_score').value = '';
    document.getElementById('report_secondary_score').value = '';
    
    // Очищаем поля домашки
    // Сбрасываем радио-кнопки на "Дать задания" по умолчанию
    document.getElementById('homework_type_tasks').checked = true;
    document.getElementById('homework_type_none').checked = false;
    document.getElementById('homework_description').value = '';
    document.getElementById('homework_solution_score').value = '';
    document.getElementById('homework_formatting_score').value = '';
    document.getElementById('homework_primary_score').value = '';
    document.getElementById('homework_secondary_score').value = '';

    // Очищаем новые поля задач
    document.getElementById('homework_tasks_assigned').value = '';
    document.getElementById('homework_tasks_solved').value = '';
    document.getElementById('homework_tasks_assigned_custom').value = '';
    document.getElementById('homework_tasks_solved_custom').value = '';
    document.getElementById('homework_tasks_assigned_custom').style.display = 'none';
    document.getElementById('homework_tasks_solved_custom').style.display = 'none';
    
    // Скрываем поля домашки
    toggleHomeworkFields();
}

function selectLesson(lessonId) {
    selectedLesson = lessonId;
    
    // Убираем выделение со всех уроков
    document.querySelectorAll('.lesson-cell.has-lesson').forEach(lesson => {
        lesson.classList.remove('lesson-selected');
    });
    
    // Выделяем выбранный урок
    event.currentTarget.classList.add('lesson-selected');
    
    // Показываем формы
    document.getElementById('lesson_forms').style.display = 'block';
    
    // Получаем данные урока из DOM элемента
    const lessonElement = event.currentTarget;
    const timeElement = lessonElement.querySelector('div:first-child');
    const studentElement = lessonElement.querySelector('div:nth-child(2)');
    const subjectElement = lessonElement.querySelector('div:nth-child(3)');
    
    if (timeElement && studentElement && subjectElement) {
        const time = timeElement.textContent.trim();
        const student = studentElement.textContent.trim();
        const subject = subjectElement.textContent.trim();
        
        // Получаем дату из input
        const selectedDate = document.getElementById('date_select').value;
        const dateObj = new Date(selectedDate);
        const dateStr = dateObj.toLocaleDateString('ru-RU');
        
        document.getElementById('selected_lesson_info').innerHTML = 
            `Работаем с уроком: ${student} - ${subject} (${time}, ${dateStr})`;
    } else {
        document.getElementById('selected_lesson_info').innerHTML = 
            `Работаем с уроком ID: ${lessonId}`;
    }

    // === НОВАЯ ЧАСТЬ: Ищем данные урока и заполняем форму ===
    console.log('Ищем данные для урока ID:', lessonId);

    // Ищем урок в сегодняшних данных
    let lesson = null;
    if (window.currentLessonsData) {
        lesson = window.currentLessonsData.find(l => l.id === lessonId);
    }

    // Если не найден в сегодняшних, ищем во вчерашних
    if (!lesson && window.yesterdayLessonsData) {
        lesson = window.yesterdayLessonsData.find(l => l.id === lessonId);
        console.log('Ищем во вчерашних данных...');
    }

    if (lesson) {
        console.log('Найден урок с данными:', lesson);
        fillFormWithExistingData(lesson);
    } else {
        console.log('Урок не найден ни в текущих, ни во вчерашних данных');
        clearAllFormFields();
    }
}

// Функция переключения полей домашки
function toggleHomeworkFields() {
    // Получаем выбранный тип из радио-кнопок
    const homeworkTypeRadio = document.querySelector('input[name="homework_type"]:checked');
    const homeworkType = homeworkTypeRadio ? homeworkTypeRadio.value : 'tasks';
    
    const contentFields = document.getElementById('homework_content_fields');
    const probnikFields = document.getElementById('homework_probnik_fields');
    const evaluationFields = document.getElementById('homework_evaluation_fields');
    
    // ДОБАВИМ ПРОВЕРКИ НА СУЩЕСТВОВАНИЕ ЭЛЕМЕНТОВ
    if (!contentFields) {
        console.warn('Элемент homework_content_fields не найден');
        return;
    }
    
    if (!evaluationFields) {
        console.warn('Элемент homework_evaluation_fields не найден');
        return;
    }
    
    if (homeworkType === 'tasks') {
        // Показываем все поля для "дать задачи"
        contentFields.style.display = 'block';
        evaluationFields.style.display = 'block';
        
        // probnikFields может не существовать в текущей версии HTML
        if (probnikFields) {
            probnikFields.style.display = 'grid';
        }
    } else {
        // Скрываем все поля
        contentFields.style.display = 'none';
        evaluationFields.style.display = 'none';
        
        if (probnikFields) {
            probnikFields.style.display = 'none';
        }
    }
}

document.addEventListener('DOMContentLoaded', function() {
    
    // Инициализируем календарь дат
    const dateSelect = document.getElementById('date_select');
    const monthSelect = document.getElementById('month_select');
    const today = new Date();
    
    // Устанавливаем сегодняшнюю дату
    const todayStr = today.toISOString().split('T')[0];
    dateSelect.value = todayStr;
    
    // Устанавливаем текущий месяц  
    const currentMonth = today.getFullYear() + '-' + (today.getMonth() + 1).toString().padStart(2, '0');
    monthSelect.value = currentMonth;
    
    // Обработчик изменения даты
    dateSelect.addEventListener('change', function() {
        const selectedDate = this.value;
        console.log('Выбрана дата:', selectedDate);
        
        if (selectedDate) {
            // Загружаем уроки для выбранной даты
            loadLessonsForDate(selectedDate);
            
            // Загружаем уроки вчера (на день раньше выбранной даты)
            const selectedDateObj = new Date(selectedDate);
            selectedDateObj.setDate(selectedDateObj.getDate() - 1);
            const yesterdayStr = selectedDateObj.toISOString().split('T')[0];
            loadYesterdayLessons(yesterdayStr);
        }
    });
    
    // Обработчик изменения месяца
    monthSelect.addEventListener('change', function() {
        const selectedMonth = this.value;
        console.log('Выбран месяц для счетчиков:', selectedMonth);
        
        if (selectedMonth) {
            // Перезагружаем счетчики для выбранного месяца
            loadRealCounters(selectedMonth);
        }
    });
    
    // Остальной код инициализации...
    updateLessonsColors();
    updateFormsVisibility();
    
    // Загружаем счетчики для текущего месяца
    loadRealCounters(currentMonth);
    
    // Загружаем уроки для сегодня и вчера
    const yesterday = new Date(today);
    yesterday.setDate(today.getDate() - 1);
    const yesterdayStr = yesterday.toISOString().split('T')[0];

    updateStaticDates();
    loadLessonsForDate(todayStr);
    loadYesterdayLessons(yesterdayStr);
});

// Функция для открытия модального окна пробника
function openProbnikModal(type) {
    const modalTitle = type === 'report' ? 'Пробник для отчета' : 'Пробник для домашки';
    
    // Создаем модальное окно
    const modal = document.createElement('div');
    modal.style.cssText = `
        position: fixed;
        top: 0;
        left: 0;
        width: 100%;
        height: 100%;
        background: rgba(0, 0, 0, 0.8);
        display: flex;
        justify-content: center;
        align-items: center;
        z-index: 9999;
    `;
    
    modal.innerHTML = `
        <div style="background: var(--bg-secondary); border-radius: 20px; padding: 30px; max-width: 600px; width: 90%; border: 1px solid var(--border-primary);">
            <h3 style="color: var(--text-accent); margin-bottom: 20px; text-align: center;">${modalTitle}</h3>
            
            <div style="background: var(--bg-card); padding: 20px; border-radius: 12px; margin-bottom: 20px;">
                <h4 style="color: var(--text-primary); margin-bottom: 15px;">🚀 Будущая функция:</h4>
                <ul style="color: var(--text-muted); line-height: 1.6;">
                    <li>✅ Список всех заданий пробника с галочками</li>
                    <li>✅ Автоматический подсчет первичных баллов</li>
                    <li>✅ Перевод в баллы ЕГЭ/ОГЭ (вторичные)</li>
                    <li>✅ Разные структуры для математики, физики, химии</li>
                    <li>✅ Интеграция с диаграммами прогресса</li>
                </ul>
                
                <p style="margin-top: 15px; font-style: italic; color: var(--text-accent);">
                    Пример: Задание 1 ✅ (1 балл), Задание 2 ❌ (1 балл)... → Итого: 15/31 → 68 баллов ЕГЭ
                </p>
            </div>
            
            <div style="text-align: center;">
                <button onclick="this.closest('[style*=\"position: fixed\"]').remove()" 
                        style="background: var(--accent-gradient); color: white; padding: 12px 24px; border: none; border-radius: 12px; cursor: pointer;">
                    Понятно, потом доделаем!
                </button>
            </div>
        </div>
    `;
    
    // Закрытие по клику на фон
    modal.addEventListener('click', function(e) {
        if (e.target === modal) {
            modal.remove();
        }
    });
    
    document.body.appendChild(modal);
}

function saveReport() {
    if (!selectedLesson) {
        alert('Сначала выберите урок!');
        return;
    }
    
    // ДОБАВЛЯЕМ получение даты урока
    const selectedDate = document.getElementById('date_select').value;
    
    // Собираем данные формы
    const reportData = {
        lesson_id: selectedLesson,
        topic: document.getElementById('report_topic').value,
        understanding_level: document.getElementById('report_understanding').value,
        teacher_comment: document.getElementById('report_comment').value,
        primary_score: document.getElementById('report_primary_score').value,
        secondary_score: document.getElementById('report_secondary_score').value,
        lesson_date: selectedDate  // ДОБАВЛЯЕМ дату урока
    };
    
    // Проверяем обязательные поля
    if (!reportData.topic.trim()) {
        alert('Пожалуйста, укажите тему урока');
        return;
    }
    
    // Отправляем AJAX запрос
    fetch('/api/save-report', {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json',
        },
        body: JSON.stringify(reportData)
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            alert('✅ Отчет успешно сохранен!');
            
            // === НОВАЯ ЧАСТЬ: Автоматическое обновление ===
            refreshLessonData();
            
        } else {
            alert('❌ Ошибка: ' + data.error);
        }
    })
    .catch(error => {
        console.error('Ошибка:', error);
        alert('❌ Ошибка сохранения отчета');
    });
}

function saveHomework() {
    if (!selectedLesson) {
        alert('Сначала выберите урок!');
        return;
    }
    
    // ДОБАВЛЯЕМ получение даты урока
    const selectedDate = document.getElementById('date_select').value;
    
    // Собираем данные формы домашки
    const homeworkData = {
        lesson_id: selectedLesson,
        homework_type: document.querySelector('input[name="homework_type"]:checked').value,
        description: document.getElementById('homework_description').value,
        primary_score: document.getElementById('homework_primary_score').value,
        secondary_score: document.getElementById('homework_secondary_score').value,
        solution_score: document.getElementById('homework_solution_score').value,
        formatting_score: document.getElementById('homework_formatting_score').value,
        tasks_assigned: getTasksAssignedValue(),
        tasks_solved: getTasksSolvedValue(),
        lesson_date: selectedDate  // ДОБАВЛЯЕМ дату урока
    };
    
    // ОТЛАДКА: Выводим что собрали
    console.log('📚 ОТЛАДКА: Отправляем данные домашки:', homeworkData);
    console.log('📚 tasks_assigned:', homeworkData.tasks_assigned);
    console.log('📚 tasks_solved:', homeworkData.tasks_solved);
    
    // Проверяем обязательные поля
    if (!homeworkData.homework_type) {
        alert('Пожалуйста, выберите тип домашнего задания');
        return;
    }
    
    // Отправляем AJAX запрос
    fetch('/api/save-homework', {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json',
        },
        body: JSON.stringify(homeworkData)
    })
    .then(response => response.json())
    .then(data => {
        console.log('📚 ОТЛАДКА: Ответ сервера:', data);
        
        if (data.success) {
            alert('✅ Домашнее задание успешно сохранено!');
            refreshLessonData();
        } else {
            alert('❌ Ошибка: ' + data.error);
        }
    })
    .catch(error => {
        console.error('Ошибка:', error);
        alert('❌ Ошибка сохранения домашнего задания');
    });
}

function deleteReport() {
    if (!selectedLesson) {
        alert('Сначала выберите урок!');
        return;
    }
    
    // Подтверждение удаления
    if (!confirm('Вы уверены что хотите удалить отчет по этому уроку?')) {
        return;
    }
    
    // Отправляем AJAX запрос на удаление
    fetch('/api/delete-report', {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json',
        },
        body: JSON.stringify({lesson_id: selectedLesson})
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            alert('✅ Отчет успешно удален!');
            
            // ИСПРАВЛЕНО: Очищаем форму с правильными селекторами
            document.getElementById('report_topic').value = '';
            document.getElementById('report_understanding').value = '';
            document.getElementById('report_comment').value = '';
            document.getElementById('report_primary_score').value = '';
            document.getElementById('report_secondary_score').value = '';
            
            // Обновляем отображение урока (убираем галочку)
            refreshLessonData();
        } else {
            alert('❌ Ошибка: ' + data.error);
        }
    })
    .catch(error => {
        console.error('Ошибка:', error);
        alert('❌ Ошибка удаления отчета');
    });
}

function markHomeworkChecked() {
    if (!selectedLesson) {
        alert('Сначала выберите урок!');
        return;
    }
    
    console.log('📝 ОТЛАДКА: Отмечаем домашку как проверенную');
    
    // ДОБАВЛЯЕМ получение даты урока
    const selectedDate = document.getElementById('date_select').value;
    
    // СНАЧАЛА сохраняем текущие значения полей (как в saveHomework)
    const homeworkData = {
        lesson_id: selectedLesson,
        homework_type: document.getElementById('homework_type').value,
        description: document.getElementById('homework_description').value,
        primary_score: document.getElementById('homework_primary_score').value,
        secondary_score: document.getElementById('homework_secondary_score').value,
        solution_score: document.getElementById('homework_solution_score').value,
        formatting_score: document.getElementById('homework_formatting_score').value,
        tasks_assigned: getTasksAssignedValue(),
        tasks_solved: getTasksSolvedValue(),
        lesson_date: selectedDate  // ДОБАВЛЯЕМ дату урока
    };
    
    console.log('📝 ОТЛАДКА: Сохраняем данные перед отметкой:', homeworkData);
    
    // ПЕРВЫЙ запрос - сохраняем данные
    fetch('/api/save-homework', {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json',
        },
        body: JSON.stringify(homeworkData)
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            console.log('📝 ОТЛАДКА: Данные сохранены, теперь отмечаем как проверенную');
            
            // ВТОРОЙ запрос - отмечаем как проверенную
            return fetch('/api/mark-homework-checked', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                },
                body: JSON.stringify({lesson_id: selectedLesson})
            });
        } else {
            throw new Error('Ошибка сохранения данных: ' + data.error);
        }
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            alert('✅ Домашнее задание отмечено как проверенное!');
            refreshLessonData();
        } else {
            alert('❌ Ошибка: ' + data.error);
        }
    })
    .catch(error => {
        console.error('Ошибка:', error);
        alert('❌ Ошибка отметки домашки: ' + error.message);
    });
}

function deleteHomework() {
    if (!selectedLesson) {
        alert('Сначала выберите урок!');
        return;
    }
    
    // Подтверждение удаления
    if (!confirm('Вы уверены что хотите удалить домашнее задание по этому уроку?')) {
        return;
    }
    
    // Отправляем AJAX запрос на удаление
    fetch('/api/delete-homework', {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json',
        },
        body: JSON.stringify({lesson_id: selectedLesson})
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            alert('✅ Домашнее задание успешно удалено!');
            
            // ИСПРАВЛЕНО: Очищаем форму с правильными селекторами
            document.getElementById('homework_type').value = '';
            document.getElementById('homework_description').value = '';
            document.getElementById('homework_primary_score').value = '';
            document.getElementById('homework_secondary_score').value = '';
            document.getElementById('homework_solution_score').value = '';
            document.getElementById('homework_formatting_score').value = '';
            document.getElementById('homework_tasks_assigned').value = '';
            document.getElementById('homework_tasks_solved').value = '';
            document.getElementById('homework_tasks_assigned_custom').value = '';
            document.getElementById('homework_tasks_solved_custom').value = '';
            
            // Скрываем поля
            toggleHomeworkFields();
            
            // Обновляем отображение урока
            refreshLessonData();
        } else {
            alert('❌ Ошибка: ' + data.error);
        }
    })
    .catch(error => {
        console.error('Ошибка:', error);
        alert('❌ Ошибка удаления домашки');
    });
}

// Функция копирования логина и пароля
function copyLoginPassword(login, password) {
    const text = `Логин: ${login}. Пароль: ${password}`;
    
    if (navigator.clipboard && navigator.clipboard.writeText) {
        navigator.clipboard.writeText(text).then(function() {
            showCopyNotification('Логин и пароль скопированы!');
        }).catch(function(err) {
            console.error('Ошибка копирования: ', err);
            fallbackCopyToClipboard(text);
        });
    } else {
        fallbackCopyToClipboard(text);
    }
}

// Резервный способ копирования
function fallbackCopyToClipboard(text) {
    const textArea = document.createElement("textarea");
    textArea.value = text;
    textArea.style.position = "fixed";
    textArea.style.left = "-999999px";
    textArea.style.top = "-999999px";
    document.body.appendChild(textArea);
    textArea.focus();
    textArea.select();
    
    try {
        const successful = document.execCommand('copy');
        if (successful) {
            showCopyNotification('Логин и пароль скопированы!');
        }
    } catch (err) {
        console.error('Fallback копирование не удалось: ', err);
    }
    
    document.body.removeChild(textArea);
}

// Показать уведомление о копировании
function showCopyNotification(message = '✅ Скопировано!') {
    const notification = document.createElement('div');
    notification.textContent = message;
    notification.style.cssText = `
        position: fixed;
        top: 20px;
        right: 20px;
        background: var(--success-color, #10b981);
        color: white;
        padding: 12px 20px;
        border-radius: 8px;
        box-shadow: 0 4px 12px rgba(0,0,0,0.2);
        z-index: 10000;
        font-weight: bold;
        animation: slideIn 0.3s ease-out;
    `;
    
    document.body.appendChild(notification);
    
    setTimeout(() => {
        notification.style.animation = 'slideOut 0.3s ease-in';
        setTimeout(() => {
            if (document.body.contains(notification)) {
                document.body.removeChild(notification);
            }
        }, 300);
    }, 2000);
}

function refreshLessonData() {
    console.log('🔄 Обновляем данные уроков автоматически');
    
    // Получаем текущую выбранную дату
    const selectedDate = document.getElementById('date_select').value;
    const selectedMonth = document.getElementById('month_select').value;
    
    if (selectedDate) {
        // 1. Перезагружаем уроки для текущей даты
        loadLessonsForDate(selectedDate);
        
        // 2. Если это вчерашняя дата тоже, обновляем вчерашние
        const today = new Date().toISOString().split('T')[0];
        const yesterday = new Date();
        yesterday.setDate(yesterday.getDate() - 1);
        const yesterdayStr = yesterday.toISOString().split('T')[0];
        
        if (selectedDate === yesterdayStr) {
            // Перезагружаем вчерашние уроки
            loadYesterdayLessons(selectedDate);
        }
        
        // 3. Обновляем счетчики для текущего месяца
        if (selectedMonth) {
            loadRealCounters(selectedMonth);
        }
        
        console.log('✅ Данные уроков обновлены');
        
        // 4. Через небольшую задержку выбираем урок заново (чтобы форма обновилась)
        setTimeout(() => {
            if (selectedLesson && window.currentLessonsData) {
                const lesson = window.currentLessonsData.find(l => l.id === selectedLesson);
                if (lesson) {
                    fillFormWithExistingData(lesson);
                    console.log('✅ Форма обновлена с новыми данными');
                }
            }
        }, 500); // задержка 500мс чтобы данные успели загрузиться
    }
}

// Обработка выбора "Сколько задано"
function handleTasksAssignedChange() {
    const select = document.getElementById('homework_tasks_assigned');
    const customInput = document.getElementById('homework_tasks_assigned_custom');
    
    if (select.value === 'other') {
        customInput.style.display = 'block';
        customInput.focus();
    } else {
        customInput.style.display = 'none';
        customInput.value = '';
    }
}

// Обработка выбора "Сколько решено"
function handleTasksSolvedChange() {
    const select = document.getElementById('homework_tasks_solved');
    const customInput = document.getElementById('homework_tasks_solved_custom');
    
    if (select.value === 'other') {
        customInput.style.display = 'block';
        customInput.focus();
    } else {
        customInput.style.display = 'none';
        customInput.value = '';
    }
}

// Получить значение "Сколько задано" (из выпадающего списка или кастомного поля)
function getTasksAssignedValue() {
    const select = document.getElementById('homework_tasks_assigned');
    const customInput = document.getElementById('homework_tasks_assigned_custom');
    
    if (select.value === 'other') {
        return customInput.value || '';
    }
    return select.value || '';
}

// Получить значение "Сколько решено" (из выпадающего списка или кастомного поля)
function getTasksSolvedValue() {
    const select = document.getElementById('homework_tasks_solved');
    const customInput = document.getElementById('homework_tasks_solved_custom');
    
    if (select.value === 'other') {
        return customInput.value || '';
    }
    return select.value || '';
}

</script>

{% endblock %}