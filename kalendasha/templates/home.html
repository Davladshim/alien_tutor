{% extends "base.html" %}

{% block title %}Главная - Календаша{% endblock %}

{% block content %}
<div style="text-align: center; margin-bottom: 30px;">
    <h1>Админская панель</h1>
    <p style="color: var(--text-muted); font-size: 16px;">
        Управление учениками и быстрое добавление отчетов
    </p>
</div>

<!-- НОВАЯ СИСТЕМА ОТЧЕТОВ И ДОМАШЕК -->
<div class="card" style="margin-bottom: 30px;">
    <h2 style="margin-bottom: 25px; text-align: center;">Отчеты по урокам и домашние задания</h2>
    
    <!-- Блок выбора даты со счетчиком -->
    <div style="background: var(--bg-card); border-radius: 12px; padding: 20px; margin-bottom: 25px; border: 1px solid var(--border-secondary);">
        <div style="display: flex; justify-content: space-between; align-items: center; flex-wrap: wrap; gap: 15px;">
            
            <!-- Переключатель режимов -->
            <div style="min-width: 200px;">
                <label style="display: block; margin-bottom: 8px; font-weight: bold;">
                    Режим работы:
                </label>
                <div class="view-toggle">
                    <button class="view-toggle-btn active" id="report_mode" onclick="switchMode('report')">
                        <span>Отчет</span>
                    </button>
                    <button class="view-toggle-btn" id="homework_mode" onclick="switchMode('homework')">
                        <span>ДЗ</span>
                    </button>
                </div>
            </div>

            <!-- Выбор даты -->
            <div style="flex: 1; min-width: 200px;">
                <label for="date_select" style="display: block; margin-bottom: 8px; font-weight: bold;">
                    Выбрать другую дату:
                </label>
                <select id="date_select" style="width: 100%; padding: 10px; border-radius: 8px;">
                    <option value="2025-08-15">Сегодня (15.08.2025)</option>
                    <option value="2025-08-14">Вчера (14.08.2025)</option>
                    <option value="2025-08-13">13.08.2025 (вторник)</option>
                    <option value="2025-08-12">12.08.2025 (понедельник)</option>
                    <option value="2025-08-11">11.08.2025 (воскресенье)</option>
                </select>
            </div>
            
            <!-- Счетчик проблемных уроков -->
            <div style="text-align: center;">
                <div style="font-size: 14px; color: var(--text-muted); margin-bottom: 5px;">
                    Требуют внимания:
                </div>
                <div style="display: flex; gap: 15px; align-items: center;">
                    <div style="text-align: center;">
                        <div style="font-size: 24px; font-weight: bold; color: #ef4444;" id="homework_missing_count">
                            3
                        </div>
                        <div style="font-size: 12px; color: var(--text-muted);">
                            без домашки
                        </div>
                    </div>
                    <div style="font-size: 18px; color: var(--text-muted);">/</div>
                    <div style="text-align: center;">
                        <div style="font-size: 24px; font-weight: bold; color: #f59e0b;" id="homework_unchecked_count">
                            2
                        </div>
                        <div style="font-size: 12px; color: var(--text-muted);">
                            не проверены
                        </div>
                    </div>
                    <div style="font-size: 18px; color: var(--text-muted);">/</div>
                    <div style="text-align: center;">
                        <div style="font-size: 24px; font-weight: bold; color: #ef4444;" id="reports_missing_count">
                            1
                        </div>
                        <div style="font-size: 12px; color: var(--text-muted);">
                            без отчета
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
<!-- Блоки с уроками - заполняются из БД -->
<div style="display: grid; grid-template-columns: 1fr; gap: 20px; margin-bottom: 30px;">
    
    <!-- Уроки вчера - до 12 уроков (динамически 1-2 строки) -->
    <table style="width: 100%; border-collapse: collapse;">
        <tr>
            <!-- Левая колонка - заголовок на 2 строки -->
            <td rowspan="2" style="width: 200px; background: var(--accent-gradient); color: white; padding: 20px; 
                    font-weight: bold; font-size: 18px; text-align: center; vertical-align: middle; 
                    border-right: 2px solid var(--border-secondary);">
                Уроки вчера<br>
                <span id="yesterday_date" style="font-size: 14px; font-weight: normal;">(загрузка...)</span>
            </td>
            
            <!-- Первая строка: 6 пустых ячеек - JavaScript их заполнит -->
            <td style="background: var(--bg-card); padding: 15px; border-right: 1px solid var(--border-secondary); width: 200px;">
                <div style="text-align: center; color: var(--text-muted); font-style: italic;">Нет урока</div>
            </td>
            <td style="background: var(--bg-card); padding: 15px; border-right: 1px solid var(--border-secondary); width: 200px;">
                <div style="text-align: center; color: var(--text-muted); font-style: italic;">Нет урока</div>
            </td>
            <td style="background: var(--bg-card); padding: 15px; border-right: 1px solid var(--border-secondary); width: 200px;">
                <div style="text-align: center; color: var(--text-muted); font-style: italic;">Нет урока</div>
            </td>
            <td style="background: var(--bg-card); padding: 15px; border-right: 1px solid var(--border-secondary); width: 200px;">
                <div style="text-align: center; color: var(--text-muted); font-style: italic;">Нет урока</div>
            </td>
            <td style="background: var(--bg-card); padding: 15px; border-right: 1px solid var(--border-secondary); width: 200px;">
                <div style="text-align: center; color: var(--text-muted); font-style: italic;">Нет урока</div>
            </td>
            <td style="background: var(--bg-card); padding: 15px; width: 200px;">
                <div style="text-align: center; color: var(--text-muted); font-style: italic;">Нет урока</div>
            </td>
        </tr>
        <tr id="yesterday_row_2" style="display: none;">
            <!-- Вторая строка: еще 6 пустых ячеек (скрыта по умолчанию) -->
            <td style="background: var(--bg-card); padding: 15px; border-right: 1px solid var(--border-secondary); width: 200px;">
                <div style="text-align: center; color: var(--text-muted); font-style: italic;">Нет урока</div>
            </td>
            <td style="background: var(--bg-card); padding: 15px; border-right: 1px solid var(--border-secondary); width: 200px;">
                <div style="text-align: center; color: var(--text-muted); font-style: italic;">Нет урока</div>
            </td>
            <td style="background: var(--bg-card); padding: 15px; border-right: 1px solid var(--border-secondary); width: 200px;">
                <div style="text-align: center; color: var(--text-muted); font-style: italic;">Нет урока</div>
            </td>
            <td style="background: var(--bg-card); padding: 15px; border-right: 1px solid var(--border-secondary); width: 200px;">
                <div style="text-align: center; color: var(--text-muted); font-style: italic;">Нет урока</div>
            </td>
            <td style="background: var(--bg-card); padding: 15px; border-right: 1px solid var(--border-secondary); width: 200px;">
                <div style="text-align: center; color: var(--text-muted); font-style: italic;">Нет урока</div>
            </td>
            <td style="background: var(--bg-card); padding: 15px; width: 200px;">
                <div style="text-align: center; color: var(--text-muted); font-style: italic;">Нет урока</div>
            </td>
        </tr>
    </table>
    
    <!-- Уроки сегодня - до 12 уроков (2 строки по 6) -->
    <table style="width: 100%; border-collapse: collapse;">
        <tr>
            <!-- Левая колонка - заголовок на 2 строки -->
            <td rowspan="2" style="width: 200px; background: var(--accent-gradient); color: white; padding: 20px; 
                    font-weight: bold; font-size: 18px; text-align: center; vertical-align: middle; 
                    border-right: 2px solid var(--border-secondary);">
                <span id="today_lessons_title">Уроки сегодня</span><br>
                <span id="today_lessons_date" style="font-size: 14px; font-weight: normal;">(загрузка...)</span>
            </td>
            
            <!-- Первая строка: 6 пустых ячеек - JavaScript их заполнит -->
            <td style="background: var(--bg-card); padding: 15px; border-right: 1px solid var(--border-secondary); width: 200px;">
                <div style="text-align: center; color: var(--text-muted); font-style: italic;">Нет урока</div>
            </td>
            <td style="background: var(--bg-card); padding: 15px; border-right: 1px solid var(--border-secondary); width: 200px;">
                <div style="text-align: center; color: var(--text-muted); font-style: italic;">Нет урока</div>
            </td>
            <td style="background: var(--bg-card); padding: 15px; border-right: 1px solid var(--border-secondary); width: 200px;">
                <div style="text-align: center; color: var(--text-muted); font-style: italic;">Нет урока</div>
            </td>
            <td style="background: var(--bg-card); padding: 15px; border-right: 1px solid var(--border-secondary); width: 200px;">
                <div style="text-align: center; color: var(--text-muted); font-style: italic;">Нет урока</div>
            </td>
            <td style="background: var(--bg-card); padding: 15px; border-right: 1px solid var(--border-secondary); width: 200px;">
                <div style="text-align: center; color: var(--text-muted); font-style: italic;">Нет урока</div>
            </td>
            <td style="background: var(--bg-card); padding: 15px; width: 200px;">
                <div style="text-align: center; color: var(--text-muted); font-style: italic;">Нет урока</div>
            </td>
        </tr>
        <tr id="today_row_2">
            <!-- Вторая строка: еще 6 пустых ячеек - JavaScript их заполнит -->
            <td style="background: var(--bg-card); padding: 15px; border-right: 1px solid var(--border-secondary); width: 200px;">
                <div style="text-align: center; color: var(--text-muted); font-style: italic;">Нет урока</div>
            </td>
            <td style="background: var(--bg-card); padding: 15px; border-right: 1px solid var(--border-secondary); width: 200px;">
                <div style="text-align: center; color: var(--text-muted); font-style: italic;">Нет урока</div>
            </td>
            <td style="background: var(--bg-card); padding: 15px; border-right: 1px solid var(--border-secondary); width: 200px;">
                <div style="text-align: center; color: var(--text-muted); font-style: italic;">Нет урока</div>
            </td>
            <td style="background: var(--bg-card); padding: 15px; border-right: 1px solid var(--border-secondary); width: 200px;">
                <div style="text-align: center; color: var(--text-muted); font-style: italic;">Нет урока</div>
            </td>
            <td style="background: var(--bg-card); padding: 15px; border-right: 1px solid var(--border-secondary); width: 200px;">
                <div style="text-align: center; color: var(--text-muted); font-style: italic;">Нет урока</div>
            </td>
            <td style="background: var(--bg-card); padding: 15px; width: 200px;">
                <div style="text-align: center; color: var(--text-muted); font-style: italic;">Нет урока</div>
            </td>
        </tr>
    </table>
</div>
<!-- Формы для работы с выбранным уроком -->
    <div id="lesson_forms" style="border: 2px solid var(--accent-color, #00d4ff); border-radius: 15px; padding: 25px; display: none;">
        <div id="selected_lesson_info" style="background: var(--accent-gradient); color: white; padding: 15px; border-radius: 10px; margin-bottom: 25px; text-align: center; font-weight: bold; font-size: 18px;">
            Выберите урок для работы
        </div>
        
        <!-- Форма отчета по уроку -->
        <div class="report-form" style="margin-bottom: 30px;">
            <h3 style="color: var(--text-accent); margin-bottom: 20px;">Отчет по уроку</h3>
            
            <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(250px, 1fr)); gap: 20px; margin-bottom: 20px;">
                <div>
                    <label>Тема урока:</label>
                    <input type="text" placeholder="Например: Квадратные уравнения" style="width: 100%;">
                </div>
                
                <div>
                    <label>Понимание темы:</label>
                    <select style="width: 100%;">
                        <option value="">-- Выберите уровень --</option>
                        <option value="Тема разобрана полностью">Тема разобрана полностью</option>
                        <option value="Есть вопросы по теме">Есть вопросы по теме</option>
                        <option value="Тему нужно закрепить">Тему нужно закрепить</option>
                    </select>
                </div>
            </div>
            
            <div style="margin-bottom: 20px;">
                <label>Комментарий преподавателя:</label>
                <textarea rows="3" placeholder="Подробный отзыв о работе ученика на уроке" style="width: 100%;"></textarea>
            </div>

            <!-- Кнопка пробник и баллы в одной строке -->
            <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 15px; margin-bottom: 20px;">
                <div>
                    <label style="visibility: hidden;">Пробник</label>
                    <button class="btn warning" onclick="openProbnikModal('report')" style="width: 100%;">Пробник</button>
                </div>
                
                <div>
                    <label>Первичные баллы:</label>
                    <input type="number" min="0" max="50" placeholder="0-50" style="width: 100%;">
                </div>
                
                <div>
                    <label>Вторичные баллы:</label>
                    <input type="number" min="0" max="100" placeholder="0-100" style="width: 100%;">
                </div>
            </div>
            
            <div style="text-align: center;">
                <button class="btn success" style="margin-right: 10px;" onclick="saveReport()">Сохранить отчет</button>
                <button class="btn danger" onclick="deleteReport()">Удалить отчет</button>
            </div>
        </div>
        
        <!-- Форма домашнего задания -->
        <div class="homework-form" style="border-top: 2px solid var(--border-secondary); padding-top: 25px;">
            <h3 style="color: var(--text-accent); margin-bottom: 20px;">Домашнее задание</h3>
            
            <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 20px; margin-bottom: 20px;">
                <div>
                    <label>Тип домашнего задания:</label>
                    <select id="homework_type" onchange="toggleHomeworkFields()" style="width: 100%;">
                        <option value="">-- Выберите тип --</option>
                        <option value="tasks">Дать задачи</option>
                        <option value="none">Не задавать домашку</option>
                    </select>
                </div>
                
                <div id="homework_evaluation_fields" style="display: none;">
                        <label>Решение:</label>
                        <select style="width: 100%;">
                            <option value="">-- Выберите --</option>
                            <option value="1">1</option>
                            <option value="2">2</option>
                            <option value="3">3</option>
                            <option value="4">4</option>
                            <option value="5">5</option>
                            <option value="6">6</option>
                            <option value="7">7</option>
                            <option value="8">8</option>
                            <option value="9">9</option>
                            <option value="10">10</option>
                        </select>
                </div>
                
                <div id="homework_formatting_fields" style="display: none;">
                    <label>Оформление:</label>
                    <select style="width: 100%;">
                        <option value="">-- Выберите --</option>
                        <option value="1">1</option>
                        <option value="2">2</option>
                        <option value="3">3</option>
                        <option value="4">4</option>
                        <option value="5">5</option>
                        <option value="6">6</option>
                        <option value="7">7</option>
                        <option value="8">8</option>
                        <option value="9">9</option>
                        <option value="10">10</option>
                    </select>
                </div>
            </div>
            
            <div id="homework_content_fields" style="display: none;">
                <div style="margin-bottom: 20px;">
                    <label>Описание домашнего задания:</label>
                    <textarea rows="3" placeholder="Подробное описание заданий" style="width: 100%;"></textarea>
                </div>

                <!-- Кнопка пробник и баллы под описанием -->
                <div id="homework_probnik_fields" style="display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 15px; margin-bottom: 20px; display: none;">
                    <div>
                        <label style="visibility: hidden;">Пробник</label>
                        <button class="btn warning" onclick="openProbnikModal('homework')" style="width: 100%;">Пробник</button>
                    </div>
                    
                    <div>
                        <label>Первичные баллы:</label>
                        <input type="number" min="0" max="50" placeholder="0-50" style="width: 100%;">
                    </div>
                    
                    <div>
                        <label>Вторичные баллы:</label>
                        <input type="number" min="0" max="100" placeholder="0-100" style="width: 100%;">
                    </div>
                </div>
            </div>
            
            <div style="text-align: center;">
                <button class="btn success" style="margin-right: 10px;" onclick="saveHomework()">Сохранить домашку</button>
                <button class="btn warning" style="margin-right: 10px;" onclick="markHomeworkChecked()">Отметить как проверенную</button>
                <button class="btn danger" onclick="deleteHomework()">Удалить Д/З</button>
            </div>
        </div>
    </div>
</div>

<!-- Таблица учеников -->
<div class="card" style="margin-bottom: 30px;">
    <h3 style="text-align: center; margin-bottom: 20px;">Аккаунты учеников</h3>
    
    {% if accounts_data %}
        <div style="overflow-x: auto;">
            <table class="accounts-table">
                <thead>
                    <tr>
                        <th>Ученик</th>
                        <th>Класс</th>
                        <th>Логин</th>
                        <th>Пароль</th>
                        <th>ЛКУ</th>
                    </tr>
                </thead>
                <tbody>
                    {% for account in accounts_data %}
                    <tr>
                        <td class="student-name">{{ account.student_name }}</td>
                        <td>{{ account.student_class }}</td>
                        
                        <!-- Логин ученика -->
                        <td class="login-cell">
                            {% if account.has_student_account %}
                                <span class="login-text">{{ account.student_login }}</span>
                            {% else %}
                                <span class="no-account">Нет аккаунта</span>
                            {% endif %}
                        </td>
                        
                        <!-- Пароль ученика -->
                        <td class="password-cell">
                            {% if account.has_student_account %}
                                <span class="password-text">{{ account.student_password }}</span>
                            {% else %}
                                <span class="no-account">Нет аккаунта</span>
                            {% endif %}
                        </td>
                        
                        <!-- Кнопка ЛКУ -->
                        <td class="action-cell">
                            {% if account.has_student_account %}
                                <a href="http://127.0.0.1:8080/admin-student/{{ account.student_id }}?token={{ admin_token }}" 
                                   class="icon-action icon-student" 
                                   title="Личный кабинет ученика">
                                    <svg viewBox="0 0 24 24" width="28" height="28" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                                        <path d="M20 21v-2a4 4 0 0 0-4-4H8a4 4 0 0 0-4 4v2"></path>
                                        <circle cx="12" cy="7" r="4"></circle>
                                    </svg>
                                </a>
                            {% else %}
                                <span class="no-account">—</span>
                            {% endif %}
                        </td>
                    </tr>
                    {% endfor %}
                </tbody>
            </table>
        </div>
    {% else %}
        <p style="text-align: center; color: var(--text-muted);">Нет учеников</p>
    {% endif %}
</div>

<!-- Таблица родителей -->
<div class="card">
    <h3 style="text-align: center; margin-bottom: 20px;">Аккаунты родителей</h3>
    
    {% if families_data %}
        <div style="overflow-x: auto;">
            <table class="accounts-table parents-table">
                <thead>
                    <tr>
                        <th>Родитель</th>
                        <th>Дети</th>
                        <th>Логин</th>
                        <th>Пароль</th>
                        <th>ЛКР</th>
                    </tr>
                </thead>
                <tbody>
                    {% for family in families_data %}
                    <tr>
                        <td class="parent-name">{{ family.parent_name }}</td>
                        <td class="children-list">
                            {% for child in family.children %}
                                <span class="child-tag">{{ child }}</span>{% if not loop.last %}, {% endif %}
                            {% endfor %}
                        </td>
                        
                        <!-- Логин родителя -->
                        <td class="login-cell">
                            {% if family.has_parent_account %}
                                <span class="login-text">{{ family.parent_login }}</span>
                            {% else %}
                                <span class="no-account">Нет аккаунта</span>
                            {% endif %}
                        </td>
                        
                        <!-- Пароль родителя -->
                        <td class="password-cell">
                            {% if family.has_parent_account %}
                                <span class="password-text">{{ family.parent_password }}</span>
                            {% else %}
                                <span class="no-account">Нет аккаунта</span>
                            {% endif %}
                        </td>
                        
                        <!-- Кнопка ЛКР -->
                        <td class="action-cell">
                            {% if family.has_parent_account %}
                                <a href="http://127.0.0.1:8080/admin-parent/{{ family.parent_name }}?token={{ admin_token }}" 
                                   class="icon-action icon-parent" 
                                   title="Личный кабинет родителя">
                                    <svg viewBox="0 0 24 24" width="28" height="28" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                                        <path d="M16 21v-2a4 4 0 0 0-4-4H6a4 4 0 0 0-4 4v2"></path>
                                        <circle cx="9" cy="7" r="4"></circle>
                                        <path d="M22 21v-2a4 4 0 0 0-3-3.87"></path>
                                        <path d="M16 3.13a4 4 0 0 1 0 7.75"></path>
                                    </svg>
                                </a>
                            {% else %}
                                <span class="no-account">—</span>
                            {% endif %}
                        </td>
                    </tr>
                    {% endfor %}
                </tbody>
            </table>
        </div>
    {% else %}
        <p style="text-align: center; color: var(--text-muted);">Нет родителей</p>
    {% endif %}
</div>

<script>
// Переменная для хранения выбранного урока
let selectedLesson = null;

let currentMode = 'report'; // НОВАЯ СТРОКА

// НОВАЯ ФУНКЦИЯ - добавь её после переменных, но перед function selectLesson
function switchMode(mode) {
    currentMode = mode;
    
    // Переключаем активные кнопки
    document.getElementById('report_mode').classList.remove('active');
    document.getElementById('homework_mode').classList.remove('active');
    document.getElementById(mode + '_mode').classList.add('active');
    
    // Перекрашиваем все уроки согласно новому режиму
    updateLessonsColors();
    
    // Показываем нужную форму
    updateFormsVisibility();

    // Обновляем счетчики
    updateCounters();
}

function updateLessonsColors() {
    // Просто перезагружаем данные с сервера для текущей даты
    const selectedDate = document.getElementById('date_select').value;
    
    if (selectedDate) {
        console.log('Перекрашиваем уроки в режим:', currentMode);
        loadLessonsForDate(selectedDate);
        
        // И загружаем вчерашние если это сегодня
        if (selectedDate === new Date().toISOString().split('T')[0]) {
            const yesterday = new Date();
            yesterday.setDate(yesterday.getDate() - 1);
            const yesterdayStr = yesterday.toISOString().split('T')[0];
            loadYesterdayLessons(yesterdayStr);
        }
    }
}

function updateLessonColorForReport(lesson) {
    // Красный = урок проведен, отчет не добавлен
    lesson.style.background = 'linear-gradient(135deg, rgba(239, 68, 68, 0.2), rgba(127, 29, 29, 0.2))';
    lesson.style.borderLeftColor = '#ef4444';
    
    // Обновляем текст статуса
    const statusDiv = lesson.querySelector('div:last-child');
    statusDiv.innerHTML = '<span style="color: #ef4444; font-weight: bold;">Нет отчета</span>';
}

function updateLessonColorForHomework(lesson) {
    // Желтый = урок проведен, домашка задана, но не проверена  
    lesson.style.background = 'linear-gradient(135deg, rgba(245, 158, 11, 0.2), rgba(217, 119, 6, 0.2))';
    lesson.style.borderLeftColor = '#f59e0b';
    
    // Обновляем текст статуса
    const statusDiv = lesson.querySelector('div:last-child');
    statusDiv.innerHTML = '<span style="color: #f59e0b; font-weight: bold;">Не проверена</span>';
}

function updateFormsVisibility() {
    const lessonForms = document.getElementById('lesson_forms');
    
    if (!lessonForms || lessonForms.style.display === 'none') {
        return; // Если формы скрыты, ничего не делаем
    }
    
    // Находим блоки форм
    const reportForm = lessonForms.querySelector('.report-form');
    const homeworkForm = lessonForms.querySelector('.homework-form');
    
    if (currentMode === 'report') {
        // Показываем только форму отчета
        if (reportForm) reportForm.style.display = 'block';
        if (homeworkForm) homeworkForm.style.display = 'none';
    } else {
        // Показываем только форму домашки
        if (reportForm) reportForm.style.display = 'none';
        if (homeworkForm) homeworkForm.style.display = 'block';
    }
}

function updateStaticDates() {
    // Получаем реальные даты
    const today = new Date();
    const yesterday = new Date(today);
    yesterday.setDate(today.getDate() - 1);
    
    // Форматируем для отображения (ДД.ММ.ГГГГ)
    const todayFormatted = today.toLocaleDateString('ru-RU');
    const yesterdayFormatted = yesterday.toLocaleDateString('ru-RU');
    
    // Обновляем заголовки
    document.getElementById('yesterday_date').textContent = `(${yesterdayFormatted})`;
    document.getElementById('today_lessons_date').textContent = `(${todayFormatted})`;
    
    console.log('Даты обновлены:', yesterdayFormatted, 'и', todayFormatted);
}

function updateDateDisplay(selectedDate) {
    const titleElement = document.getElementById('today_lessons_title');
    const dateElement = document.getElementById('today_lessons_date');
    
    // Форматируем дату для отображения
    let displayDate, displayTitle;
    
    if (selectedDate === '2025-08-15') {
        // Это сегодня
        displayTitle = 'Уроки сегодня';
        displayDate = '(15.08.2025)';
    } else {
        // Другая дата
        const dateObj = new Date(selectedDate);
        const day = dateObj.getDate().toString().padStart(2, '0');
        const month = (dateObj.getMonth() + 1).toString().padStart(2, '0');
        const year = dateObj.getFullYear();
        
        displayTitle = 'Уроки в';
        displayDate = `(${day}.${month}.${year})`;
    }
    
    titleElement.textContent = displayTitle;
    dateElement.textContent = displayDate;
}

function updateCounters() {
    // Статичные данные для демонстрации
    // В будущем здесь будут реальные подсчеты из базы
    
    const homeworkMissing = 3;     // Всегда 3 урока без домашки
    const homeworkUnchecked = 2;   // Всегда 2 непроверенные домашки  
    const reportsMissing = 1;      // Всегда 1 урок без отчета
    
    // Обновляем отображение
    document.getElementById('homework_missing_count').textContent = homeworkMissing;
    document.getElementById('homework_unchecked_count').textContent = homeworkUnchecked;
    document.getElementById('reports_missing_count').textContent = reportsMissing;
}

function updateRealCounters(lessons) {
    let homeworkMissing = 0;
    let homeworkUnchecked = 0; 
    let reportsMissing = 0;
    
    lessons.forEach(lesson => {
        if (lesson.status === 'completed') {
            if (!lesson.has_report) {
                reportsMissing++;
            }
            // Логику для домашек добавим позже
        }
    });
    
    // Обновляем отображение
    document.getElementById('homework_missing_count').textContent = homeworkMissing;
    document.getElementById('homework_unchecked_count').textContent = homeworkUnchecked;
    document.getElementById('reports_missing_count').textContent = reportsMissing;
}

function loadLessonsForDate(date) {
    console.log('Загружаем уроки для даты:', date);
    
    fetch(`/api/get-lessons/${date}`)
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            updateLessonsDisplay(data.lessons, date);
            updateRealCounters(data.lessons);
        } else {
            console.error('Ошибка загрузки уроков:', data.error);
        }
    })
    .catch(error => {
        console.error('Ошибка:', error);
    });
}

function loadYesterdayLessons(date) {
    fetch(`/api/get-lessons/${date}`)
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            updateYesterdayLessonsDisplay(data.lessons);
        }
    })
    .catch(error => console.error('Ошибка загрузки вчерашних уроков:', error));
}

function updateYesterdayLessonsDisplay(lessons) {
    console.log('Вчерашние уроки:', lessons);
    
    // Находим таблицу вчерашних уроков
    const yesterdayTable = document.querySelector('div[style*="grid-template-columns"] table');
    const yesterdayRows = yesterdayTable.querySelectorAll('tr');
    const yesterdayFirstRowCells = yesterdayRows[0].querySelectorAll('td:not(:first-child)'); // первая строка, кроме заголовка
    const yesterdaySecondRowCells = yesterdayRows[1].querySelectorAll('td'); // вторая строка, все ячейки
    const allYesterdayCells = [...yesterdayFirstRowCells, ...yesterdaySecondRowCells];
    
    // Скрываем вторую строку по умолчанию
    const yesterdayRow2 = document.getElementById('yesterday_row_2');
    yesterdayRow2.style.display = 'none';
    
    // Очищаем все ячейки вчера
    allYesterdayCells.forEach(cell => {
        cell.innerHTML = '<div style="text-align: center; color: var(--text-muted); font-style: italic;">Нет урока</div>';
        cell.style.background = 'var(--bg-card)';
        cell.style.borderLeftColor = 'var(--border-secondary)';
        cell.onclick = null;
    });
    
    // Показываем вторую строку если уроков больше 6
    if (lessons.length > 6) {
        yesterdayRow2.style.display = 'table-row';
    }
    
    // Заполняем реальными уроками (максимум 12)
    lessons.slice(0, 12).forEach((lesson, index) => {
        const cell = allYesterdayCells[index];
        if (cell) {
            const statusInfo = getLessonStatusInfo(lesson);
            
            cell.innerHTML = `
                <div style="background: var(--accent-gradient); color: white; padding: 8px 12px; border-radius: 6px; 
                           font-size: 16px; font-weight: bold; margin-bottom: 10px; text-align: center; min-width: 70px;">
                    ${lesson.time}
                </div>
                <div style="font-weight: bold; margin-bottom: 6px; font-size: 16px;">${lesson.student}</div>
                <div style="font-size: 14px; margin-bottom: 6px;">${lesson.subject}</div>
                <div style="font-size: 12px; color: ${statusInfo.color}; font-weight: bold;">${statusInfo.text}</div>
            `;
            
            cell.style.background = statusInfo.background;
            cell.style.borderLeftColor = statusInfo.borderColor;
            cell.onclick = () => selectLesson(lesson.id);
            cell.style.cursor = 'pointer';
        }
    });
}

function updateLessonsDisplay(lessons, date) {
    // Обновляем заголовок
    updateDateDisplay(date);
    
    // Находим вторую таблицу (уроки сегодня)
    const todayTable = document.querySelectorAll('div[style*="grid-template-columns"] table')[1];
    const todayRows = todayTable.querySelectorAll('tr');
    const todayFirstRowCells = todayRows[0].querySelectorAll('td:not(:first-child)'); // первая строка, кроме заголовка
    const todaySecondRowCells = todayRows[1].querySelectorAll('td'); // вторая строка, все ячейки
    const allTodayCells = [...todayFirstRowCells, ...todaySecondRowCells];
    
    // Скрываем вторую строку по умолчанию
    const todayRow2 = document.getElementById('today_row_2');
    todayRow2.style.display = 'none';
    
    // Очищаем все ячейки
    allTodayCells.forEach(cell => {
        cell.innerHTML = '<div style="text-align: center; color: var(--text-muted); font-style: italic;">Нет урока</div>';
        cell.style.background = 'var(--bg-card)';
        cell.style.borderLeftColor = 'var(--border-secondary)';
        cell.onclick = null;
    });
    
    // Показываем вторую строку если уроков больше 6
    if (lessons.length > 6) {
        todayRow2.style.display = 'table-row';
    }
    
    // Заполняем реальными уроками (максимум 12)
    lessons.slice(0, 12).forEach((lesson, index) => {
        const cell = allTodayCells[index];
        if (cell) {
            const statusInfo = getLessonStatusInfo(lesson);
            
            cell.innerHTML = `
                <div style="background: var(--accent-gradient); color: white; padding: 8px 12px; border-radius: 6px; 
                           font-size: 16px; font-weight: bold; margin-bottom: 10px; text-align: center; min-width: 70px;">
                    ${lesson.time}
                </div>
                <div style="font-weight: bold; margin-bottom: 6px; font-size: 16px;">${lesson.student}</div>
                <div style="font-size: 14px; margin-bottom: 6px;">${lesson.subject}</div>
                <div style="font-size: 12px; color: ${statusInfo.color}; font-weight: bold;">${statusInfo.text}</div>
            `;
            
            cell.style.background = statusInfo.background;
            cell.style.borderLeftColor = statusInfo.borderColor;
            cell.onclick = () => selectLesson(lesson.id);
            cell.style.cursor = 'pointer';
        }
    });
}

function getLessonStatusInfo(lesson) {
    if (lesson.status === 'scheduled') {
        // Синий для запланированных (во всех режимах)
        return {
            color: '#0ea5e9',
            text: 'Запланирован',
            background: 'linear-gradient(135deg, rgba(14, 165, 233, 0.15), rgba(2, 132, 199, 0.15))',
            borderColor: '#0ea5e9'
        };
    }
    
    if (lesson.status === 'completed') {
        if (currentMode === 'report') {
            // РЕЖИМ ОТЧЕТОВ
            if (lesson.has_report) {
                // Зеленый - отчет есть
                return {
                    color: '#10b981',
                    text: 'Отчет готов',
                    background: 'linear-gradient(135deg, rgba(16, 185, 129, 0.15), rgba(5, 150, 105, 0.15))',
                    borderColor: '#10b981'
                };
            } else {
                // Красный - отчета нет
                return {
                    color: '#ef4444',
                    text: 'Нет отчета',
                    background: 'linear-gradient(135deg, rgba(239, 68, 68, 0.15), rgba(220, 38, 38, 0.15))',
                    borderColor: '#ef4444'
                };
            }
        } else {
            // РЕЖИМ ДОМАШЕК
            if (!lesson.has_homework) {
                // Красный - домашки нет
                return {
                    color: '#ef4444',
                    text: 'Нет домашки',
                    background: 'linear-gradient(135deg, rgba(239, 68, 68, 0.15), rgba(220, 38, 38, 0.15))',
                    borderColor: '#ef4444'
                };
            } else if (lesson.homework_type === 'none') {
                // Зеленый - выбрано "не задавать"
                return {
                    color: '#10b981',
                    text: 'Не задавать',
                    background: 'linear-gradient(135deg, rgba(16, 185, 129, 0.15), rgba(5, 150, 105, 0.15))',
                    borderColor: '#10b981'
                };
            } else if (lesson.homework_checked) {
                // Зеленый - домашка проверена
                return {
                    color: '#10b981',
                    text: 'Проверена',
                    background: 'linear-gradient(135deg, rgba(16, 185, 129, 0.15), rgba(5, 150, 105, 0.15))',
                    borderColor: '#10b981'
                };
            } else {
                // Оранжевый - домашка не проверена
                return {
                    color: '#f97316',
                    text: 'Не проверена',
                    background: 'linear-gradient(135deg, rgba(249, 115, 22, 0.15), rgba(234, 88, 12, 0.15))',
                    borderColor: '#f97316'
                };
            }
        }
    }
    
    // Серый для отмененных
    return {
        color: '#6b7280',
        text: '⏸️ Отменен',
        background: 'linear-gradient(135deg, rgba(107, 114, 128, 0.15), rgba(75, 85, 99, 0.15))',
        borderColor: '#6b7280'
    };
}

function selectLesson(lessonId) {
    selectedLesson = lessonId;
    
    // Убираем выделение со всех уроков
    document.querySelectorAll('[onclick*="selectLesson"]').forEach(lesson => {
        lesson.style.boxShadow = '';
        lesson.style.transform = '';
        lesson.style.filter = '';
    });
    
    // Выделяем выбранный урок (мягкое свечение)
    event.currentTarget.style.boxShadow = '0 0 20px rgba(0, 212, 255, 0.6)';
    event.currentTarget.style.transform = 'scale(1.02)';
    event.currentTarget.style.filter = 'brightness(1.1)';
    
    // Показываем формы
    document.getElementById('lesson_forms').style.display = 'block';
    
    // Получаем данные урока из DOM элемента
    const lessonElement = event.currentTarget;
    const timeElement = lessonElement.querySelector('div:first-child');
    const studentElement = lessonElement.querySelector('div:nth-child(2)');
    const subjectElement = lessonElement.querySelector('div:nth-child(3)');
    
    if (timeElement && studentElement && subjectElement) {
        const time = timeElement.textContent.trim();
        const student = studentElement.textContent.trim();
        const subject = subjectElement.textContent.trim();
        
        // Получаем дату из таблицы
        const today = new Date();
        const dateStr = today.toLocaleDateString('ru-RU');
        
        document.getElementById('selected_lesson_info').innerHTML = 
            `Работаем с уроком: ${student} - ${subject} (${time}, ${dateStr})`;
    } else {
        document.getElementById('selected_lesson_info').innerHTML = 
            `Работаем с уроком ID: ${lessonId}`;
    }

    // Обновляем видимость форм согласно текущему режиму
    updateFormsVisibility();
}

// Функция переключения полей домашки
function toggleHomeworkFields() {
    const homeworkType = document.getElementById('homework_type').value;
    const contentFields = document.getElementById('homework_content_fields');
    const probnikFields = document.getElementById('homework_probnik_fields');
    const evaluationFields = document.getElementById('homework_evaluation_fields');
    const formattingFields = document.getElementById('homework_formatting_fields');
    
    if (homeworkType === 'tasks') {
        // Показываем все поля для "дать задачи"
        contentFields.style.display = 'block';
        probnikFields.style.display = 'grid';
        evaluationFields.style.display = 'block';
        formattingFields.style.display = 'block';
    } else {
        // Скрываем все поля
        contentFields.style.display = 'none';
        probnikFields.style.display = 'none';
        evaluationFields.style.display = 'none';
        formattingFields.style.display = 'none';
    }
}

// Инициализация при загрузке страницы
document.addEventListener('DOMContentLoaded', function() {
    
    // НОВЫЙ КОД - генерируем правильные даты для выпадающего списка
    const dateSelect = document.getElementById('date_select');
    const todayForSelect = new Date();
    
    // Очищаем старые опции
    dateSelect.innerHTML = '';
    
    // Создаем 5 дней назад от сегодня
    for (let i = 0; i < 5; i++) {
        const date = new Date(todayForSelect);
        date.setDate(todayForSelect.getDate() - i);
        
        const dateStr = date.toISOString().split('T')[0]; // YYYY-MM-DD
        const displayDate = date.toLocaleDateString('ru-RU'); // DD.MM.YYYY
        const dayName = date.toLocaleDateString('ru-RU', { weekday: 'long' }); // понедельник, вторник...
        
        const option = document.createElement('option');
        option.value = dateStr;
        
        if (i === 0) {
            option.text = `Сегодня (${displayDate})`;
        } else if (i === 1) {
            option.text = `Вчера (${displayDate})`;
        } else {
            option.text = `${displayDate} (${dayName})`;
        }
        
        dateSelect.appendChild(option);
    }
    
    dateSelect.addEventListener('change', function() {
        const selectedDate = this.value;
        console.log('Выбрана дата:', selectedDate);
        
        // Загружаем уроки для выбранной даты
        loadLessonsForDate(selectedDate);
        
        // Загружаем уроки вчера (на день раньше выбранной даты)
        const selectedDateObj = new Date(selectedDate);
        selectedDateObj.setDate(selectedDateObj.getDate() - 1);
        const yesterdayStr = selectedDateObj.toISOString().split('T')[0];
        loadYesterdayLessons(yesterdayStr);
    });
    
    // Инициализируем цвета уроков согласно текущему режиму
    updateLessonsColors();
    
    // Устанавливаем начальную видимость форм
    updateFormsVisibility();

    // Инициализируем счетчики
    updateCounters();

    // Загружаем уроки для РЕАЛЬНЫХ дат
    const today = new Date();
    const yesterday = new Date(today);
    yesterday.setDate(today.getDate() - 1);

    const todayStr = today.toISOString().split('T')[0]; // формат YYYY-MM-DD
    const yesterdayStr = yesterday.toISOString().split('T')[0];

    console.log('Сегодня:', todayStr, 'Вчера:', yesterdayStr);

    // Обновляем статичные даты в заголовках
    updateStaticDates();

    loadLessonsForDate(todayStr);
    loadYesterdayLessons(yesterdayStr);
});

// Функция для открытия модального окна пробника
function openProbnikModal(type) {
    const modalTitle = type === 'report' ? 'Пробник для отчета' : 'Пробник для домашки';
    
    // Создаем модальное окно
    const modal = document.createElement('div');
    modal.style.cssText = `
        position: fixed;
        top: 0;
        left: 0;
        width: 100%;
        height: 100%;
        background: rgba(0, 0, 0, 0.8);
        display: flex;
        justify-content: center;
        align-items: center;
        z-index: 9999;
    `;
    
    modal.innerHTML = `
        <div style="background: var(--bg-secondary); border-radius: 20px; padding: 30px; max-width: 600px; width: 90%; border: 1px solid var(--border-primary);">
            <h3 style="color: var(--text-accent); margin-bottom: 20px; text-align: center;">${modalTitle}</h3>
            
            <div style="background: var(--bg-card); padding: 20px; border-radius: 12px; margin-bottom: 20px;">
                <h4 style="color: var(--text-primary); margin-bottom: 15px;">🚀 Будущая функция:</h4>
                <ul style="color: var(--text-muted); line-height: 1.6;">
                    <li>✅ Список всех заданий пробника с галочками</li>
                    <li>✅ Автоматический подсчет первичных баллов</li>
                    <li>✅ Перевод в баллы ЕГЭ/ОГЭ (вторичные)</li>
                    <li>✅ Разные структуры для математики, физики, химии</li>
                    <li>✅ Интеграция с диаграммами прогресса</li>
                </ul>
                
                <p style="margin-top: 15px; font-style: italic; color: var(--text-accent);">
                    Пример: Задание 1 ✅ (1 балл), Задание 2 ❌ (1 балл)... → Итого: 15/31 → 68 баллов ЕГЭ
                </p>
            </div>
            
            <div style="text-align: center;">
                <button onclick="this.closest('[style*=\"position: fixed\"]').remove()" 
                        style="background: var(--accent-gradient); color: white; padding: 12px 24px; border: none; border-radius: 12px; cursor: pointer;">
                    Понятно, потом доделаем!
                </button>
            </div>
        </div>
    `;
    
    // Закрытие по клику на фон
    modal.addEventListener('click', function(e) {
        if (e.target === modal) {
            modal.remove();
        }
    });
    
    document.body.appendChild(modal);
}

function saveReport() {
    if (!selectedLesson) {
        alert('Сначала выберите урок!');
        return;
    }
    
    // Собираем данные формы
    const reportData = {
        lesson_id: selectedLesson,
        topic: document.querySelector('.report-form input[placeholder*="Квадратные"]').value,
        understanding_level: document.querySelector('.report-form select').value,
        teacher_comment: document.querySelector('.report-form textarea').value,
        primary_score: document.querySelector('.report-form input[placeholder="0-50"]').value,
        secondary_score: document.querySelector('.report-form input[placeholder="0-100"]').value
    };
    
    // Проверяем обязательные поля
    if (!reportData.topic.trim()) {
        alert('Пожалуйста, укажите тему урока');
        return;
    }
    
    // Отправляем AJAX запрос
    fetch('/api/save-report', {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json',
        },
        body: JSON.stringify(reportData)
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            alert('✅ Отчет успешно сохранен!');
            
            // Очищаем форму
            document.querySelector('.report-form input[placeholder*="Квадратные"]').value = '';
            document.querySelector('.report-form select').value = '';
            document.querySelector('.report-form textarea').value = '';
            document.querySelector('.report-form input[placeholder="0-50"]').value = '';
            document.querySelector('.report-form input[placeholder="0-100"]').value = '';
        } else {
            alert('❌ Ошибка: ' + data.error);
        }
    })
    .catch(error => {
        console.error('Ошибка:', error);
        alert('❌ Ошибка сохранения отчета');
    });
}

function saveHomework() {
    if (!selectedLesson) {
        alert('Сначала выберите урок!');
        return;
    }
    
    // Собираем данные формы домашки
    const homeworkData = {
        lesson_id: selectedLesson,
        homework_type: document.getElementById('homework_type').value,
        description: document.querySelector('.homework-form textarea').value,
        primary_score: document.querySelector('.homework-form input[placeholder="0-50"]').value,
        secondary_score: document.querySelector('.homework-form input[placeholder="0-100"]').value,
        solution_score: document.querySelector('#homework_evaluation_fields select').value,
        formatting_score: document.querySelector('#homework_formatting_fields select').value
    };
    
    // Проверяем обязательные поля
    if (!homeworkData.homework_type) {
        alert('Пожалуйста, выберите тип домашнего задания');
        return;
    }
    
    // Отправляем AJAX запрос
    fetch('/api/save-homework', {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json',
        },
        body: JSON.stringify(homeworkData)
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            alert('✅ Домашнее задание успешно сохранено!');
            
            // Очищаем форму
            document.getElementById('homework_type').value = '';
            document.querySelector('.homework-form textarea').value = '';
            document.querySelector('.homework-form input[placeholder="0-50"]').value = '';
            document.querySelector('.homework-form input[placeholder="0-100"]').value = '';
            document.querySelector('#homework_evaluation_fields select').value = '';
            document.querySelector('#homework_formatting_fields select').value = '';
            
            // Скрываем поля
            toggleHomeworkFields();
        } else {
            alert('❌ Ошибка: ' + data.error);
        }
    })
    .catch(error => {
        console.error('Ошибка:', error);
        alert('❌ Ошибка сохранения домашнего задания');
    });
}

function deleteReport() {
    if (!selectedLesson) {
        alert('Сначала выберите урок!');
        return;
    }
    
    // Подтверждение удаления
    if (!confirm('Вы уверены что хотите удалить отчет по этому уроку?')) {
        return;
    }
    
    // Отправляем AJAX запрос на удаление
    fetch('/api/delete-report', {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json',
        },
        body: JSON.stringify({lesson_id: selectedLesson})
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            alert('✅ Отчет успешно удален!');
            
            // Очищаем форму
            document.querySelector('.report-form input[placeholder*="Квадратные"]').value = '';
            document.querySelector('.report-form select').value = '';
            document.querySelector('.report-form textarea').value = '';
            document.querySelector('.report-form input[placeholder="0-50"]').value = '';
            document.querySelector('.report-form input[placeholder="0-100"]').value = '';
            
            // Обновляем отображение урока (убираем галочку)
            updateLessonsColors();
        } else {
            alert('❌ Ошибка: ' + data.error);
        }
    })
    .catch(error => {
        console.error('Ошибка:', error);
        alert('❌ Ошибка удаления отчета');
    });
}

function markHomeworkChecked() {
    if (!selectedLesson) {
        alert('Сначала выберите урок!');
        return;
    }
    
    // Отправляем AJAX запрос
    fetch('/api/mark-homework-checked', {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json',
        },
        body: JSON.stringify({lesson_id: selectedLesson})
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            alert('✅ Домашнее задание отмечено как проверенное!');
            
            // Обновляем отображение урока
            updateLessonsColors();
        } else {
            alert('❌ Ошибка: ' + data.error);
        }
    })
    .catch(error => {
        console.error('Ошибка:', error);
        alert('❌ Ошибка отметки домашки');
    });
}

function deleteHomework() {
    if (!selectedLesson) {
        alert('Сначала выберите урок!');
        return;
    }
    
    // Подтверждение удаления
    if (!confirm('Вы уверены что хотите удалить домашнее задание по этому уроку?')) {
        return;
    }
    
    // Отправляем AJAX запрос на удаление
    fetch('/api/delete-homework', {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json',
        },
        body: JSON.stringify({lesson_id: selectedLesson})
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            alert('✅ Домашнее задание успешно удалено!');
            
            // Очищаем форму
            document.getElementById('homework_type').value = '';
            document.querySelector('.homework-form textarea').value = '';
            document.querySelector('.homework-form input[placeholder="0-50"]').value = '';
            document.querySelector('.homework-form input[placeholder="0-100"]').value = '';
            document.querySelector('#homework_evaluation_fields select').value = '';
            document.querySelector('#homework_formatting_fields select').value = '';
            
            // Скрываем поля
            toggleHomeworkFields();
            
            // Обновляем отображение урока
            updateLessonsColors();
        } else {
            alert('❌ Ошибка: ' + data.error);
        }
    })
    .catch(error => {
        console.error('Ошибка:', error);
        alert('❌ Ошибка удаления домашки');
    });
}

</script>

{% endblock %}