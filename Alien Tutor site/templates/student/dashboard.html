{% extends "base.html" %}

{% block title %}Личный кабинет ученика - Alien Tutor{% endblock %}

{% block styles %}

{% endblock %}

{% block content %}
    <div class="dashboard-container">
        <!-- Заголовок страницы -->
        <div class="dashboard-header">
            <h1>Личный кабинет ученика</h1>
            <p class="welcome-text">Добро пожаловать, {{ student.name }}! Класс: {{ student.class }}</p>
        </div>

        <!-- Навигация по вкладкам -->
        <div class="tabs-navigation">
            <button class="tab-button active" data-tab="schedule">
                <span class="tab-text">Расписание</span>
            </button>
            <button class="tab-button" data-tab="progress">
                <span class="tab-text">Успеваемость</span>
            </button>
            <button class="tab-button" data-tab="game">
                <span class="tab-text">Игра</span>
            </button>
        </div>

        <!-- Контент вкладок -->
        <div class="tabs-content">

            <!-- Вкладка: Расписание -->
            <div class="tab-content active" id="schedule-tab">
                <!-- Футуристичная панель быстрых действий -->
                <div class="futuristic-panel">
                    <div class="panel-icon-left">
                        <div class="icon-circle">
                            <svg class="action-icon" viewBox="0 0 24 24" fill="none" stroke="currentColor">
                                <path d="M17 21v-2a4 4 0 0 0-4-4H5a4 4 0 0 0-4 4v2"></path>
                                <circle cx="9" cy="7" r="4"></circle>
                                <path d="M23 21v-2a4 4 0 0 0-3-3.87"></path>
                                <path d="M16 3.13a4 4 0 0 1 0 7.75"></path>
                            </svg>
                        </div>
                        <div class="icon-tooltip tooltip-right">Подключиться к уроку</div>
                    </div>
                    
                    <div class="connecting-line-left"></div>
                    
                    <div class="central-panel">
                        <span>Быстрые действия</span>
                    </div>
                    
                    <div class="connecting-line-right"></div>
                    
                    <div class="panel-icon-right">
                        <div class="icon-circle">
                            <svg class="action-icon" viewBox="0 0 24 24" fill="none" stroke="currentColor">
                                <rect x="3" y="4" width="18" height="12" rx="1" ry="1"></rect>
                                <line x1="7" y1="8" x2="17" y2="8"></line>
                                <line x1="7" y1="12" x2="13" y2="12"></line>
                                <path d="M8 21l-2-5h12l-2 5"></path>
                            </svg>
                        </div>
                        <div class="icon-tooltip tooltip-left">Интерактивная доска</div>
                    </div>
                </div>
                
                <!-- Статистика ученика -->
                <div class="student-stats">
                    <!-- Первая карточка -->
                    <div class="stats-card">
                        <div class="stats-value">{{ student.planned_lessons }}</div>
                        <div class="stats-label">Запланировано в месяце</div>
                    </div>
                    <div class="stats-card">
                        <div class="stats-value">{{ student.cancelled_lessons }}</div>
                        <div class="stats-label">Отменено уроков</div>
                    </div>
                    <div class="stats-card">
                        <div class="stats-value">{{ student.lessons_in_stock }}</div>
                        <div class="stats-label">Запас уроков</div>
                    </div>
                    <div class="stats-card">
                        <div class="stats-value">{{ student.completed_lessons }}</div>
                        <div class="stats-label">Проведено уроков</div>
                    </div>
                </div>

                <!-- Календарь с навигацией -->
                <div class="schedule-container">
                    <h2>Расписание занятий</h2>
                    
                    <!-- Навигация и переключатель -->
                    <div class="schedule-controls">
                        <button class="nav-btn">← Назад</button>
                        
                        <div class="schedule-info">
                            <span class="current-period">{{ student.schedule.week_info.title }}</span>
                            <div class="view-toggle">
                                <button class="toggle-btn active">Неделя</button>
                                <button class="toggle-btn">Месяц</button>
                            </div>
                        </div>
                        
                        <button class="nav-btn">Вперед →</button>
                    </div>

                    <!-- Календарная сетка -->
                    <div class="schedule-grid">
                        {% for day in student.schedule.week_data %}
                        <div class="day-column {% if day.is_today %}today{% endif %}">
                            <div class="day-header">
                                <div class="day-name">{{ day.day_name }}</div>
                                <div class="day-date">{{ day.day_number }}</div>
                                {% if day.is_today %}
                                    <div class="today-badge">Сегодня</div>
                                {% endif %}
                            </div>
                            <div class="lessons-list">
                                {% if day.lessons %}
                                    {% for lesson in day.lessons %}
                                    <div class="lesson-item-placeholder">
                                        <div class="lesson-time">{{ lesson.time }}</div>
                                        <div class="lesson-subject">{{ lesson.subject }}</div>
                                        {% if lesson.status == 'cancelled' %}
                                            <div class="lesson-status">Отменен</div>
                                        {% endif %}
                                    </div>
                                    {% endfor %}
                                {% else %}
                                    <div class="lesson-placeholder">Нет занятий</div>
                                {% endif %}
                            </div>
                        </div>
                        {% endfor %}
                    </div>
                </div>
            </div>

            <!-- Вкладка: Успеваемость -->
            <div class="tab-content" id="progress-tab">
                <!-- Выбор класса (для демо) -->
                <div class="class-selector">
                    <h2>Успеваемость</h2>
                    <div class="class-buttons">
                        <button class="class-btn active" data-class="9">9 класс</button>
                        <button class="class-btn" data-class="11">11 класс</button>
                        <button class="class-btn" data-class="8">8 класс</button>
                        <button class="class-btn" data-class="7">7 класс</button>
                    </div>
                </div>

                <!-- Диаграммы -->
                <div class="charts-container">
                    <!-- Столбчатая диаграмма (только 9-11 классы) -->
                    <div class="chart-section bar-chart-section">
                        <h3>Баллы за пробники ОГЭ/ЕГЭ</h3>
                        <div class="chart-wrapper">
                            <div class="bar-chart" id="barChart">
                                <!-- Будет заполнено JavaScript -->
                            </div>
                        </div>
                    </div>

                    <!-- Круговая диаграмма (все классы) -->
                    <div class="chart-section pie-chart-section">
                        <h3>Понимание тем</h3>
                        <div class="chart-wrapper">
                            <div class="pie-chart" id="pieChart">
                                <svg viewBox="0 0 200 200" width="200" height="200">
                                    <!-- Круг будет отрисован JavaScript -->
                                </svg>
                                <div class="pie-legend">
                                    <div class="legend-item">
                                        <span class="legend-color" style="background: #10b981;"></span>
                                        <span>Тема разобрана полностью</span>
                                    </div>
                                    <div class="legend-item">
                                        <span class="legend-color" style="background: #f59e0b;"></span>
                                        <span>Есть вопросы по теме</span>
                                    </div>
                                    <div class="legend-item">
                                        <span class="legend-color" style="background: #ef4444;"></span>
                                        <span>Тему нужно закрепить</span>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Таблица уроков -->
                <div class="lessons-table-section">
                    <h3>История проведенных уроков</h3>
                    <div class="table-wrapper">
                        <table class="lessons-table">
                            <thead>
                                <tr>
                                    <th>Дата урока</th>
                                    <th>Пройденная тема</th>
                                    <th>Краткий вывод</th>
                                    <th class="score-column">Баллы за пробник</th>
                                    <th>Развернутый вывод</th>
                                </tr>
                            </thead>
                            <tbody id="lessonsTableBody">
                                {% if student.lesson_reports %}
                                    {% for lesson in student.lesson_reports %}
                                    <tr>
                                        <td>{{ lesson.date }}</td>
                                        <td>{{ lesson.topic }}</td>
                                        <td>{{ lesson.understanding }}</td>
                                        <td class="score-cell">{{ lesson.score }}</td>
                                        <td>{{ lesson.feedback }}</td>
                                    </tr>
                                    {% endfor %}
                                {% else %}
                                    <tr>
                                        <td colspan="5" style="text-align: center; color: var(--text-muted); font-style: italic;">
                                            Нет данных об уроках
                                        </td>
                                    </tr>
                                {% endif %}
                            </tbody>
                        </table>
                    </div>
                </div>
                <!-- Новая таблица домашних заданий -->
                <div class="homework-table-section">
                    <h3>История домашних заданий</h3>
                    <div class="table-wrapper">
                        <table class="lessons-table homework-table">
                            <thead id="homeworkTableHeader">
                                <tr>
                                    <th>Дата задания</th>
                                    <th>Описание</th>
                                    <th>Статус</th>
                                    <th>Оценка</th>
                                </tr>
                            </thead>
                            <tbody id="homeworkTableBody">
                                {% if student.homework_data %}
                                    {% for hw in student.homework_data %}
                                    <tr>
                                        <td>{{ hw.date }}</td>
                                        <td>{{ hw.description }}</td>
                                        <td>{{ hw.status }}</td>
                                        <td>{{ hw.score }}</td>
                                    </tr>
                                    {% endfor %}
                                {% else %}
                                    <tr>
                                        <td colspan="4" style="text-align: center; color: var(--text-muted); font-style: italic;">
                                            Нет данных о домашних заданиях
                                        </td>
                                    </tr>
                                {% endif %}
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>

            <!-- Вкладка: Игра -->
            <div class="tab-content" id="game-tab">
                <div class="content-section">
                    <h2>🎮 Космический лабиринт</h2>
                    
                    <div style="text-align: center; margin: 2rem 0;">
                        <a href="/game" target="_blank" class="glass-button game-launch-btn" style="display: inline-block; max-width: 300px; text-decoration: none;">
                            <div class="button-title">🚀 Запустить игру</div>
                            <div class="button-subtitle">Начать космическое приключение</div>
                        </a>
                    </div>
                </div>
                
                <div class="content-section">
                    <h2>🏆 Твой рейтинг</h2>
                    <div class="rating-placeholder">
                        <p>Здесь будет отображаться:</p>
                        <ul>
                            <li>Твоя позиция в общем рейтинге</li>
                            <li>Количество очков за игру</li>
                            <li>Достижения и значки</li>
                            <li>Прогресс по решенным задачам</li>
                        </ul>
                    </div>
                </div>
            </div>
        </div>
    </div>
{% endblock %}

{% block scripts %}
<script>
// Данные из Python
const examResults = {{ student.exam_results | tojson | safe }};
const topicProgress = {{ student.topic_progress | tojson | safe }};
const currentClass = {{ student.class | tojson | safe }};

// Переменные для отслеживания состояния
let currentSelectedClass = '9';

// Функция для отрисовки столбчатой диаграммы
function renderBarChart() {
    const barChart = document.getElementById('barChart');
    barChart.innerHTML = '';
    
    if (!examResults || examResults.length === 0) {
        barChart.innerHTML = '<div class="no-data">Нет данных о пробниках</div>';
        return;
    }
    
    const maxScore = Math.max(...examResults.map(item => item.score));
    const chartHeight = 200;
    
    examResults.forEach(item => {
        const barHeight = (item.score / maxScore) * chartHeight;
        
        const barContainer = document.createElement('div');
        barContainer.className = 'bar-container';
        barContainer.style.cssText = `
            display: flex;
            flex-direction: column;
            align-items: center;
            margin: 0 5px;
            min-width: 40px;
        `;
        
        const bar = document.createElement('div');
        bar.className = 'bar';
        bar.style.cssText = `
            width: 30px;
            height: ${barHeight}px;
            background: linear-gradient(45deg, #00d4ff, #7c3aed);
            border-radius: 4px 4px 0 0;
            margin-bottom: 5px;
            transition: all 0.3s ease;
            cursor: pointer;
        `;
        
        const scoreLabel = document.createElement('div');
        scoreLabel.textContent = item.score;
        scoreLabel.style.cssText = `
            font-size: 12px;
            font-weight: bold;
            color: var(--text-primary);
            margin-bottom: 5px;
        `;
        
        const dateLabel = document.createElement('div');
        dateLabel.textContent = item.date;
        dateLabel.style.cssText = `
            font-size: 10px;
            color: var(--text-muted);
            transform: rotate(-45deg);
            margin-top: 10px;
        `;
        
        barContainer.appendChild(bar);
        barContainer.appendChild(scoreLabel);
        barContainer.appendChild(dateLabel);
        
        barChart.appendChild(barContainer);
    });
}

// Функция для отрисовки круговой диаграммы
function renderPieChart() {
    const pieChart = document.querySelector('#pieChart svg');
    const total = topicProgress.fully + topicProgress.questions + topicProgress.needWork;
    
    if (total === 0) {
        pieChart.innerHTML = '<text x="100" y="100" text-anchor="middle" fill="var(--text-muted)">Нет данных</text>';
        return;
    }
    
    const colors = {
        fully: '#10b981',
        questions: '#f59e0b', 
        needWork: '#ef4444'
    };
    
    let cumulativePercentage = 0;
    let segments = '';
    
    Object.entries(topicProgress).forEach(([key, value]) => {
        if (value > 0) {
            const percentage = value / total;
            const angle = percentage * 360;
            
            const x1 = 100 + 80 * Math.cos((cumulativePercentage * 360 - 90) * Math.PI / 180);
            const y1 = 100 + 80 * Math.sin((cumulativePercentage * 360 - 90) * Math.PI / 180);
            
            const x2 = 100 + 80 * Math.cos(((cumulativePercentage + percentage) * 360 - 90) * Math.PI / 180);
            const y2 = 100 + 80 * Math.sin(((cumulativePercentage + percentage) * 360 - 90) * Math.PI / 180);
            
            const largeArc = percentage > 0.5 ? 1 : 0;
            
            segments += `
                <path d="M 100 100 L ${x1} ${y1} A 80 80 0 ${largeArc} 1 ${x2} ${y2} Z"
                      fill="${colors[key]}" 
                      stroke="var(--bg-primary)" 
                      stroke-width="2"/>
            `;
            
            cumulativePercentage += percentage;
        }
    });
    
    pieChart.innerHTML = segments;
}

// Обработчики событий для переключения классов
document.addEventListener('DOMContentLoaded', function() {
    // Инициализация диаграмм
    renderBarChart();
    renderPieChart();
    
    // Обработчики для кнопок классов
    document.querySelectorAll('.class-btn').forEach(btn => {
        btn.addEventListener('click', function() {
            // Убираем активный класс у всех кнопок
            document.querySelectorAll('.class-btn').forEach(b => b.classList.remove('active'));
            // Добавляем активный класс к нажатой кнопке
            this.classList.add('active');
            
            currentSelectedClass = this.dataset.class;
            
            // Показываем/скрываем столбчатую диаграмму для 9-11 классов
            const barChartSection = document.querySelector('.bar-chart-section');
            if (currentSelectedClass === '9' || currentSelectedClass === '11') {
                barChartSection.style.display = 'block';
                renderBarChart();
            } else {
                barChartSection.style.display = 'none';
            }
        });
    });
    
    // Скрываем столбчатую диаграмму если не 9-11 класс
    const barChartSection = document.querySelector('.bar-chart-section');
    if (currentSelectedClass !== '9' && currentSelectedClass !== '11') {
        barChartSection.style.display = 'none';
    }
});

// Обработчики для переключения вкладок
document.querySelectorAll('.tab-button').forEach(button => {
    button.addEventListener('click', function() {
        const tabName = this.dataset.tab;
        
        // Убираем активный класс у всех кнопок и контента
        document.querySelectorAll('.tab-button').forEach(btn => btn.classList.remove('active'));
        document.querySelectorAll('.tab-content').forEach(content => content.classList.remove('active'));
        
        // Добавляем активный класс к нажатой кнопке и соответствующему контенту
        this.classList.add('active');
        document.getElementById(tabName + '-tab').classList.add('active');
    });
});
</script>
{% endblock %}