{% extends "base.html" %}

{% block title %}Личный кабинет ученика - Alien Tutor{% endblock %}

{% block styles %}
<style>
.logout-button-nav {
    display: flex !important;
    align-items: center !important;
    justify-content: center !important;
    gap: 8px !important;
    padding: 1rem 2rem !important;
    background: rgba(239, 68, 68, 0.1) !important;
    backdrop-filter: blur(10px) !important;
    color: #ef4444 !important;
    border: 1px solid rgba(239, 68, 68, 0.3) !important;
    border-radius: 15px !important;
    text-decoration: none !important;
    font-weight: 500 !important;
    font-size: 1.1rem !important;
    transition: all 0.4s cubic-bezier(0.4, 0, 0.2, 1) !important;
    margin-left: 0rem !important;
    position: relative !important;
    overflow: hidden !important;
}

.logout-button-nav:hover {
    background: rgba(239, 68, 68, 0.2) !important;
    transform: translateY(-2px) !important;
}
</style>
{% endblock %}
{% block content %}
    <div class="dashboard-container">
        <!-- Заголовок страницы -->
        <div class="dashboard-header">
            <h1>Личный кабинет ученика</h1>
            <p class="welcome-text">Добро пожаловать, {{ student.name }}! Класс: {{ student.class }}</p>
        </div>

        <!-- Навигация по вкладкам -->
        <div class="tabs-navigation">
            <div class="tabs-group">
                <button class="tab-button active" data-tab="schedule">
                    <span class="tab-text">Расписание</span>
                </button>
                <button class="tab-button" data-tab="progress">
                    <span class="tab-text">Успеваемость</span>
                </button>
                <button class="tab-button" data-tab="game">
                    <span class="tab-text">Игра</span>
                </button>
            </div>
            <a href="/logout" class="logout-button-nav" title="Выйти из аккаунта">
                <span>Выйти</span>
            </a>
        </div>

        <!-- Контент вкладок -->
        <div class="tabs-content">

            <!-- Вкладка: Расписание -->
            <div class="tab-content active" id="schedule-tab">
                <!-- Футуристичная панель быстрых действий -->
                <div class="futuristic-panel">
                    <div class="panel-icon-left">
                        <div class="icon-circle">
                            <svg class="action-icon" viewBox="0 0 24 24" fill="none" stroke="currentColor">
                                <path d="M17 21v-2a4 4 0 0 0-4-4H5a4 4 0 0 0-4 4v2"></path>
                                <circle cx="9" cy="7" r="4"></circle>
                                <path d="M23 21v-2a4 4 0 0 0-3-3.87"></path>
                                <path d="M16 3.13a4 4 0 0 1 0 7.75"></path>
                            </svg>
                        </div>
                        <div class="icon-tooltip tooltip-right">Подключиться к уроку</div>
                    </div>
                    
                    <div class="connecting-line-left"></div>
                    
                    <div class="central-panel">
                        <span>Быстрые действия</span>
                    </div>
                    
                    <div class="connecting-line-right"></div>
                    
                    <div class="panel-icon-right">
                        <div class="icon-circle">
                            <svg class="action-icon" viewBox="0 0 24 24" fill="none" stroke="currentColor">
                                <rect x="3" y="4" width="18" height="12" rx="1" ry="1"></rect>
                                <line x1="7" y1="8" x2="17" y2="8"></line>
                                <line x1="7" y1="12" x2="13" y2="12"></line>
                                <path d="M8 21l-2-5h12l-2 5"></path>
                            </svg>
                        </div>
                        <div class="icon-tooltip tooltip-left">Интерактивная доска</div>
                    </div>
                </div>
                
                <!-- Статистика ученика -->
                <div class="student-stats">
                    <!-- Первая карточка -->
                    <div class="stats-card">
                        <div class="stats-value">{{ student.planned_lessons }}</div>
                        <div class="stats-label">Запланировано в месяце</div>
                    </div>
                    <div class="stats-card">
                        <div class="stats-value">{{ student.cancelled_lessons }}</div>
                        <div class="stats-label">Отменено уроков</div>
                    </div>
                    <div class="stats-card">
                        <div class="stats-value">{{ student.lessons_in_stock }}</div>
                        <div class="stats-label">Запас уроков</div>
                    </div>
                    <div class="stats-card">
                        <div class="stats-value">{{ student.completed_lessons }}</div>
                        <div class="stats-label">Проведено уроков</div>
                    </div>
                </div>

                <!-- Календарь с навигацией -->
                <div class="schedule-container">
                    <h2>Расписание занятий</h2>
                    
                    <!-- Навигация и переключатель -->
                    <div class="schedule-controls">
                        <button class="nav-btn" id="prevWeekBtn">← Назад</button>
                        
                        <div class="schedule-info">
                            <span class="current-period" id="currentPeriod">{{ student.schedule.week_info.title }}</span>
                            <div class="view-toggle">
                                <button class="toggle-btn active">Неделя</button>
                                <button class="toggle-btn">Месяц</button>
                            </div>
                        </div>
                        
                        <button class="nav-btn" id="nextWeekBtn">Вперед →</button>
                    </div>

                    <!-- Календарная сетка -->
                    <div class="schedule-grid">
                        {% for day in student.schedule.week_data %}
                        <div class="day-column {% if day.is_today %}today{% endif %}">
                            <div class="day-header">
                                <div class="day-name">{{ day.day_name }}</div>
                                <div class="day-date">{{ day.day_number }}</div>
                                {% if day.is_today %}
                                    <div class="today-badge">Сегодня</div>
                                {% endif %}
                            </div>
                            <div class="lessons-list">
                                {% if day.lessons %}
                                    {% for lesson in day.lessons %}
                                    <div class="lesson-item-placeholder">
                                        <div class="lesson-time">{{ lesson.time }}</div>
                                        <div class="lesson-subject">{{ lesson.subject }}</div>
                                        {% if lesson.status == 'cancelled' %}
                                            <div class="lesson-status">Отменен</div>
                                        {% endif %}
                                    </div>
                                    {% endfor %}
                                {% else %}
                                    <div class="lesson-placeholder">Нет занятий</div>
                                {% endif %}
                            </div>
                        </div>
                        {% endfor %}
                    </div>
                </div>
                <!-- МЕСЯЧНЫЙ КАЛЕНДАРЬ (скрыт по умолчанию) -->
                <div class="month-calendar" id="monthCalendar">

                    <!-- Сетка календаря 7x6 -->
                    <div class="month-grid" id="monthGrid">
                        <!-- Заголовки дней недели -->
                        <div class="month-day-header">Пн</div>
                        <div class="month-day-header">Вт</div>
                        <div class="month-day-header">Ср</div>
                        <div class="month-day-header">Чт</div>
                        <div class="month-day-header">Пт</div>
                        <div class="month-day-header">Сб</div>
                        <div class="month-day-header">Вс</div>

                        <!-- Ячейки дней будут добавлены JavaScript -->
                    </div>
                </div>
            </div>

            <!-- Вкладка: Успеваемость -->
            <div class="tab-content" id="progress-tab">
                <!-- Заголовок успеваемости -->
                <div class="class-selector">
                    <h2>Успеваемость</h2>
                </div>

                <!-- Диаграммы -->
                <div class="charts-container">
                    <!-- Столбчатая диаграмма (только 9-11 классы) -->
                    <div class="chart-section bar-chart-section">
                        <h3 id="barChartTitle">Баллы за пробники ОГЭ/ЕГЭ</h3>
                        <div class="chart-wrapper">
                            <div class="bar-chart" id="barChart">
                                <!-- Будет заполнено JavaScript -->
                            </div>
                        </div>
                    </div>

                    <!-- Круговая диаграмма (все классы) -->
                    <div class="chart-section pie-chart-section">
                        <h3>Понимание тем</h3>
                        <div class="chart-wrapper">
                            <div class="pie-chart" id="pieChart">
                                <svg viewBox="0 0 200 200" width="200" height="200">
                                    <!-- Круг будет отрисован JavaScript -->
                                </svg>
                                <div class="pie-legend">
                                    <div class="legend-item">
                                        <span class="legend-color" style="background: #10b981;"></span>
                                        <span>Тема разобрана полностью</span>
                                    </div>
                                    <div class="legend-item">
                                        <span class="legend-color" style="background: #f59e0b;"></span>
                                        <span>Есть вопросы по теме</span>
                                    </div>
                                    <div class="legend-item">
                                        <span class="legend-color" style="background: #ef4444;"></span>
                                        <span>Тему нужно закрепить</span>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Таблица уроков -->
                <div class="lessons-table-section">
                    <h3>История проведенных уроков</h3>
                    <div class="table-wrapper">
                        <table class="lessons-table">
                            <thead>
                                <tr>
                                    <th>Дата урока</th>
                                    <th>Пройденная тема</th>
                                    <th>Краткий вывод</th>
                                    <th class="score-column">Баллы за пробник</th>
                                    <th>Развернутый вывод</th>
                                </tr>
                            </thead>
                            <tbody id="lessonsTableBody">
                                {% if student.lesson_reports %}
                                    {% for lesson in student.lesson_reports %}
                                    <tr>
                                        <td>{{ lesson.date }}</td>
                                        <td>{{ lesson.topic }}</td>
                                        <td>{{ lesson.understanding }}</td>
                                        <td class="score-cell">{{ lesson.score }}</td>
                                        <td>{{ lesson.feedback }}</td>
                                    </tr>
                                    {% endfor %}
                                {% else %}
                                    <tr>
                                        <td colspan="5" style="text-align: center; color: var(--text-muted); font-style: italic;">
                                            Нет данных об уроках
                                        </td>
                                    </tr>
                                {% endif %}
                            </tbody>
                        </table>
                    </div>
                </div>
                <!-- Новая таблица домашних заданий -->
                <div class="homework-table-section">
                    <h3>История домашних заданий</h3>
                    <div class="table-wrapper">
                        <table class="lessons-table homework-table">
                            <thead id="homeworkTableHeader">
                                <tr>
                                    <th>Дата задания</th>
                                    <th>Описание</th>
                                    <th>Статус</th>
                                    <th>Оценка</th>
                                </tr>
                            </thead>
                            <tbody id="homeworkTableBody">
                                <!-- Таблица будет заполнена JavaScript из функции updateHomeworkTable() -->
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>

            <!-- Вкладка: Игра -->
            <div class="tab-content" id="game-tab">
                <div class="content-section">
                    <h2>🎮 Космический лабиринт</h2>
                    
                    <div style="text-align: center; margin: 2rem 0;">
                        <a href="/game" target="_blank" class="glass-button game-launch-btn" style="display: inline-block; max-width: 300px; text-decoration: none;">
                            <div class="button-title">🚀 Запустить игру</div>
                            <div class="button-subtitle">Начать космическое приключение</div>
                        </a>
                    </div>
                </div>
                
                <div class="content-section">
                    <h2>🏆 Твой рейтинг</h2>
                    <div class="rating-placeholder">
                        <p>Здесь будет отображаться:</p>
                        <ul>
                            <li>Твоя позиция в общем рейтинге</li>
                            <li>Количество очков за игру</li>
                            <li>Достижения и значки</li>
                            <li>Прогресс по решенным задачам</li>
                        </ul>
                    </div>
                </div>
            </div>
        </div>
    </div>
{% endblock %}

{% block scripts %}
<script src="{{ url_for('static', filename='js/dashboard.js') }}"></script>
<script>
// Данные из Python (реальные данные из БД)
const studentHomework = {{ student.homework_data | tojson | safe }};
const studentExamResults = {{ student.exam_results | tojson | safe }};
const studentClass = {{ student.class | tojson | safe }};

// Определяем класс ученика (убираем " класс" из строки)
const currentClass = studentClass.replace(' класс', '');

// Определяем тип диаграммы для класса
const hasExamScores = (currentClass === '9' || currentClass === '11');

// Передаем данные в глобальную область для dashboard.js
window.studentData = {
    homework: studentHomework,
    examResults: studentExamResults,
    studentClass: studentClass,
    currentClass: currentClass,
    hasExamScores: hasExamScores,
    topicProgress: {{ student.topic_progress | tojson | safe }}
};

// Добавь отладочный вывод:
console.log('🔍 ОТЛАДКА: Данные домашек для диаграммы:', studentHomework);

// Запускаем инициализацию после загрузки страницы
document.addEventListener('DOMContentLoaded', function() {
    console.log('Инициализация диаграмм...');
    console.log('Данные домашек:', studentHomework);
    console.log('Данные экзаменов:', studentExamResults);
    console.log('Класс ученика:', currentClass);
    
    initChartsForStudentClass();
});
</script>
{% endblock %}